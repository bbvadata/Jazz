/* Jazz (c) 2018-2023 kaalam.ai (The Authors of Jazz), using (under the same license):

	1. Biomodelling - The AATBlockQueue class (c) Jacques Basaldúa, 2009-2012 licensed
	  exclusively for the use in the Jazz server software.

	  Copyright 2009-2012 Jacques Basaldúa

	2. BBVA - Jazz: A lightweight analytical web server for data-driven applications.

      Copyright 2016-2017 Banco Bilbao Vizcaya Argentaria, S.A.

      This product includes software developed at

      BBVA (https://www.bbva.com/)

	3. LMDB, Copyright 2011-2017 Howard Chu, Symas Corp. All rights reserved.

	  Licensed under http://www.OpenLDAP.org/license.html


	  Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	  http://www.apache.org/licenses/LICENSE-2.0

	  Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/


using namespace jazz_elements;


// Utils
// -----

bool compare_to_tensor(pTransaction &p_txn, pTransaction &p_txo) {
	REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE);

	REQUIRE((p_txo->p_block->cell_type & 0xff) <= 8);

	REQUIRE(p_txn->p_block->size == p_txo->p_block->size*(p_txo->p_block->cell_type & 0xff));

	for (int i = 0; i < p_txn->p_block->size; i++)
		if (p_txn->p_block->tensor.cell_byte[i] != p_txo->p_block->tensor.cell_byte[i])
			return false;

	return true;
}

bool compare_to_block(pTransaction &p_txn, pTransaction &p_txo) {
	REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE);

	REQUIRE(p_txn->p_block->size == p_txo->p_block->total_bytes);

	uint8_t *p_bl = (uint8_t *) p_txo->p_block;

	for (int i = 0; i < p_txn->p_block->size; i++)
		if (p_txn->p_block->tensor.cell_byte[i] != p_bl[i])
			return false;

	return true;
}

// Tests
// -----

SCENARIO("Basics tests") {

	REQUIRE(sizeof(Socket) == 128);

	REQUIRE(TenBitsAtAddress("0-mq") == BASE_0_MQ_10BIT);
	REQUIRE(TenBitsAtAddress("bash") == BASE_BASH_10BIT);
	REQUIRE(TenBitsAtAddress("file") == BASE_FILE_10BIT);
	REQUIRE(TenBitsAtAddress("http") == BASE_HTTP_10BIT);

	char buffer[16] = "abcdefghij12345";
	REQUIRE(strnlen(buffer, 16) == 15);

	buffer[15] = '6';
	REQUIRE(strnlen(buffer, 16) == 16);

	buffer[1] = 0;
	REQUIRE(strnlen(buffer, 16) == 1);

	buffer[0] = 0;
	REQUIRE(strnlen(buffer, 16) == 0);
}


SCENARIO("Testing compose_url()") {

	REQUIRE(CHN.start() == SERVICE_NO_ERROR);

	REQUIRE(CHN.max_transactions > 0);
	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.warn_alloc_bytes > 0);
	REQUIRE(CHN.fail_alloc_bytes > 0);
	REQUIRE(CHN.alloc_warning_issued == false);
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN.p_free	 == CHN.p_buffer);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next == &pStoredTransaction(CHN.p_buffer)[1]);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next->p_next == &pStoredTransaction(CHN.p_buffer)[2]);
	REQUIRE(	pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 2].p_next
			== &pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1]);
	REQUIRE(pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1].p_next == nullptr);
	REQUIRE(CHN._lock_ == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context	!= nullptr);

	GIVEN("We have configured running Channels object.") {
		CHN.jazz_node_name[1] = "One";
		CHN.jazz_node_ip  [1] = "192.168.0.1";
		CHN.jazz_node_port[1] = 8001;

		CHN.jazz_node_name[2] = "Two";
		CHN.jazz_node_ip  [2] = "192.168.0.2";
		CHN.jazz_node_port[2] = 8002;

		CHN.jazz_node_name[3] = "Three";
		CHN.jazz_node_ip  [3] = "192.168.0.3";
		CHN.jazz_node_port[3] = 8003;

		char buff1[4096], buff2[4096], buff3[4096];

		WHEN("We try some buffer limit calls") {
			REQUIRE(!CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 0));
			REQUIRE(!CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 1));
			REQUIRE(!CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 10));

			//123456789012345678901234
			//http://192.168.0.1:8001/
			REQUIRE(!CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 24));
			REQUIRE( CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 25));

			//123456789012345678901234567890123456
			//http://192.168.0.2:8002/h234/6789.ht
			REQUIRE(!CHN.compose_url(buff2, (pChar) "Two", (pChar) "/h234/6789.ht", 36));
			REQUIRE( CHN.compose_url(buff2, (pChar) "Two", (pChar) "/h234/6789.ht", 37));

			//http://192.168.0.3:8003/h234/6789.ht%20
			//123456789012345678901234567890123456789
			REQUIRE(!CHN.compose_url(buff3, (pChar) "Three", (pChar) "/h234/6789.ht ", 37));
			REQUIRE(!CHN.compose_url(buff3, (pChar) "Three", (pChar) "/h234/6789.ht ", 38));
			REQUIRE(!CHN.compose_url(buff3, (pChar) "Three", (pChar) "/h234/6789.ht ", 39));
			REQUIRE( CHN.compose_url(buff3, (pChar) "Three", (pChar) "/h234/6789.ht ", 40));

			THEN("The results are as expected") {
				REQUIRE(strcmp(buff1, "http://192.168.0.1:8001/") == 0);
				REQUIRE(strcmp(buff2, "http://192.168.0.2:8002/h234/6789.ht") == 0);
				REQUIRE(strcmp(buff3, "http://192.168.0.3:8003/h234/6789.ht%20") == 0);
			}
			REQUIRE(CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 25));
			REQUIRE(strcmp(buff1, "http://192.168.0.1:8001/") == 0);
			REQUIRE(buff1[24] == 0);
			buff1[25] = 'w';
			buff1[26] = '?';
			buff1[27] = '^';
			REQUIRE(CHN.compose_url(buff1, (pChar) "Two", (pChar) "/", 25));
			REQUIRE(strcmp(buff1, "http://192.168.0.2:8002/") == 0);
			REQUIRE(buff1[24] == 0);
			REQUIRE(buff1[25] == 'w');
			REQUIRE(buff1[26] == '?');
			REQUIRE(buff1[27] == '^');

			REQUIRE(CHN.compose_url(buff1, (pChar) "One", (pChar) "/", 32));
			REQUIRE(strcmp(buff1, "http://192.168.0.1:8001/") == 0);
			REQUIRE(buff1[24] == 0);
			buff1[25] = 'r';
			buff1[26] = 's';
			buff1[27] = 't';
			REQUIRE(CHN.compose_url(buff1, (pChar) "Two", (pChar) "/", 32));
			REQUIRE(strcmp(buff1, "http://192.168.0.2:8002/") == 0);
			REQUIRE(buff1[24] == 0);
			REQUIRE(buff1[25] == 'r');
			REQUIRE(buff1[26] == 's');
			REQUIRE(buff1[27] == 't');
		}

		WHEN("We try identification calls") {
			REQUIRE(!CHN.compose_url(buff1, (pChar) "one", (pChar) "/index.html", 1024));
			REQUIRE(!CHN.compose_url(buff1, (pChar) "ONE", (pChar) "/index.html", 1024));
			REQUIRE(!CHN.compose_url(buff1, (pChar) "q@x", (pChar) "/index.html", 1024));
			REQUIRE( CHN.compose_url(buff1, (pChar) "One", (pChar) "/index.html", 1024));

			REQUIRE(!CHN.compose_url(buff2, (pChar) "two", (pChar) "/index.html", 1024));
			REQUIRE(!CHN.compose_url(buff2, (pChar) "TWO", (pChar) "/index.html", 1024));
			REQUIRE(!CHN.compose_url(buff2, (pChar) "t22", (pChar) "/index.html", 1024));
			REQUIRE( CHN.compose_url(buff2, (pChar) "Two", (pChar) "/index.html", 1024));

			REQUIRE(!CHN.compose_url(buff3, (pChar) "three", (pChar) "/index.html", 1024));
			REQUIRE(!CHN.compose_url(buff3, (pChar) "THREE", (pChar) "/index.html", 1024));
			REQUIRE(!CHN.compose_url(buff3, (pChar) "q@x2z", (pChar) "/index.html", 1024));
			REQUIRE( CHN.compose_url(buff3, (pChar) "Three", (pChar) "/index.html", 1024));

			THEN("The results are as expected") {
				REQUIRE(strcmp(buff1, "http://192.168.0.1:8001/index.html") == 0);
				REQUIRE(strcmp(buff2, "http://192.168.0.2:8002/index.html") == 0);
				REQUIRE(strcmp(buff3, "http://192.168.0.3:8003/index.html") == 0);
			}
		}

		WHEN("We try char encoding calls") {
			REQUIRE(CHN.compose_url(buff1, (pChar) "One",
					(pChar) "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.~!#$&'()*+,/:;=?@[]", 1024));

			REQUIRE(CHN.compose_url(buff2, (pChar) "Two", (pChar) "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f", 1024));
			REQUIRE(CHN.compose_url(buff3, (pChar) "Three", (pChar) "\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f", 1024));

			THEN("The results are as expected") {
				REQUIRE(strcmp(buff1,
					"http://192.168.0.1:8001ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.~!#$&'()*+,/:;=?@[]") == 0);
				REQUIRE(strcmp(buff2, "http://192.168.0.2:8002%01%02%03%04%05%06%07%08%09%0A%0B%0C%0D%0E%0F") == 0);
				REQUIRE(strcmp(buff3, "http://192.168.0.3:8003%11%12%13%14%15%16%17%18%19%1A%1B%1C%1D%1E%1F") == 0);
			}

			REQUIRE(CHN.compose_url(buff1, (pChar) "One", (pChar) " !\"#$%&'()*+,-./0123456789:;<=>?", 1024));
			REQUIRE(CHN.compose_url(buff2, (pChar) "Two", (pChar) "@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_", 1024));
			REQUIRE(CHN.compose_url(buff3, (pChar) "Three", (pChar)"'abcdefghijklmnopqrstuvwxyz{|}~\x7f", 1024));

			THEN("The results are as expected") {
				REQUIRE(strcmp(buff1, "http://192.168.0.1:8001%20!\"#$%25&'()*+,-./0123456789:;%3C=%3E?") == 0);
				REQUIRE(strcmp(buff2, "http://192.168.0.2:8002@ABCDEFGHIJKLMNOPQRSTUVWXYZ[%5C]%5E_") == 0);
				REQUIRE(strcmp(buff3, "http://192.168.0.3:8003'abcdefghijklmnopqrstuvwxyz%7B%7C%7D~%7F") == 0);
			}

			REQUIRE(CHN.compose_url(buff1, (pChar) "One", (pChar) "\x81\xa2\xe3\x94\xf5\xe6\x97\xb8\xc9\xda\x8b\x9c\xed\x9e\x8f", 1024));
			REQUIRE(CHN.compose_url(buff2, (pChar) "Two", (pChar) "\x81\x92\xa3\xb4\xc5\xd6\xe7\xf8\x89\x9a\xab\xbc\xcd\xde\xef", 1024));
			REQUIRE(CHN.compose_url(buff3, (pChar) "Three", (pChar) "\x91\xa2\xb3\xc4\xd5\xe6\xf7\x88\x99\xaa\xbb\xcc\xdd\xee\xff", 1024));

			THEN("The results are as expected") {
				REQUIRE(strcmp(buff1, "http://192.168.0.1:8001%81%A2%E3%94%F5%E6%97%B8%C9%DA%8B%9C%ED%9E%8F") == 0);
				REQUIRE(strcmp(buff2, "http://192.168.0.2:8002%81%92%A3%B4%C5%D6%E7%F8%89%9A%AB%BC%CD%DE%EF") == 0);
				REQUIRE(strcmp(buff3, "http://192.168.0.3:8003%91%A2%B3%C4%D5%E6%F7%88%99%AA%BB%CC%DD%EE%FF") == 0);
			}
		}
	}

	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context != nullptr);

	REQUIRE(CHN.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CHN.alloc_bytes == 0);
	REQUIRE(CHN.p_buffer == nullptr);
	REQUIRE(CHN.p_free	 == nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.curl_ok == 0);
	REQUIRE(CHN.zmq_ok	== 0);

	REQUIRE(CHN.zmq_context == nullptr);
}


SCENARIO("Testing bash end-to-end") {

	REQUIRE(CHN.start() == SERVICE_NO_ERROR);

	REQUIRE(CHN.max_transactions > 0);
	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.warn_alloc_bytes > 0);
	REQUIRE(CHN.fail_alloc_bytes > 0);
	REQUIRE(CHN.alloc_warning_issued == false);
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN.p_free	 == CHN.p_buffer);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next == &pStoredTransaction(CHN.p_buffer)[1]);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next->p_next == &pStoredTransaction(CHN.p_buffer)[2]);
	REQUIRE(	pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 2].p_next
			== &pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1]);
	REQUIRE(pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1].p_next == nullptr);
	REQUIRE(CHN._lock_ == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context	!= nullptr);

	GIVEN("We have some blocks") {
		pTransaction p_tx_int, p_tx_inp, p_tx_res, p_tx_xlt;

		char input[] = {"for line in {0..4}; do\n"
						"  case $line in\n"
						"    0)\n"
						"      printf \"There was an Old Man in a boat, \\n\"\n"
						"	  ;;\n"
						"    1)\n"
						"      printf \"Who said: \\\"I'm afloat! I'm afloat!\\\" \\n\"\n"
						"	  ;;\n"
						"    2)\n"
						"      printf \"When they said: \\\"No, you ain't!\\\" \\n\"\n"
						"	  ;;\n"
						"    3)\n"
						"      printf \"He was ready to faint, \\n\"\n"
						"	  ;;\n"
						"    *)\n"
						"      printf \"That unhappy Old Man in a boat. \\n\"\n"
						"      ;;\n"
						"  esac\n"
						"done\n"};

		char result[] = {"There was an Old Man in a boat, \n"
						 "Who said: \"I'm afloat! I'm afloat!\" \n"
						 "When they said: \"No, you ain't!\" \n"
						 "He was ready to faint, \n"
						 "That unhappy Old Man in a boat. \n"};

		int dim[MAX_TENSOR_RANK] = {160, 0};

		REQUIRE(CHN.new_block(p_tx_int, CELL_TYPE_INTEGER, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		p_tx_int->p_block->tensor.cell_int[0]	= 1;
		p_tx_int->p_block->tensor.cell_int[159] = 159;

		dim[0] = strlen(input) + 1;

		REQUIRE(CHN.new_block(p_tx_inp, CELL_TYPE_BYTE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);

		memcpy(&p_tx_inp->p_block->tensor.cell_byte[0], input, dim[0]);

		REQUIRE(p_tx_inp->p_block->tensor.cell_byte[0] == 'f');
		REQUIRE(input[0] == 'f');

		dim[0] = strlen(result) + 100;

		REQUIRE(CHN.new_block(p_tx_res, CELL_TYPE_BYTE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);

		StaticBlockHeader hea[2]	 = {0, 0};
		Name			  names[2]	 = {"input", "result"};
		pBlock			  p_block[2] = {p_tx_inp->p_block, p_tx_res->p_block};

		memcpy(&hea[0], p_block[0], sizeof(StaticBlockHeader));
		memcpy(&hea[1], p_block[1], sizeof(StaticBlockHeader));

		p_block[0]->get_dimensions(hea[0].range.dim);
		p_block[1]->get_dimensions(hea[1].range.dim);

		REQUIRE(CHN.new_block(p_tx_xlt, 2, hea, names, p_block) == SERVICE_NO_ERROR);

		pTransaction p_txn;

		WHEN("We test new_entity()/put()/get()/remove()") {
			REQUIRE(CHN.new_entity((pChar) "//bash//anything") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.new_entity((pChar) "/bash//anything") == SERVICE_ERROR_WRONG_ARGUMENTS);

			REQUIRE(CHN.remove((pChar) "//bash//anything") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.remove((pChar) "/bash//anything") == SERVICE_ERROR_WRONG_ARGUMENTS);

			REQUIRE(CHN.get(p_txn, (pChar) "//bash//this/that") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.get(p_txn, (pChar) "/bash//this/that") == SERVICE_ERROR_WRONG_ARGUMENTS);

			REQUIRE(CHN.put((pChar) "//bash//this/that", p_tx_int->p_block) == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.put((pChar) "/bash//this/that", p_tx_int->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
		}
		WHEN("We check all the non applicable") {
			StaticBlockHeader hea;
			Locator loc;

			REQUIRE(CHN.locate(loc, (pChar) "//bash//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//bash//tmp/jzz_ftest/fff/pop", (pChar) "value") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//bash//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(hea, (pChar) "//bash//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.locate(loc, (pChar) "//bash//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//bash//tmp/jzz_ftest/fff/int", p_tx_int->p_block) == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//bash//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(hea, (pChar) "//bash//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);
		}

		WHEN("We test copy") {
			REQUIRE(CHN.copy((pChar) "//bash/where", (pChar) "//bash/what") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.copy((pChar) "//bash/where", (pChar) "/bash/what") == SERVICE_ERROR_WRONG_ARGUMENTS);
		}

		WHEN("We test modify") {
			Locator fun = {"bash", "exec", "", 0};

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_int->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);

			CHN.can_bash = 0;
			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.can_bash = 1;
			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_tx_xlt->p_block->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_tx_xlt->p_block->size == 2);
			REQUIRE(pTuple(p_tx_xlt->p_block)->index((pChar) "input") == 0);
			REQUIRE(pTuple(p_tx_xlt->p_block)->index((pChar) "result") == 1);
			REQUIRE(pTuple(p_tx_xlt->p_block)->get_block(0)->cell_type == CELL_TYPE_BYTE);
			REQUIRE(pTuple(p_tx_xlt->p_block)->get_block(1)->cell_type == CELL_TYPE_BYTE);

			pChar p_res = (pChar) &pTuple(p_tx_xlt->p_block)->get_block(1)->tensor.cell_byte[0];

			REQUIRE(strcmp(p_res, result) == 0);
		}

		CHN.destroy_transaction(p_tx_int);
		CHN.destroy_transaction(p_tx_inp);
		CHN.destroy_transaction(p_tx_res);
		CHN.destroy_transaction(p_tx_xlt);
	}

	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context != nullptr);

	REQUIRE(CHN.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CHN.alloc_bytes == 0);
	REQUIRE(CHN.p_buffer == nullptr);
	REQUIRE(CHN.p_free	 == nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.curl_ok == 0);
	REQUIRE(CHN.zmq_ok	== 0);

	REQUIRE(CHN.zmq_context == nullptr);
}


SCENARIO("Testing file end-to-end") {

	REQUIRE(CHN.start() == SERVICE_NO_ERROR);

	REQUIRE(CHN.max_transactions > 0);
	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.warn_alloc_bytes > 0);
	REQUIRE(CHN.fail_alloc_bytes > 0);
	REQUIRE(CHN.alloc_warning_issued == false);
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN.p_free	 == CHN.p_buffer);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next == &pStoredTransaction(CHN.p_buffer)[1]);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next->p_next == &pStoredTransaction(CHN.p_buffer)[2]);
	REQUIRE(	pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 2].p_next
			== &pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1]);
	REQUIRE(pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1].p_next == nullptr);
	REQUIRE(CHN._lock_ == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context	!= nullptr);

	GIVEN("We have some blocks and indices") {
		Index txt;

		txt["one__"] = "Abc ..";
		txt["two__"] = "[[1,2,3],%20[1,2,3]]";
		txt["three"] = "";
		txt["_four"] = "A multiline string\nis okay\n";
		txt["fi_ve"] = "UTF8 ¡what!\n\nLöwe\n";

		pTransaction p_tx_pop, p_tx_str, p_tx_chr, p_tx_int, p_tx_rea, p_tx_tim, p_tx_fil, p_tx_xlt;

		int dim[MAX_TENSOR_RANK] = {20, 5, 0};

		REQUIRE(CHN.new_block(p_tx_pop, txt) == SERVICE_NO_ERROR);
		REQUIRE(CHN.new_block(p_tx_str, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, 0, (pChar) "Line\ntwo\nthree") == 0);
		REQUIRE(CHN.new_block(p_tx_chr, CELL_TYPE_BYTE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		p_tx_chr->p_block->tensor.cell_byte[0]  = 1;
		p_tx_chr->p_block->tensor.cell_byte[99] = 99;

		dim[1] = 8;
		REQUIRE(CHN.new_block(p_tx_int, CELL_TYPE_INTEGER, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		p_tx_int->p_block->tensor.cell_int[0]	= 1;
		p_tx_int->p_block->tensor.cell_int[159] = 159;

		dim[1] = 4;
		REQUIRE(CHN.new_block(p_tx_rea, CELL_TYPE_DOUBLE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		p_tx_rea->p_block->tensor.cell_double[0]  = 1.23;
		p_tx_rea->p_block->tensor.cell_double[79] = 21.345;

		dim[1] = 1;
		REQUIRE(CHN.new_block(p_tx_tim, CELL_TYPE_TIME, dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);

		struct tm junk		= {0};
		struct tm *timeinfo = &junk;

		char buffer[20] = {"2021-08-01 12:13:14"};
		char fmt[20]	= {"%Y-%m-%d %H:%M:%S"};

		REQUIRE(strptime(buffer, fmt, timeinfo) != nullptr);

		REQUIRE(timeinfo->tm_mday == 1);

		for (int i = 0; i < 20; i++) {
			timeinfo->tm_mday =  1 + (3*i % 29);
			timeinfo->tm_hour =  7 + (5*i % 7);
			timeinfo->tm_min  = 13 + (7*i % 31);
			p_tx_tim->p_block->tensor.cell_time[i] = timegm(timeinfo);
		}

		dim[0] = 2;
		dim[1] = 0;
		REQUIRE(CHN.new_block(p_tx_fil, CELL_TYPE_INTEGER, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		dim[0] = 20;
		p_tx_fil->p_block->tensor.cell_int[0]  = 0;
		p_tx_fil->p_block->tensor.cell_int[1]  = 2;

		REQUIRE(p_tx_fil->p_block->can_filter(p_tx_tim->p_block));
		REQUIRE(p_tx_fil->p_block->can_filter(p_tx_rea->p_block));
		REQUIRE(p_tx_fil->p_block->can_filter(p_tx_int->p_block));
		REQUIRE(p_tx_fil->p_block->can_filter(p_tx_chr->p_block));

		StaticBlockHeader hea[2]	 = {0, 0};
		Name			  names[2]	 = {"input", "result"};
		pBlock			  p_block[2] = {p_tx_rea->p_block, p_tx_int->p_block};

		memcpy(&hea[0], p_block[0], sizeof(StaticBlockHeader));
		memcpy(&hea[1], p_block[1], sizeof(StaticBlockHeader));

		p_block[0]->get_dimensions(hea[0].range.dim);
		p_block[1]->get_dimensions(hea[1].range.dim);

		REQUIRE(CHN.new_block(p_tx_xlt, 2, hea, names, p_block) == SERVICE_NO_ERROR);

		pTransaction p_txn;

		CHN.remove((pChar) "//file//tmp/jzz_ftest");
		CHN.new_entity((pChar) "//file//tmp/jzz_ftest");

		int n_rows;
		pTuple p_tup;
		pBlock p_key, p_val, p_blk;

		WHEN("We test new_entity()/remove()") {
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/folder") == SERVICE_NO_ERROR);

			CHN.file_lev = 1;
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/folder/ff") == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.file_lev = 2;
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/folder/ff") == SERVICE_NO_ERROR);
			CHN.file_lev = 3;
			REQUIRE(CHN.new_entity((pChar) "//files//tmp/jzz_ftest/folder/ff") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/folder/ff") == SERVICE_ERROR_IO_ERROR);
			CHN.file_lev = 2;
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/folder/ff") == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.file_lev = 3;

			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/folder/blk", p_tx_int->p_block) == SERVICE_NO_ERROR);

			THEN("We get expected structure") {
				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/folder/blk") == SERVICE_NO_ERROR);
				REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE);
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/folder/blk4") == SERVICE_ERROR_BLOCK_NOT_FOUND);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/folder") == SERVICE_NO_ERROR);
				REQUIRE(p_txn != nullptr);

				p_blk = p_txn->p_block;

				REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
				REQUIRE(p_blk->size == 2);
				REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
				REQUIRE(p_tup->index((pChar) "value") == 1);
				REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
				REQUIRE(p_key->rank == 1);
				REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
				REQUIRE(p_val->rank == 1);
				REQUIRE((n_rows = p_key->size) == p_val->size);

				REQUIRE(n_rows == 2);

				if (strcmp(p_key->get_string(0), "blk") == 0) {
					REQUIRE(strcmp(p_val->get_string(0), "file") == 0);
					REQUIRE(strcmp(p_key->get_string(1), "ff") == 0);
					REQUIRE(strcmp(p_val->get_string(1), "folder") == 0);
				} else {
					REQUIRE(strcmp(p_key->get_string(0), "ff") == 0);
					REQUIRE(strcmp(p_val->get_string(0), "folder") == 0);
					REQUIRE(strcmp(p_key->get_string(1), "blk") == 0);
					REQUIRE(strcmp(p_val->get_string(1), "file") == 0);
				}
				CHN.destroy_transaction(p_txn);
			}

			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/folder/blk/aaa") == SERVICE_ERROR_IO_ERROR);
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/folder") == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/folder/blk") == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/folder") == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/folder") == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest") == SERVICE_NO_ERROR);
			REQUIRE(p_txn != nullptr);

			p_blk = p_txn->p_block;

			REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_blk->size == 2);
			REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
			REQUIRE(p_tup->index((pChar) "value") == 1);
			REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_key->rank == 1);
			REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_val->rank == 1);
			REQUIRE((n_rows = p_key->size) == p_val->size);

			CHN.destroy_transaction(p_txn);
		}
		WHEN("We test put()/get()/remove() of keys") {
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/fff") == SERVICE_NO_ERROR);

			REQUIRE(   CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop_t", p_tx_pop->p_block, WRITE_AS_CONTENT)
					== SERVICE_ERROR_WRITE_FORBIDDEN);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/str_t", p_tx_str->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/chr_t", p_tx_chr->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/int_t", p_tx_int->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/rea_t", p_tx_rea->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/tim_t", p_tx_tim->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/fil_t", p_tx_fil->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);

			CHN.file_lev = 1;
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.file_lev = 2;
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.file_lev = 3;
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//files//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_ERROR_WRONG_BASE);

			p_tx_pop->p_block->close_block();
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			p_tx_str->p_block->close_block();
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/str", p_tx_str->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			p_tx_chr->p_block->close_block();
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/chr", p_tx_chr->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			p_tx_int->p_block->close_block();
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/int", p_tx_int->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			p_tx_rea->p_block->close_block();
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/rea", p_tx_rea->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			p_tx_tim->p_block->close_block();
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/tim", p_tx_tim->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			p_tx_fil->p_block->close_block();
			REQUIRE(   CHN.put((pChar) "//file//tmp/jzz_ftest/fff/fil", p_tx_fil->p_block, WRITE_AS_FULL_BLOCK | WRITE_ONLY_IF_NOT_EXISTS)
					== SERVICE_NO_ERROR);

			REQUIRE(   CHN.put((pChar) "//file//tmp/jzz_ftest/fff/fil", p_tx_fil->p_block, WRITE_AS_CONTENT | WRITE_ONLY_IF_NOT_EXISTS)
					== SERVICE_ERROR_WRITE_FORBIDDEN);

			REQUIRE(   CHN.put((pChar) "//file//tmp/jzz_ftest/fff/rea", p_tx_rea->p_block, WRITE_AS_FULL_BLOCK | WRITE_ONLY_IF_EXISTS)
					== SERVICE_NO_ERROR);

			REQUIRE(   CHN.put((pChar) "//file//tmp/jzz_ftest/fff/rea2", p_tx_rea->p_block, WRITE_AS_CONTENT | WRITE_ONLY_IF_EXISTS)
					== SERVICE_ERROR_WRITE_FORBIDDEN);

			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/fil_t", p_tx_fil->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);

			THEN("We get expected structure") {
				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/pop_t") == SERVICE_ERROR_BLOCK_NOT_FOUND);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/str_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_str));
				CHN.destroy_transaction(p_txn);

				CHN.file_lev = 0;
				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/str_t") == SERVICE_ERROR_BASE_FORBIDDEN);
				CHN.file_lev = 3;
				REQUIRE(CHN.get(p_txn, (pChar) "//files//tmp/jzz_ftest/fff/str_t") == SERVICE_ERROR_WRONG_BASE);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/chr_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_chr));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/int_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_int));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/rea_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_rea));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/tim_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_tim));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/fil_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_fil));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_pop));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/str") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_str));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/chr") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_chr));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/int") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_int));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/rea") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_rea));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/tim") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_tim));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/fil") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_fil));
				p_blk = (pBlock) &p_txn->p_block->tensor;
				REQUIRE(p_blk->check_hash());
				CHN.destroy_transaction(p_txn);
			}

			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/chr") == SERVICE_NO_ERROR);
			CHN.destroy_transaction(p_txn);

			CHN.file_lev = 2;
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff/chr") == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.file_lev = 3;
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff/chr") == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/chr") == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff/chr") == SERVICE_ERROR_BLOCK_NOT_FOUND);

			REQUIRE(CHN.remove((pChar) "//files//tmp/jzz_ftest/fff/fil") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff/fil") == SERVICE_NO_ERROR);

			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff") == SERVICE_NO_ERROR);
		}

		WHEN("We check all the non applicable") {
			StaticBlockHeader hea;
			Locator loc;

			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/fff") == SERVICE_NO_ERROR);

			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop", p_tx_pop->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/int", p_tx_int->p_block, WRITE_AS_FULL_BLOCK) == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_NO_ERROR);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.locate(loc, (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/pop", (pChar) "value") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(hea, (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/int") == SERVICE_NO_ERROR);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.locate(loc, (pChar) "//file//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/int", p_tx_fil->p_block) == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(hea, (pChar) "//file//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff") == SERVICE_NO_ERROR);
		}

		WHEN("We test copy") {
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/fff") == SERVICE_NO_ERROR);
			REQUIRE(CHN.new_entity((pChar) "//file//tmp/jzz_ftest/ggg") == SERVICE_NO_ERROR);

			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/pop",   p_tx_pop->p_block, WRITE_AS_FULL_BLOCK)  == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/str",   p_tx_str->p_block, WRITE_AS_FULL_BLOCK)  == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/int_t", p_tx_int->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//file//tmp/jzz_ftest/fff/tim_t", p_tx_tim->p_block, WRITE_AS_CONTENT) == SERVICE_NO_ERROR);

			THEN("We get expected structure") {
				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_pop));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/str") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_str));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/int_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_int));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/fff/tim_t") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_tim));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/pop") == SERVICE_ERROR_BLOCK_NOT_FOUND);

				CHN.file_lev = 2;
				REQUIRE(CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/pop", (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_NO_ERROR);
				REQUIRE(   CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/pop", (pChar) "//file//tmp/jzz_ftest/fff/pop")
						== SERVICE_ERROR_BASE_FORBIDDEN);

				CHN.file_lev = 3;
				REQUIRE(CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/pop", (pChar) "//file//tmp/jzz_ftest/fff/pop") == SERVICE_NO_ERROR);

				REQUIRE(   CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/pop", (pChar) "//files//tmp/jzz_ftest/fff/pop")
						== SERVICE_ERROR_WRONG_BASE);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/pop") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_pop));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/str") == SERVICE_ERROR_BLOCK_NOT_FOUND);

				REQUIRE(CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/str", (pChar) "//file//tmp/jzz_ftest/fff/str") == SERVICE_NO_ERROR);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/str") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_block(p_txn, p_tx_str));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/int") == SERVICE_ERROR_BLOCK_NOT_FOUND);

				REQUIRE(CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/int", (pChar) "//file//tmp/jzz_ftest/fff/int_t") == SERVICE_NO_ERROR);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/int") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_int));
				CHN.destroy_transaction(p_txn);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/tim") == SERVICE_ERROR_BLOCK_NOT_FOUND);

				REQUIRE(CHN.copy((pChar) "//file//tmp/jzz_ftest/ggg/tim", (pChar) "//file//tmp/jzz_ftest/fff/tim_t") == SERVICE_NO_ERROR);

				REQUIRE(CHN.get(p_txn, (pChar) "//file//tmp/jzz_ftest/ggg/tim") == SERVICE_NO_ERROR);
				REQUIRE(compare_to_tensor(p_txn, p_tx_tim));
				CHN.destroy_transaction(p_txn);
			}
			REQUIRE(CHN.remove((pChar) "//file//tmp/jzz_ftest/fff") == SERVICE_NO_ERROR);
		}

		WHEN("We test modify") {
			Locator fun = {"file", "anything", "", 0};

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_pop->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_ERROR_WRONG_BASE);
		}

		CHN.destroy_transaction(p_tx_pop);
		CHN.destroy_transaction(p_tx_str);
		CHN.destroy_transaction(p_tx_chr);
		CHN.destroy_transaction(p_tx_int);
		CHN.destroy_transaction(p_tx_rea);
		CHN.destroy_transaction(p_tx_tim);
		CHN.destroy_transaction(p_tx_fil);
		CHN.destroy_transaction(p_tx_xlt);
	}

	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context != nullptr);

	REQUIRE(CHN.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CHN.alloc_bytes == 0);
	REQUIRE(CHN.p_buffer == nullptr);
	REQUIRE(CHN.p_free	 == nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.curl_ok == 0);
	REQUIRE(CHN.zmq_ok	== 0);

	REQUIRE(CHN.zmq_context == nullptr);
}


SCENARIO("Testing 0-mq end-to-end") {

	REQUIRE(CHN.start() == SERVICE_NO_ERROR);

	REQUIRE(CHN.max_transactions > 0);
	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.warn_alloc_bytes > 0);
	REQUIRE(CHN.fail_alloc_bytes > 0);
	REQUIRE(CHN.alloc_warning_issued == false);
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN.p_free	 == CHN.p_buffer);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next == &pStoredTransaction(CHN.p_buffer)[1]);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next->p_next == &pStoredTransaction(CHN.p_buffer)[2]);
	REQUIRE(	pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 2].p_next
			== &pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1]);
	REQUIRE(pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1].p_next == nullptr);
	REQUIRE(CHN._lock_ == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context	!= nullptr);

	GIVEN("We have some blocks") {
		pTransaction p_tx_int, p_tx_inp, p_tx_res, p_tx_xlt, p_tx_pi1, p_tx_pi2;

		char input[] = {"for line in {0..4}; do\n"
						"  case $line in\n"
						"    0)\n"
						"      printf \"There was an Old Man in a boat, \\n\"\n"
						"	  ;;\n"
						"    1)\n"
						"      printf \"Who said: \\\"I'm afloat! I'm afloat!\\\" \\n\"\n"
						"	  ;;\n"
						"    2)\n"
						"      printf \"When they said: \\\"No, you ain't!\\\" \\n\"\n"
						"	  ;;\n"
						"    3)\n"
						"      printf \"He was ready to faint, \\n\"\n"
						"	  ;;\n"
						"    *)\n"
						"      printf \"That unhappy Old Man in a boat. \\n\"\n"
						"      ;;\n"
						"  esac\n"
						"done\n"};

		char res_alpha[] = {"forlinein04do\n"
							"caselinein\n"
							"0\n"
							"printfTherewasanOldManinaboatn\n"
							"\n"
							"1\n"
							"printfWhosaidImafloatImafloatn\n"
							"\n"
							"2\n"
							"printfWhentheysaidNoyouaintn\n"
							"\n"
							"3\n"
							"printfHewasreadytofaintn\n"
							"\n"
							"\n"
							"printfThatunhappyOldManinaboatn\n"
							"\n"
							"esac\n"
							"done\n"};

		char res_a2m[] = {"flieidcaelieiifheeaaldaiabaifhaidmaflamaflaifheheaidaiifeaeadfaiifhahaldaiabaeacde"};

		int dim[MAX_TENSOR_RANK] = {160, 0};

		REQUIRE(CHN.new_block(p_tx_int, CELL_TYPE_INTEGER, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		p_tx_int->p_block->tensor.cell_int[0]	= 1;
		p_tx_int->p_block->tensor.cell_int[159] = 159;

		dim[0] = strlen(input) + 1;

		REQUIRE(CHN.new_block(p_tx_inp, CELL_TYPE_BYTE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);

		memcpy(&p_tx_inp->p_block->tensor.cell_byte[0], input, dim[0]);

		REQUIRE(p_tx_inp->p_block->tensor.cell_byte[0] == 'f');
		REQUIRE(input[0] == 'f');

		dim[0] = strlen(res_alpha) + 100;

		REQUIRE(CHN.new_block(p_tx_res, CELL_TYPE_BYTE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);

		StaticBlockHeader hea[2]	 = {0, 0};
		Name			  names[2]	 = {"input", "result"};
		pBlock			  p_block[2] = {p_tx_inp->p_block, p_tx_res->p_block};

		memcpy(&hea[0], p_block[0], sizeof(StaticBlockHeader));
		memcpy(&hea[1], p_block[1], sizeof(StaticBlockHeader));

		p_block[0]->get_dimensions(hea[0].range.dim);
		p_block[1]->get_dimensions(hea[1].range.dim);

		REQUIRE(CHN.new_block(p_tx_xlt, 2, hea, names, p_block) == SERVICE_NO_ERROR);

		REQUIRE(   CHN.new_block(p_tx_pi1, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, 0, (pChar) "tcp://localhost:5555")
				== SERVICE_NO_ERROR);

		REQUIRE(p_tx_pi1->p_block->size == 1);

		REQUIRE(   CHN.new_block(p_tx_pi2, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, 0, (pChar) "tcp://localhost:5566")
				== SERVICE_NO_ERROR);

		REQUIRE(p_tx_pi2->p_block->size == 1);

		pTransaction p_txn;

		WHEN("We test new_entity()/put()/get()/remove()") {
			REQUIRE(CHN.pipes.size() == 0);

			REQUIRE(CHN.new_entity((pChar) "//0-mq//anything") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.new_entity((pChar) "/0-mq//anything") == SERVICE_ERROR_WRONG_ARGUMENTS);

			REQUIRE(CHN.remove((pChar) "//0-mq//anything") == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.remove((pChar) "/0-mq//anything") == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_ENTITY_NOT_FOUND);
			REQUIRE(CHN.remove((pChar) "//0-mqq//anything") == SERVICE_ERROR_WRONG_BASE);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq//this/that") == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.get(p_txn, (pChar) "/0-mq//this/that") == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_ENTITY_NOT_FOUND);
			REQUIRE(CHN.get(p_txn, (pChar) "//0-mqq//this/that") == SERVICE_ERROR_WRONG_BASE);

			REQUIRE(CHN.put((pChar) "//0-mq//this/that", p_tx_int->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.put((pChar) "/0-mq//this/that", p_tx_int->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.put((pChar) "//0-mq/pipeline/aaa", p_tx_int->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.put((pChar) "//0-mqq//this/that", p_tx_int->p_block) == SERVICE_ERROR_WRONG_BASE);

			CHN.zmq_ok = 0;
			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_BASE_FORBIDDEN);
			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_BASE_FORBIDDEN);
			REQUIRE(CHN.put((pChar) "//0-mq/pipeline/aaa", p_tx_int->p_block) == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.zmq_ok = 1;
		}
		WHEN("We check all the non applicable") {
			StaticBlockHeader hea;
			Locator loc;

			REQUIRE(CHN.locate(loc, (pChar) "//0-mq//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq//tmp/jzz_ftest/fff/pop", (pChar) "value") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//0-mq//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(hea, (pChar) "//0-mq//tmp/jzz_ftest/fff/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.locate(loc, (pChar) "//0-mq//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq//tmp/jzz_ftest/fff/int", p_tx_int->p_block) == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//0-mq//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(hea, (pChar) "//0-mq//tmp/jzz_ftest/fff/int") == SERVICE_ERROR_NOT_APPLICABLE);
		}

		WHEN("We test copy") {
			REQUIRE(CHN.pipes.size() == 0);

			REQUIRE(CHN.copy((pChar) "//0-mq/where", (pChar) "//0-mq/what") == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.copy((pChar) "//0-mq/where", (pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_ENTITY_NOT_FOUND);

			REQUIRE(CHN.put((pChar) "//0-mq/pipeline/aaa", p_tx_pi1->p_block) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//0-mq/pipeline/aaa", p_tx_pi1->p_block) == SERVICE_ERROR_WRITE_FORBIDDEN);

			REQUIRE(CHN.pipes.size() == 1);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/aaa") == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "tcp://localhost:5555") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/bbb") == SERVICE_ERROR_ENTITY_NOT_FOUND);

			REQUIRE(CHN.copy((pChar) "//0-mq/pipeline/bbb", (pChar) "//0-mq/pipeline/aaa") == SERVICE_NO_ERROR);

			REQUIRE(CHN.pipes.size() == 2);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/bbb") == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "tcp://localhost:5555") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/bbb") == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/bbb") == SERVICE_ERROR_ENTITY_NOT_FOUND);
			REQUIRE(CHN.pipes.size() == 1);

			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/aaa") == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, (pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_ENTITY_NOT_FOUND);
			REQUIRE(CHN.pipes.size() == 0);

			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/aaa") == SERVICE_ERROR_ENTITY_NOT_FOUND);
		}

		WHEN("We test modify") {
			Locator fun = {"0-mq", "exec", "", 0};

			REQUIRE(CHN.pipes.size() == 0);

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_int->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);

			CHN.zmq_ok = 0;
			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_ERROR_BASE_FORBIDDEN);
			CHN.zmq_ok = 1;

			REQUIRE(CHN.put((pChar) "//0-mq/pipeline/alpha", p_tx_pi1->p_block) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//0-mq/pipeline/a2m", p_tx_pi2->p_block) == SERVICE_NO_ERROR);

			REQUIRE(CHN.pipes.size() == 2);

			strcpy(fun.entity, "alpha");

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_tx_xlt->p_block->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_tx_xlt->p_block->size == 2);
			REQUIRE(pTuple(p_tx_xlt->p_block)->index((pChar) "input") == 0);
			REQUIRE(pTuple(p_tx_xlt->p_block)->index((pChar) "result") == 1);
			REQUIRE(pTuple(p_tx_xlt->p_block)->get_block(0)->cell_type == CELL_TYPE_BYTE);
			REQUIRE(pTuple(p_tx_xlt->p_block)->get_block(1)->cell_type == CELL_TYPE_BYTE);

			pChar p_res = (pChar) &pTuple(p_tx_xlt->p_block)->get_block(1)->tensor.cell_byte[0];

			REQUIRE(strcmp(p_res, res_alpha) == 0);

			strcpy(fun.entity, "a2m");

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_tx_xlt->p_block->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_tx_xlt->p_block->size == 2);
			REQUIRE(pTuple(p_tx_xlt->p_block)->index((pChar) "input") == 0);
			REQUIRE(pTuple(p_tx_xlt->p_block)->index((pChar) "result") == 1);
			REQUIRE(pTuple(p_tx_xlt->p_block)->get_block(0)->cell_type == CELL_TYPE_BYTE);
			REQUIRE(pTuple(p_tx_xlt->p_block)->get_block(1)->cell_type == CELL_TYPE_BYTE);

			p_res = (pChar) &pTuple(p_tx_xlt->p_block)->get_block(1)->tensor.cell_byte[0];

			REQUIRE(strcmp(p_res, res_a2m) == 0);

			strcpy(fun.base, "yy");

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_ERROR_WRONG_BASE);

			strcpy(fun.base, "0-mq");
			strcpy(fun.entity, "what");

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_ERROR_ENTITY_NOT_FOUND);

			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/alpha") == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove((pChar) "//0-mq/pipeline/a2m") == SERVICE_NO_ERROR);

			REQUIRE(CHN.pipes.size() == 0);
		}

		CHN.destroy_transaction(p_tx_int);
		CHN.destroy_transaction(p_tx_inp);
		CHN.destroy_transaction(p_tx_res);
		CHN.destroy_transaction(p_tx_xlt);
		CHN.destroy_transaction(p_tx_pi1);
		CHN.destroy_transaction(p_tx_pi2);
	}

	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context != nullptr);

	REQUIRE(CHN.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CHN.alloc_bytes == 0);
	REQUIRE(CHN.p_buffer == nullptr);
	REQUIRE(CHN.p_free	 == nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.curl_ok == 0);
	REQUIRE(CHN.zmq_ok	== 0);

	REQUIRE(CHN.zmq_context == nullptr);
}


SCENARIO("Testing http end-to-end") {

	REQUIRE(CHN.start() == SERVICE_NO_ERROR);

	REQUIRE(CHN.max_transactions > 0);
	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.warn_alloc_bytes > 0);
	REQUIRE(CHN.fail_alloc_bytes > 0);
	REQUIRE(CHN.alloc_warning_issued == false);
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN.p_free	 == CHN.p_buffer);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next == &pStoredTransaction(CHN.p_buffer)[1]);
	REQUIRE(pStoredTransaction(CHN.p_free)->p_next->p_next == &pStoredTransaction(CHN.p_buffer)[2]);
	REQUIRE(	pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 2].p_next
			== &pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1]);
	REQUIRE(pStoredTransaction(CHN.p_buffer)[CHN.max_transactions - 1].p_next == nullptr);
	REQUIRE(CHN._lock_ == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context	!= nullptr);

	GIVEN("We have some blocks and indices") {
		pTransaction p_tx_ix1, p_tx_ix2, p_tx_tp1, p_tx_tp2, p_tx_str, p_tx_rea, p_tx_tim, p_tx_xlt, p_tx_buf;

		REQUIRE(CHN.new_block(p_tx_str, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, 0, (pChar) "Line\ntwo\nthree") == 0);

		int dim[MAX_TENSOR_RANK] = {20, 5, 0};

		REQUIRE(CHN.new_block(p_tx_rea, CELL_TYPE_DOUBLE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		p_tx_rea->p_block->tensor.cell_double[0]  = 1.23;
		p_tx_rea->p_block->tensor.cell_double[79] = 21.345;

		dim[1] = 1;
		REQUIRE(CHN.new_block(p_tx_tim, CELL_TYPE_TIME, dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);

		struct tm junk		= {0};
		struct tm *timeinfo = &junk;

		char buffer[20] = {"2021-08-01 12:13:14"};
		char fmt[20]	= {"%Y-%m-%d %H:%M:%S"};

		REQUIRE(strptime(buffer, fmt, timeinfo) != nullptr);

		REQUIRE(timeinfo->tm_mday == 1);

		for (int i = 0; i < 20; i++) {
			timeinfo->tm_mday =  1 + (3*i % 29);
			timeinfo->tm_hour =  7 + (5*i % 7);
			timeinfo->tm_min  = 13 + (7*i % 31);
			p_tx_tim->p_block->tensor.cell_time[i] = timegm(timeinfo);
		}

		StaticBlockHeader hea[2]	 = {0, 0};
		Name			  names[2]	 = {"input", "result"};
		pBlock			  p_block[2] = {p_tx_rea->p_block, p_tx_tim->p_block};

		memcpy(&hea[0], p_block[0], sizeof(StaticBlockHeader));
		memcpy(&hea[1], p_block[1], sizeof(StaticBlockHeader));

		p_block[0]->get_dimensions(hea[0].range.dim);
		p_block[1]->get_dimensions(hea[1].range.dim);

		REQUIRE(CHN.new_block(p_tx_xlt, 2, hea, names, p_block) == SERVICE_NO_ERROR);

		REQUIRE(CHN.new_block(p_tx_ix1, CELL_TYPE_INDEX) == SERVICE_NO_ERROR);

		p_tx_ix1->p_hea->index["URL"] = "http://127.0.0.1:5000/test/capital/";

		REQUIRE(CHN.new_block(p_tx_tp1, p_tx_ix1->p_hea->index) == SERVICE_NO_ERROR);

		REQUIRE(p_tx_tp1 != nullptr);

		int n_rows;
		pTuple p_tup;
		pBlock p_key, p_val, p_blk = p_tx_tp1->p_block;

		REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
		REQUIRE(p_blk->size == 2);
		REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
		REQUIRE(p_tup->index((pChar) "value") == 1);
		REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_key->rank == 1);
		REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_val->rank == 1);
		REQUIRE((n_rows = p_key->size) == p_val->size);

		REQUIRE(CHN.new_block(p_tx_ix2, CELL_TYPE_INDEX) == SERVICE_NO_ERROR);

		p_tx_ix2->p_hea->index["URL"] = "http://127.0.0.1:5000/test/str.blk";
		p_tx_ix2->p_hea->index["CURLOPT_USERNAME"]   = "whoami";
		p_tx_ix2->p_hea->index["CURLOPT_USERPWD"]    = "XXX";
		p_tx_ix2->p_hea->index["CURLOPT_COOKIEFILE"] = "./cookiefile";
		p_tx_ix2->p_hea->index["CURLOPT_COOKIEJAR"]  = "./cookiejar";

		REQUIRE(CHN.new_block(p_tx_tp2, p_tx_ix2->p_hea->index) == SERVICE_NO_ERROR);

		REQUIRE(p_tx_tp2 != nullptr);

		p_blk = p_tx_tp1->p_block;

		REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
		REQUIRE(p_blk->size == 2);
		REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
		REQUIRE(p_tup->index((pChar) "value") == 1);
		REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_key->rank == 1);
		REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_val->rank == 1);
		REQUIRE((n_rows = p_key->size) == p_val->size);

		dim[0] = 256;
		dim[1] = 0;
		REQUIRE(CHN.new_block(p_tx_buf, CELL_TYPE_BYTE, dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);

		pTransaction p_txn;

		char url[256], url2[256];

		WHEN("We test new_entity()/remove()") {
			REQUIRE(CHN.new_entity((pChar) "//http/anything") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.new_entity((pChar) "/http/anything") == SERVICE_ERROR_WRONG_ARGUMENTS);

			REQUIRE(CHN.connect.size() == 0);
		}
		WHEN("We test put()/get()/remove() on direct links") {
			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Germany");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_ERROR_BLOCK_NOT_FOUND);
			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Spain");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Madrid\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			strcpy((pChar) &p_tx_buf->p_block->tensor.cell_byte[0], "Berlin");

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Germany");
			REQUIRE(CHN.put(url, p_tx_buf->p_block, WRITE_AS_STRING) == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Berlin\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.remove(url) == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove(url) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/madAGASCAR");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Antananarivo\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			strcpy((pChar) &p_tx_buf->p_block->tensor.cell_byte[0], "Rome");

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Italy");
			REQUIRE(CHN.put(url, p_tx_buf->p_block, WRITE_AS_STRING) == SERVICE_NO_ERROR);

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/italy");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Rome\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/italy");
			REQUIRE(CHN.remove(url) == SERVICE_NO_ERROR);
			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Italy");
			REQUIRE(CHN.remove(url) == SERVICE_ERROR_BLOCK_NOT_FOUND);
		}
		WHEN("We test put()/get()/remove() on a connection") {
			REQUIRE(CHN.connect.size() == 0);

			REQUIRE(CHN.put((pChar) "//http/connection/capitals", p_tx_tp1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(CHN.connect.size() == 1);

			REQUIRE(CHN.put((pChar) "//http/connection/capitals", p_tx_tp1->p_block) == SERVICE_ERROR_WRITE_FORBIDDEN);
			REQUIRE(CHN.put((pChar) "//http/connection/cap", p_tx_tp1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(CHN.connect.size() == 2);

			REQUIRE(CHN.put((pChar) "//http/connection/binblk", p_tx_tp2->p_block) == SERVICE_NO_ERROR);
			REQUIRE(CHN.put((pChar) "//http/connection/binblk", p_tx_tp2->p_block) == SERVICE_ERROR_WRITE_FORBIDDEN);
			REQUIRE(CHN.put((pChar) "//http/connection/quick", p_tx_rea->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.put((pChar) "//https/connection/binblk", p_tx_tp2->p_block) == SERVICE_ERROR_WRONG_BASE);

			REQUIRE(CHN.connect.size() == 3);

			strcpy(url, "//http/binblk");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->check_hash());
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.put(url, p_tx_str->p_block) == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove(url) == SERVICE_ERROR_WRITE_FORBIDDEN);

			REQUIRE(CHN.get(p_txn, (pChar) "//http/connection/binblk") == SERVICE_NO_ERROR);
			REQUIRE(p_txn != nullptr);

			p_blk = p_txn->p_block;

			REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_blk->size == 2);
			REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
			REQUIRE(p_tup->index((pChar) "value") == 1);
			REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_key->rank == 1);
			REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_val->rank == 1);
			REQUIRE((n_rows = p_key->size) == p_val->size);

			REQUIRE(n_rows == 5);

			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.get(p_txn, (pChar) "//https/connection/binblk") == SERVICE_ERROR_WRONG_BASE);
			REQUIRE(CHN.get(p_txn, (pChar) "//http/connection/cling") == SERVICE_ERROR_ENTITY_NOT_FOUND);

			REQUIRE(CHN.remove((pChar) "//http/connection/binblk") == SERVICE_NO_ERROR);

			REQUIRE(CHN.connect.size() == 2);

			strcpy(url, "//http/cap/Estonia");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_ERROR_BLOCK_NOT_FOUND);
			strcpy(url, "//http/cap/Malaysia");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Kuala Lumpur\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			strcpy((pChar) &p_tx_buf->p_block->tensor.cell_byte[0], "Tallinn");

			strcpy(url, "//http/cap/Estonia");
			REQUIRE(CHN.put(url, p_tx_buf->p_block, WRITE_AS_STRING) == SERVICE_NO_ERROR);

			strcpy(url, "//http/capitals/ESTONIA");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Tallinn\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.remove(url) == SERVICE_NO_ERROR);
			strcpy(url, "//http/cap/Estonia");
			REQUIRE(CHN.remove(url) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			REQUIRE(CHN.get(p_txn, (pChar) "//http/connection/capitals") == SERVICE_NO_ERROR);
			REQUIRE(p_txn != nullptr);

			p_blk = p_txn->p_block;

			REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_blk->size == 2);
			REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
			REQUIRE(p_tup->index((pChar) "value") == 1);
			REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_key->rank == 1);
			REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_val->rank == 1);
			REQUIRE((n_rows = p_key->size) == p_val->size);

			REQUIRE(n_rows == 1);

			REQUIRE(strcmp(p_key->get_string(0), "URL") == 0);
			REQUIRE(strcmp(p_val->get_string(0), "http://127.0.0.1:5000/test/capital/") == 0);

			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.remove((pChar) "//http/connection/capitals") == SERVICE_NO_ERROR);

			REQUIRE(CHN.connect.size() == 1);

			REQUIRE(CHN.remove((pChar) "//http/connection/capitals") == SERVICE_ERROR_ENTITY_NOT_FOUND);

			strcpy(url, "//http/cap/France");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Paris\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			strcpy(url, "//http/cap/Japan");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			REQUIRE(CHN.get(p_txn, (pChar) "//http/connection/cap") == SERVICE_NO_ERROR);
			REQUIRE(p_txn != nullptr);

			p_blk = p_txn->p_block;

			REQUIRE(p_blk->cell_type == CELL_TYPE_TUPLE_ITEM);
			REQUIRE(p_blk->size == 2);
			REQUIRE((p_tup = (pTuple) p_blk)->index((pChar) "key") == 0);
			REQUIRE(p_tup->index((pChar) "value") == 1);
			REQUIRE((p_key = p_tup->get_block(0))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_key->rank == 1);
			REQUIRE((p_val = p_tup->get_block(1))->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_val->rank == 1);
			REQUIRE((n_rows = p_key->size) == p_val->size);

			REQUIRE(n_rows == 1);

			REQUIRE(strcmp(p_key->get_string(0), "URL") == 0);
			REQUIRE(strcmp(p_val->get_string(0), "http://127.0.0.1:5000/test/capital/") == 0);

			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.remove((pChar) "//http/connection/cap") == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove((pChar) "//https/connection/cap") == SERVICE_ERROR_WRONG_BASE);

			REQUIRE(CHN.connect.size() == 0);
		}
		WHEN("We test forward_get()/forward_put()/forward_del()") {
			int ti = CHN.jazz_node_cluster_size++;

			CHN.jazz_node_name[ti] = "jzz_pybaby";
			CHN.jazz_node_port[ti] = 5000;
			CHN.jazz_node_ip  [ti] = "127.0.0.1";

			REQUIRE(CHN.forward_get(p_txn, (pChar) "jzz_pybaby", (pChar) "/test/str.blk") == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->check_hash());
			compare_full_blocks(p_txn->p_block, p_tx_str->p_block);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.forward_get(p_txn, (pChar) "jazz_pybaby", (pChar) "/test/str.blk") == SERVICE_ERROR_UNKNOWN_JAZZNODE);
			REQUIRE(CHN.forward_get(p_txn, (pChar) "jzz_pybaby", (pChar) "/test/str.blah") == SERVICE_ERROR_BLOCK_NOT_FOUND);

			REQUIRE(CHN.forward_get(p_txn, (pChar) "jzz_pybaby", (pChar) "/test/capital/Malaysia") == SERVICE_NO_ERROR);

			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Kuala Lumpur\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.forward_put((pChar) "jzz_pybaby", (pChar) "/test/str.blk", p_tx_tim->p_block) == SERVICE_NO_ERROR);
			REQUIRE(CHN.forward_put((pChar) "jzz_pybaby", (pChar) "/test/str.blah", p_tx_tim->p_block) == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.forward_put((pChar) "jazz_pybaby", (pChar) "/test/str.blk", p_tx_tim->p_block) == SERVICE_ERROR_UNKNOWN_JAZZNODE);

			strcpy((pChar) &p_tx_buf->p_block->tensor.cell_byte[0], "Montevideo");

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Uruguay");
			REQUIRE(CHN.put(url, p_tx_buf->p_block, WRITE_AS_STRING) == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"Montevideo\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.forward_del((pChar) "jzz_pybaby", (pChar) "/test/capital/Uruguay") == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, url) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			REQUIRE(CHN.forward_del((pChar) "jzz_pybaby", (pChar) "/test/capital/Uruguay") == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.forward_del((pChar) "jzz_pybaby", (pChar) "///") == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.forward_del((pChar) "jazz_pybaby", (pChar) "///") == SERVICE_ERROR_UNKNOWN_JAZZNODE);

			CHN.jazz_node_name.erase(ti);
			CHN.jazz_node_port.erase(ti);
			CHN.jazz_node_ip.erase(ti);

			CHN.jazz_node_cluster_size--;
		}
		WHEN("We check all the non applicable") {
			StaticBlockHeader hea;
			Locator loc;

			CHN.curl_ok = false;

			strcpy(url, "//http/http://127.0.0.1:5000/test/capital/Spain");
			REQUIRE(CHN.get(p_txn, url) == SERVICE_ERROR_BASE_FORBIDDEN);
			REQUIRE(CHN.put(url, p_tx_buf->p_block) == SERVICE_ERROR_BASE_FORBIDDEN);
			REQUIRE(CHN.remove(url) == SERVICE_ERROR_BASE_FORBIDDEN);

			int ti = CHN.jazz_node_cluster_size++;

			CHN.jazz_node_name[ti] = "jzz_pybaby";
			CHN.jazz_node_port[ti] = 5000;
			CHN.jazz_node_ip  [ti] = "127.0.0.1";

			REQUIRE(CHN.forward_get(p_txn, (pChar) "jzz_pybaby", (pChar) "/test/str.blk") == SERVICE_ERROR_BASE_FORBIDDEN);
			REQUIRE(CHN.forward_put((pChar) "jzz_pybaby", (pChar) "/test/str.blk", p_tx_tim->p_block) == SERVICE_ERROR_BASE_FORBIDDEN);
			REQUIRE(CHN.forward_del((pChar) "jzz_pybaby", (pChar) "/test/capital/Uruguay") == SERVICE_ERROR_BASE_FORBIDDEN);

			CHN.jazz_node_name.erase(ti);
			CHN.jazz_node_port.erase(ti);
			CHN.jazz_node_ip.erase(ti);

			CHN.jazz_node_cluster_size--;

			CHN.curl_ok = true;

			REQUIRE(CHN.locate(loc, (pChar) "//http/anything/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//http/anything/pop", (pChar) "value") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//http/anything/pop") == SERVICE_ERROR_NOT_APPLICABLE);
			REQUIRE(CHN.header(hea,   (pChar) "//http/anything/pop") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.locate(loc, (pChar) "//http/anything/int") == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.get(p_txn, (pChar) "//http/anything/int", p_tx_rea->p_block) == SERVICE_ERROR_NOT_APPLICABLE);

			REQUIRE(CHN.header(p_txn, (pChar) "//http/anything/int") == SERVICE_ERROR_NOT_APPLICABLE);
			REQUIRE(CHN.header(hea,   (pChar) "//http/anything/int") == SERVICE_ERROR_NOT_APPLICABLE);
		}
		WHEN("We test copy") {
			REQUIRE(CHN.connect.size() == 0);

			REQUIRE(CHN.put((pChar) "//http/connection/cap", p_tx_tp1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(CHN.connect.size() == 1);

			strcpy(url,  "//http/cap/UK");
			strcpy(url2, "//http/cap/England");
			REQUIRE(CHN.get(p_txn, url)  == SERVICE_ERROR_BLOCK_NOT_FOUND);
			REQUIRE(CHN.get(p_txn, url2) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			strcpy((pChar) &p_tx_buf->p_block->tensor.cell_byte[0], "London");

			REQUIRE(CHN.put(url, p_tx_buf->p_block, WRITE_AS_STRING) == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"London\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.get(p_txn, url2) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			REQUIRE(CHN.copy(url2, url) == SERVICE_NO_ERROR);

			REQUIRE(CHN.get(p_txn, url) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			REQUIRE(strcmp(p_txn->p_block->get_string(0), "\"London\"\n") == 0);
			CHN.destroy_transaction(p_txn);

			REQUIRE(CHN.get(p_txn, url2) == SERVICE_NO_ERROR);
			REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
			REQUIRE(p_txn->p_block->size == 1);
			CHN.destroy_transaction(p_txn);

			strcpy(url,  "//http/cap/Holland");
			strcpy(url2, "//http/cap/Netherlands");
			REQUIRE(CHN.copy(url, url2) == SERVICE_ERROR_BLOCK_NOT_FOUND);

			strcpy(url,  "//http/cap/UK");
			strcpy(url2, "//http/cap/England");
			REQUIRE(CHN.remove(url)  == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove(url2) == SERVICE_NO_ERROR);
			REQUIRE(CHN.remove((pChar) "//http/connection/cap") == SERVICE_NO_ERROR);

			REQUIRE(CHN.connect.size() == 0);
		}
		WHEN("We test modify") {
			Locator fun = {"http", "anything", "", 0};

			REQUIRE(CHN.modify(fun, (pTuple) p_tx_ix1->p_block) == SERVICE_ERROR_WRONG_ARGUMENTS);
			REQUIRE(CHN.modify(fun, (pTuple) p_tx_xlt->p_block) == SERVICE_ERROR_WRONG_BASE);
		}
		CHN.destroy_transaction(p_tx_ix1);
		CHN.destroy_transaction(p_tx_ix2);
		CHN.destroy_transaction(p_tx_tp1);
		CHN.destroy_transaction(p_tx_tp2);
		CHN.destroy_transaction(p_tx_str);
		CHN.destroy_transaction(p_tx_rea);
		CHN.destroy_transaction(p_tx_tim);
		CHN.destroy_transaction(p_tx_xlt);
		CHN.destroy_transaction(p_tx_buf);
	}
	REQUIRE(CHN.alloc_bytes == CHN.max_transactions*sizeof(StoredTransaction));
	REQUIRE(CHN.p_buffer != nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.can_curl == 1);
	REQUIRE(CHN.can_zmq  == 1);
	REQUIRE(CHN.can_bash == 1);
	REQUIRE(CHN.file_lev == 3);

	REQUIRE(CHN.curl_ok == 1);
	REQUIRE(CHN.zmq_ok	== 1);

	REQUIRE(CHN.pipes.size()   == 0);
	REQUIRE(CHN.connect.size() == 0);

	REQUIRE(CHN.zmq_context != nullptr);

	REQUIRE(CHN.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CHN.alloc_bytes == 0);
	REQUIRE(CHN.p_buffer == nullptr);
	REQUIRE(CHN.p_free	 == nullptr);
	REQUIRE(CHN._lock_	 == 0);

	REQUIRE(CHN.curl_ok == 0);
	REQUIRE(CHN.zmq_ok	== 0);

	REQUIRE(CHN.zmq_context == nullptr);
}
