/* Jazz (c) 2018-2021 kaalam.ai (The Authors of Jazz), using (under the same license):

	1. Biomodelling - The AATBlockQueue class (c) Jacques Basaldúa, 2009-2012 licensed
	  exclusively for the use in the Jazz server software.

	  Copyright 2009-2012 Jacques Basaldúa

	2. BBVA - Jazz: A lightweight analytical web server for data-driven applications.

      Copyright 2016-2017 Banco Bilbao Vizcaya Argentaria, S.A.

      This product includes software developed at

      BBVA (https://www.bbva.com/)

	3. LMDB, Copyright 2011-2017 Howard Chu, Symas Corp. All rights reserved.

	  Licensed under http://www.OpenLDAP.org/license.html


	  Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	  http://www.apache.org/licenses/LICENSE-2.0

	  Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/


using namespace jazz_elements;


// Instancing container, logger and config
// ---------------------------------------

ConfigFile	CONFIG(JAZZ_DEFAULT_CONFIG_PATH);
Logger		LOGGER(CONFIG, "LOGGER_PATH");
Container	CNT	  (&LOGGER, &CONFIG);


// Functions to support testing
// ----------------------------

class PseudoBuffer {
	public:

		inline void writer() {
			a[0] = (a[63]*16381 + 1) % 32749;
			for (int i = 1; i < 64; i++)
				a[i] = (a[i - 1]*16381 + 1) % 32749;

			b[0] = ((a[0] + b[63])*16381 + 3) % 32749;
			for (int i = 1; i < 64; i++)
				b[i] = (b[i - 1]*16381 + 1) % 32749;

			for (int i = 0; i < 64; i++)
				c[i] = a[i]*b[i];
		}

		inline int reader(int pid) {
			int i = pid % 64;

			return a[i]*b[i] - c[i];
		}

		Lock32 readers {0}, writers {0}, thread_errors {0}, reads_ok {0};

		int a[64] = {}, b[64] = {}, c[64] = {};
};

PseudoBuffer PSB;
Transaction  JBK;

static void *unsafe_reader(void *null) {
	PSB.readers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 100; k++){
		if (PSB.reader(k) == 0)
			PSB.reads_ok.fetch_add(1, std::memory_order_relaxed);
		else
			PSB.thread_errors.fetch_add(1, std::memory_order_relaxed);
	}

	return (void *) 0;
}

static void *unsafe_writer(void *null) {
	PSB.writers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 10; k++){
		PSB.writer();
	}

	return (void *) 0;
}

static void *safe_reader(void *null) {
	PSB.readers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 1000; k++){
		CNT.enter_read(&JBK);

		if (PSB.reader(k) == 0)
			PSB.reads_ok.fetch_add(1, std::memory_order_relaxed);
		else
			PSB.thread_errors.fetch_add(1, std::memory_order_relaxed);

		CNT.leave_read(&JBK);
	}

	return (void *) 0;
}

static void *safe_writer(void *null) {
	PSB.writers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 10; k++){
		CNT.enter_write(&JBK);

		PSB.writer();

		CNT.leave_write(&JBK);
	}

	return (void *) 0;
}

void check_and_finish(pBlock p_block, int set_has_NA = SET_HAS_NA_AUTO, bool set_hash = true, bool set_time = true)
{
	pStringBuffer psb = p_block->p_string_buffer();

	REQUIRE(p_block->total_bytes == sizeof(BlockHeader) +
									(uintptr_t) p_block->align_128bit((p_block->cell_type & 0xf)*p_block->size) +
									2*sizeof(int)*p_block->num_attributes +
									sizeof(StringBuffer) + psb->buffer_size);

	char *pt1 = (char *) &psb->buffer[psb->last_idx],
		 *pt2 = (char *) p_block + p_block->total_bytes;

	REQUIRE(pt2 > pt1);

	p_block->finish_creation(set_has_NA, set_hash, set_time);
}


void init_static_hea(StaticBlockHeader &hea, pBlock p_blk) {
	memcpy(&hea, p_blk, sizeof(StaticBlockHeader));

	p_blk->get_dimensions(& hea.range.dim[0]);
}

// Tests
// -----

SCENARIO("Testing (container) structure sizes.") {

	REQUIRE(sizeof(Name)			  == 32);
	REQUIRE(sizeof(Lock32)			  == 4);
	REQUIRE(sizeof(Transaction)		  == 32);
	REQUIRE(sizeof(StoredTransaction) == 48);
}


SCENARIO("Testing threading functions") {
	WHEN("We check basic assumptions, we get expected results") {
		REQUIRE(JBK._lock_ == 0);

		int lock = JBK._lock_.fetch_add(1, std::memory_order_relaxed);

		REQUIRE(lock == 0);
		REQUIRE(JBK._lock_ == 1);

		JBK._lock_ = 0;

		CNT.enter_read(&JBK);
		REQUIRE(JBK._lock_ == 1);

		CNT.enter_read(&JBK);
		REQUIRE(JBK._lock_ == 2);

		CNT.enter_read(&JBK);
		REQUIRE(JBK._lock_ == 3);

		CNT.leave_read(&JBK);
		REQUIRE(JBK._lock_ == 2);

		CNT.leave_read(&JBK);
		REQUIRE(JBK._lock_ == 1);

		CNT.leave_read(&JBK);
		REQUIRE(JBK._lock_ == 0);

		CNT.enter_write(&JBK);
		REQUIRE(JBK._lock_ == -LOCK_WEIGHT_OF_WRITE);

		CNT.leave_write(&JBK);
		REQUIRE(JBK._lock_ == 0);

		CNT.lock_container();
		REQUIRE(CNT._lock_ == 1);

		CNT.unlock_container();
		REQUIRE(CNT._lock_ == 0);
	}

	PSB.writer();

	for (int i = 0; i < 64; i++) {
		REQUIRE(PSB.reader(i) == 0);
	}

	WHEN("We run a 240x100 readers and 16x10 writers sequentially and no errors happen.") {
		for (int i = 0; i < 256; i++) {
			if ((i % 16) == 0)
				unsafe_writer(nullptr);
			else
				unsafe_reader(nullptr);
		}
		REQUIRE(PSB.writers == 16);
		REQUIRE(PSB.readers == 240);
		REQUIRE(PSB.reads_ok == 24000);
		REQUIRE(PSB.thread_errors == 0);
	}

// #define LONG_THREAD_TEST

#ifndef LONG_THREAD_TEST
	PSB.writers = PSB.readers = PSB.reads_ok = PSB.thread_errors = 0;

	WHEN("We run a short thread test. Define LONG_THREAD_TEST for the long test.") {
		bool failed = false;

		pthread_t th_id[32];
		for (int i = 0; i < 32; i++) {
			if ((i % 16) == 0) {
				if (pthread_create(&th_id[i], nullptr, safe_writer, nullptr) != 0) {
					failed = true;
					break;
				}
			} else {
				if (pthread_create(&th_id[i], nullptr, safe_reader, nullptr) != 0) {
					failed = true;
					break;
				}
			}
		}
		std::this_thread::yield();

		for (int i = 0; i < 32; i++) {
			if (pthread_join(th_id[i], nullptr) != 0){
				failed = true;
				break;
			}
		}

		REQUIRE(!failed);

		REQUIRE(PSB.writers == 2);
		REQUIRE(PSB.readers == 30);
		REQUIRE(PSB.reads_ok == 30000);
		REQUIRE(PSB.thread_errors == 0);
	}
#endif

#ifdef LONG_THREAD_TEST
	PSB.writers = PSB.readers = PSB.reads_ok = PSB.thread_errors = 0;

	const int num_threads = 256,
			  num_times	  = 64;

	WHEN("We run a 240x100 readers 16x10 writers in parallel num_times times without control, errors happen.") {
		bool failed = false;

		for (int times = 0; times < num_times; times++) {
			pthread_t th_id[num_threads];
			for (int i = 0; i < num_threads; i++) {
				if ((i % 16) == 0) {
					if (pthread_create(&th_id[i], nullptr, unsafe_writer, nullptr) != 0) {
						failed = true;
						break;
					}
				} else {
					if (pthread_create(&th_id[i], nullptr, unsafe_reader, nullptr) != 0) {
						failed = true;
						break;
					}
				}
			}
			std::this_thread::yield();

			for (int i = 0; i < num_threads; i++) {
				if (pthread_join(th_id[i], nullptr) != 0) {
					failed = true;
					break;
				}
			}
		}

		REQUIRE(!failed);

		REQUIRE(PSB.writers == 16*num_times);
		REQUIRE(PSB.readers == 240*num_times);
		REQUIRE(PSB.reads_ok < 24000*num_times);
		REQUIRE(PSB.thread_errors > 0);
	}

	PSB.writers = PSB.readers = PSB.reads_ok = PSB.thread_errors = 0;

	WHEN("We run a 240x1000 readers 16x10 writers in parallel num_times times with control and no errors happen.") {
		bool failed = false;

		for (int times = 0; times < num_times; times++) {
			pthread_t th_id[num_threads];
			for (int i = 0; i < num_threads; i++) {
				if ((i % 16) == 0) {
					if (pthread_create(&th_id[i], nullptr, safe_writer, nullptr) != 0) {
						failed = true;
						break;
					}
				} else {
					if (pthread_create(&th_id[i], nullptr, safe_reader, nullptr) != 0) {
						failed = true;
						break;
					}
				}

			}
			std::this_thread::yield();

			for (int i = 0; i < num_threads; i++) {
				if (pthread_join(th_id[i], nullptr) != 0){
					failed = true;
					break;
				}
			}
		}

		REQUIRE(!failed);

		REQUIRE(PSB.writers == 16*num_times);
		REQUIRE(PSB.readers == 240*num_times);
		REQUIRE(PSB.reads_ok == 240000*num_times);
		REQUIRE(PSB.thread_errors == 0);
	}
#endif
}


SCENARIO("Stress-testing new_transaction()/destroy_internal()") {
	pTransaction p_txn[20];

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	REQUIRE(CNT.destroy_container() == SERVICE_NO_ERROR);

	CNT.max_num_keepers  = 1024;
	CNT.warn_alloc_bytes = 4096;
	CNT.fail_alloc_bytes = 8192;
	REQUIRE(CNT.new_container() == SERVICE_ERROR_NO_MEM);

	CNT.max_num_keepers  = 16;
	REQUIRE(CNT.new_container() == SERVICE_NO_ERROR);

	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 != nullptr);

	REQUIRE(CNT.new_transaction(p_txn[0]) == SERVICE_NO_ERROR);
	REQUIRE(p_txn[0] != nullptr);

	REQUIRE(p_txn[0]->p_block == nullptr);
	REQUIRE(p_txn[0]->p_route == nullptr);
	REQUIRE(p_txn[0]->_lock_  == 0);
	REQUIRE(p_txn[0]->status  == BLOCK_STATUS_EMPTY);
	REQUIRE(p_txn[0]->p_owner == &CNT);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_alloc != nullptr);
	REQUIRE(CNT.p_free	!= nullptr);

	REQUIRE(!CNT.alloc_warning_issued);
	p_txn[0]->p_block = (pBlock) CNT.malloc(5000);
	REQUIRE(p_txn[0]->p_block != nullptr);
	p_txn[0]->p_block->total_bytes = 5000;
	REQUIRE(!CNT.alloc_warning_issued);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction) + 5000);

	LOGGER.SkipLogOnce = true;
	REQUIRE(CNT.new_transaction(p_txn[1]) == SERVICE_NO_ERROR);
	REQUIRE(!LOGGER.SkipLogOnce);

	REQUIRE(p_txn[1] != nullptr);
	REQUIRE(CNT.alloc_warning_issued);

	CNT.destroy_internal(p_txn[1]);
	CNT.destroy_internal(p_txn[0]);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_alloc == nullptr);
	REQUIRE(CNT.p_free	!= nullptr);

	REQUIRE(CNT.p_alloc == nullptr);
	REQUIRE(CNT.p_free	!= nullptr);
	REQUIRE(CNT.new_transaction(p_txn[0]) == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_alloc != nullptr);
	REQUIRE(CNT.p_free	!= nullptr);

	p_txn[0]->p_block = (pBlock) CNT.malloc(50000);
	REQUIRE(p_txn[0]->p_block == nullptr);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));

	CNT.destroy_internal(p_txn[0]);
	REQUIRE(p_txn[0] == nullptr);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_alloc == nullptr);
	REQUIRE(CNT.p_free	!= nullptr);

	for (int t = 1; t < 17; t++) {
		for (int i = 0; i < t; i++) {
			REQUIRE(CNT.new_transaction(p_txn[i]) == SERVICE_NO_ERROR);
			REQUIRE(p_txn[i] != nullptr);

			REQUIRE(p_txn[i]->p_block == nullptr);
			REQUIRE(p_txn[i]->p_route == nullptr);
			REQUIRE(p_txn[i]->_lock_  == 0);
			REQUIRE(p_txn[i]->status  == BLOCK_STATUS_EMPTY);
			REQUIRE(p_txn[i]->p_owner == &CNT);
		}
		if (t == 16)
			REQUIRE(CNT.p_free == nullptr);

		for (int i = 0; i < t; i++) {
			CNT.destroy_internal(p_txn[i]);
			REQUIRE(p_txn[i] == nullptr);
		}
		REQUIRE(CNT.p_alloc == nullptr);
		REQUIRE(CNT.p_free	!= nullptr);
	}

	for (int t = 1; t < 17; t++) {
		for (int i = 0; i < t; i++) {
			REQUIRE(CNT.new_transaction(p_txn[i]) == SERVICE_NO_ERROR);
			REQUIRE(p_txn[i] != nullptr);
		}
		if (t == 16)
			REQUIRE(CNT.p_free == nullptr);

		for (int i = t - 1; i >= 0; i--) {
			CNT.destroy_internal(p_txn[i]);
			REQUIRE(p_txn[i] == nullptr);
		}
		REQUIRE(CNT.p_alloc == nullptr);
		REQUIRE(CNT.p_free	!= nullptr);
	}

	for (int t = 3; t < 17; t++) {
		for (int i = 0; i < t; i++) {
			REQUIRE(CNT.new_transaction(p_txn[i]) == SERVICE_NO_ERROR);
			REQUIRE(p_txn[i] != nullptr);
		}
		if (t == 16)
			REQUIRE(CNT.p_free == nullptr);

		for (int i = t - 1; i >= 0; i--) {
			int j = 3 % t;

			while (p_txn[j] == nullptr)
				j = (j + 1) % t;

			CNT.destroy_internal(p_txn[j]);
			REQUIRE(p_txn[j] == nullptr);
		}
		REQUIRE(CNT.p_alloc == nullptr);
		REQUIRE(CNT.p_free	!= nullptr);
	}

	for (int i = 0; i < 16; i++) {
		REQUIRE(CNT.new_transaction(p_txn[i]) == SERVICE_NO_ERROR);
		REQUIRE(p_txn[i] != nullptr);
	}
	REQUIRE(CNT.p_free == nullptr);

	REQUIRE(CNT.new_transaction(p_txn[17]) == SERVICE_ERROR_NO_MEM);
	REQUIRE(CNT.p_free == nullptr);

	for (int i = 0; i < 16; i++) {
		CNT.destroy_internal(p_txn[i]);
		REQUIRE(p_txn[i] == nullptr);
	}
	REQUIRE(CNT.p_alloc == nullptr);
	REQUIRE(CNT.p_free	!= nullptr);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));

	TensorDim dim_t1 {{500, 10, 0}}, dim_t2 {{500, 1000, 0}};

	REQUIRE(CNT.new_block(p_txn[0], CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
	REQUIRE(p_txn[0] != nullptr);

	REQUIRE(CNT.new_block(p_txn[1], p_txn[0]->p_block, (pBlock) nullptr) == SERVICE_ERROR_NO_MEM);
	REQUIRE(p_txn[1] == nullptr);

	CNT.destroy(p_txn[0]);
	REQUIRE(p_txn[0] == nullptr);

	REQUIRE(CNT.new_block(p_txn[0], CELL_TYPE_BYTE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_ERROR_NO_MEM);
	REQUIRE(p_txn[0] == nullptr);

	for (int i = 0; i < 15; i++) {
		REQUIRE(CNT.new_transaction(p_txn[i]) == SERVICE_NO_ERROR);
		REQUIRE(p_txn[i] != nullptr);
	}
	REQUIRE(CNT.new_block(p_txn[15], CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
	REQUIRE(p_txn[15] != nullptr);

	REQUIRE(CNT.p_free == nullptr);

	REQUIRE(CNT.new_block(p_txn[16], CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_ERROR_NO_MEM);
	REQUIRE(p_txn[16] == nullptr);

	REQUIRE(CNT.new_block(p_txn[16], p_txn[15]->p_block, (pBlock) nullptr) == SERVICE_ERROR_NO_MEM);
	REQUIRE(p_txn[16] == nullptr);

	for (int i = 0; i < 16; i++) {
		CNT.destroy_internal(p_txn[i]);
		REQUIRE(p_txn[i] == nullptr);
	}
	REQUIRE(CNT.p_alloc == nullptr);
	REQUIRE(CNT.p_free	!= nullptr);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}


SCENARIO("Testing new_block() (1) Create a Tensor from raw data specifying everything from scratch.") {
	TensorDim dim_t1 {{7, 3, 5, 0}}, dim_t2 {{7, 2, 2, 2, 3, 2}}, dim_t3 {{97, 0}}, dim_t4 {{3, 2, 2, 0}};
	TensorDim dim_t5 {{120, 5, 4, 0}}, dim_t6 {{120, 0}}, dim_t7 {{7, 0}}, dim_read, dim_xx {{0}};

	pTransaction p_txn;

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	REQUIRE(CNT.new_transaction(p_txn) == SERVICE_NO_ERROR);
	REQUIRE(p_txn != nullptr);
	REQUIRE(p_txn->p_block == nullptr);
	REQUIRE(p_txn->status  == BLOCK_STATUS_EMPTY);
	REQUIRE(p_txn->_lock_  == 0);

	REQUIRE(CNT.p_alloc != nullptr);
	CNT.destroy_internal(p_txn);
	REQUIRE(CNT.p_alloc == nullptr);
	REQUIRE(p_txn		== nullptr);

	WHEN("I force all the possible error conditions, I get nullptr.") {
		char const *buffer	= "One Two Three Four Five Six Seven";
		char const *buffer6 = "One Two Three Four Five Six";
		bool filter[7];

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t1.dim, FILL_NEW_DONT_FILL, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t1.dim, FILL_NEW_WITH_ZERO, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t1.dim, FILL_NEW_WITH_NA, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t1.dim, FILL_BOOLEAN_FILTER, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t1.dim, FILL_INTEGER_FILTER, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t1.dim, FILL_WITH_TEXTFILE, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t1.dim, FILL_WITH_TEXTFILE, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BOOLEAN, dim_t1.dim, FILL_WITH_TEXTFILE, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_DOUBLE, dim_t1.dim, FILL_WITH_TEXTFILE, nullptr, 0, buffer)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_DOUBLE, nullptr) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 128, buffer, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);
		REQUIRE(p_txn->p_block != nullptr);
		REQUIRE(p_txn->status == BLOCK_STATUS_READY);
		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t7.dim, FILL_WITH_TEXTFILE, nullptr, 128, buffer, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);
		REQUIRE(p_txn->p_block != nullptr);
		REQUIRE(p_txn->status == BLOCK_STATUS_READY);
		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t7.dim, FILL_WITH_TEXTFILE, nullptr, 128, buffer6, ' ')
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, 0x201, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, 0x604, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, 0x308, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, 2, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t7.dim, FILL_BOOLEAN_FILTER, (bool *) &filter)
				== SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);
		REQUIRE(p_txn->p_block != nullptr);
		REQUIRE(p_txn->status == BLOCK_STATUS_READY);
		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t7.dim, FILL_BOOLEAN_FILTER, (bool *) &filter) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BOOLEAN, dim_t7.dim, FILL_BOOLEAN_FILTER, (bool *) &filter)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t7.dim, FILL_BOOLEAN_FILTER, (bool *) &filter)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t1.dim, FILL_BOOLEAN_FILTER, (bool *) &filter)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t7.dim, FILL_BOOLEAN_FILTER) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t7.dim, FILL_INTEGER_FILTER, (bool *) &filter) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);
		REQUIRE(p_txn->p_block != nullptr);
		REQUIRE(p_txn->status == BLOCK_STATUS_READY);
		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t7.dim, FILL_INTEGER_FILTER, (bool *) &filter) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BOOLEAN, dim_t7.dim, FILL_INTEGER_FILTER, (bool *) &filter)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t7.dim, FILL_INTEGER_FILTER, (bool *) &filter)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t1.dim, FILL_INTEGER_FILTER, (bool *) &filter) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t7.dim, FILL_INTEGER_FILTER) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t1.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);
		REQUIRE(p_txn->p_block != nullptr);
		REQUIRE(p_txn->status == BLOCK_STATUS_READY);
		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t1.dim, FILL_NEW_DONT_FILL - 1) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_INTEGER, dim_t1.dim, FILL_WITH_TEXTFILE + 1) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*7 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_byte[0] == 0);
		REQUIRE(p_txn->p_block->tensor.cell_byte[104] == 0);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*7 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE_BOOLEAN") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*7 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_byte[0]   == BYTE_BOOLEAN_NA);
		REQUIRE(p_txn->p_block->tensor.cell_byte[104] == BYTE_BOOLEAN_NA);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*7 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_INTEGER, CELL_TYPE_FACTOR & CELL_TYPE_GRADE") {
		const int cell_types[3] = {CELL_TYPE_INTEGER, CELL_TYPE_FACTOR, CELL_TYPE_GRADE};

		for (int i = 0; i < 3; i ++) {
			REQUIRE(CNT.new_block(p_txn, cell_types[i], dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
			REQUIRE(p_txn != nullptr);

			REQUIRE(p_txn->p_block->cell_type == cell_types[i]);
			REQUIRE(p_txn->p_block->rank == 3);

			memset(&dim_read, 1, sizeof(dim_read));

			p_txn->p_block->get_dimensions(dim_read.dim);

			REQUIRE(dim_read.dim[0] == 7);
			REQUIRE(dim_read.dim[1] == 3);
			REQUIRE(dim_read.dim[2] == 5);
			REQUIRE(dim_read.dim[3] == 0);
			REQUIRE(dim_read.dim[4] == 0);
			REQUIRE(dim_read.dim[5] == 0);

			REQUIRE(p_txn->p_block->size == 105);
			REQUIRE(p_txn->p_block->num_attributes == 1);
			REQUIRE(p_txn->p_block->total_bytes == 64 + 16*27 + 8 + 16);
			REQUIRE(p_txn->p_block->has_NA == true);
			REQUIRE(p_txn->p_block->tensor.cell_int[0]	== INTEGER_NA);
			REQUIRE(p_txn->p_block->tensor.cell_int[104] == INTEGER_NA);

			check_and_finish(p_txn->p_block);

			REQUIRE(p_txn != nullptr);

			REQUIRE(p_txn->p_block->has_NA == true);
			REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
			REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*27 + 8 + 16));

			REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
			REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
			REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

			CNT.destroy(p_txn);
			REQUIRE(p_txn == nullptr);
		}
	}

	GIVEN("A block of CELL_TYPE_BOOLEAN") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BOOLEAN, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BOOLEAN);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*27 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_int[0]	== BOOLEAN_NA);
		REQUIRE(p_txn->p_block->tensor.cell_int[104] == BOOLEAN_NA);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*27 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_SINGLE") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_SINGLE, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_SINGLE);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*27 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_uint[0]   == reinterpret_cast<u_int*>(&SINGLE_NA)[0]);
		REQUIRE(p_txn->p_block->tensor.cell_uint[104] == reinterpret_cast<u_int*>(&SINGLE_NA)[0]);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*27 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_STRING") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*27 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_uint[0]   == STRING_NA);
		REQUIRE(p_txn->p_block->tensor.cell_uint[104] == STRING_NA);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*27 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_LONG_INTEGER") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_LONG_INTEGER, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_LONG_INTEGER);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*53 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_longint[0]	== LONG_INTEGER_NA);
		REQUIRE(p_txn->p_block->tensor.cell_longint[104] == LONG_INTEGER_NA);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*53 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_TIME") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_TIME, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_TIME);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*53 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_longint[0]	== TIME_POINT_NA);
		REQUIRE(p_txn->p_block->tensor.cell_longint[104] == TIME_POINT_NA);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*53 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_DOUBLE") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_DOUBLE, dim_t1.dim, FILL_NEW_WITH_NA) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_DOUBLE);
		REQUIRE(p_txn->p_block->rank == 3);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 3);
		REQUIRE(dim_read.dim[2] == 5);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 105);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*53 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_ulongint[0]   == reinterpret_cast<uint64_t*>(&DOUBLE_NA)[0]);
		REQUIRE(p_txn->p_block->tensor.cell_ulongint[104] == reinterpret_cast<uint64_t*>(&DOUBLE_NA)[0]);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*53 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*21 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_byte[0]   == 0);
		REQUIRE(p_txn->p_block->tensor.cell_byte[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*21 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE_BOOLEAN") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*21 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_byte[0]   == 0);
		REQUIRE(p_txn->p_block->tensor.cell_byte[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*21 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_INTEGER, CELL_TYPE_FACTOR & CELL_TYPE_GRADE") {
		const int cell_types[3] = {CELL_TYPE_INTEGER, CELL_TYPE_FACTOR, CELL_TYPE_GRADE};

		for (int i = 0; i < 3; i ++) {
			REQUIRE(CNT.new_block(p_txn, cell_types[i], dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
			REQUIRE(p_txn != nullptr);

			REQUIRE(p_txn->p_block->cell_type == cell_types[i]);
			REQUIRE(p_txn->p_block->rank == 6);

			memset(&dim_read, 1, sizeof(dim_read));

			p_txn->p_block->get_dimensions(dim_read.dim);

			REQUIRE(dim_read.dim[0] == 7);
			REQUIRE(dim_read.dim[1] == 2);
			REQUIRE(dim_read.dim[2] == 2);
			REQUIRE(dim_read.dim[3] == 2);
			REQUIRE(dim_read.dim[4] == 3);
			REQUIRE(dim_read.dim[5] == 2);

			REQUIRE(p_txn->p_block->size == 336);
			REQUIRE(p_txn->p_block->num_attributes == 1);
			REQUIRE(p_txn->p_block->total_bytes == 64 + 16*84 + 8 + 16);
			REQUIRE(p_txn->p_block->has_NA == false);
			REQUIRE(p_txn->p_block->tensor.cell_int[0]	  == 0);
			REQUIRE(p_txn->p_block->tensor.cell_int[335] == 0);

			check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

			REQUIRE(p_txn != nullptr);

			REQUIRE(p_txn->p_block->has_NA == true);
			REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
			REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*84 + 8 + 16));

			REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
			REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
			REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

			CNT.destroy(p_txn);
			REQUIRE(p_txn == nullptr);
		}
	}

	GIVEN("A block of CELL_TYPE_BOOLEAN") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_BOOLEAN, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BOOLEAN);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*84 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_int[0]	  == 0);
		REQUIRE(p_txn->p_block->tensor.cell_int[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*84 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_SINGLE") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_SINGLE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_SINGLE);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*84 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_uint[0]   == 0);
		REQUIRE(p_txn->p_block->tensor.cell_uint[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*84 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_STRING") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*84 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_uint[0]   == 0);
		REQUIRE(p_txn->p_block->tensor.cell_uint[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*84 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_LONG_INTEGER") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_LONG_INTEGER, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_LONG_INTEGER);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*168 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_longint[0]	 == 0);
		REQUIRE(p_txn->p_block->tensor.cell_longint[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*168 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_TIME") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_TIME, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_TIME);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*168 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(p_txn->p_block->tensor.cell_longint[0]	 == 0);
		REQUIRE(p_txn->p_block->tensor.cell_longint[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*168 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_DOUBLE") {
		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_DOUBLE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_DOUBLE);
		REQUIRE(p_txn->p_block->rank == 6);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 7);
		REQUIRE(dim_read.dim[1] == 2);
		REQUIRE(dim_read.dim[2] == 2);
		REQUIRE(dim_read.dim[3] == 2);
		REQUIRE(dim_read.dim[4] == 3);
		REQUIRE(dim_read.dim[5] == 2);

		REQUIRE(p_txn->p_block->size == 336);
		REQUIRE(p_txn->p_block->num_attributes == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*168 + 8 + 16);
		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(p_txn->p_block->tensor.cell_ulongint[0]   == 0);
		REQUIRE(p_txn->p_block->tensor.cell_ulongint[335] == 0);

		check_and_finish(p_txn->p_block, SET_HAS_NA_TRUE);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*168 + 8 + 16));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) != nullptr);
		REQUIRE(strlen(p_txn->p_block->find_attribute(BLOCK_ATTRIB_EMPTY)) == 0);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	AttributeMap block_att;
	block_att [1357] = "Hello world!";
	block_att [468]	 = "Hi!";
	block_att [222]	 = "123.";

	GIVEN("A block of CELL_TYPE_BYTE") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_BYTE, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*7 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == false);

		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_byte[j] = j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*7 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE_BOOLEAN") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_BYTE_BOOLEAN, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*7 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_byte[j] = j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*7 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_INTEGER, CELL_TYPE_FACTOR & CELL_TYPE_GRADE") {
		const int cell_types[3] = {CELL_TYPE_INTEGER, CELL_TYPE_FACTOR, CELL_TYPE_GRADE};

		for (int i = 0; i < 3; i ++) {
			REQUIRE(   CNT.new_block(p_txn,  cell_types[i], dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
					== SERVICE_NO_ERROR);

			REQUIRE(p_txn != nullptr);

			REQUIRE(p_txn->p_block->cell_type == cell_types[i]);
			REQUIRE(p_txn->p_block->rank == 1);

			memset(&dim_read, 1, sizeof(dim_read));

			p_txn->p_block->get_dimensions(dim_read.dim);

			REQUIRE(dim_read.dim[0] == 97);
			REQUIRE(dim_read.dim[1] == 0);
			REQUIRE(dim_read.dim[2] == 0);
			REQUIRE(dim_read.dim[3] == 0);
			REQUIRE(dim_read.dim[4] == 0);
			REQUIRE(dim_read.dim[5] == 0);

			REQUIRE(p_txn->p_block->size == 97);
			REQUIRE(p_txn->p_block->num_attributes == 3);
			REQUIRE(p_txn->p_block->total_bytes == 64 + 16*25 + 8*3 + 16 + 22);
			REQUIRE(p_txn->p_block->has_NA == true);
			for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_int[j] = j;

			check_and_finish(p_txn->p_block);

			REQUIRE(p_txn != nullptr);

			REQUIRE(p_txn->p_block->has_NA == false);
			REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
			REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*25 + 8*3 + 16 + 22));

			REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
			REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
			REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
			REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
			REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
			REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
			REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

			CNT.destroy(p_txn);
			REQUIRE(p_txn == nullptr);
		}
	}

	GIVEN("A block of CELL_TYPE_BOOLEAN") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_BOOLEAN, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_BOOLEAN);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*25 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_int[j] = j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*25 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_SINGLE") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_SINGLE, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_SINGLE);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*25 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_single[j] = 0.123*j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*25 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	char const *monday = "Monday", *tuesday = "Tuesday", *nope = "";

	GIVEN("A block of CELL_TYPE_STRING") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 256, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*25 + 8*3 + 16 + 22 + 256);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) {
			switch (j % 3) {
			case 1:
				p_txn->p_block->set_string(j, monday);
				break;
			case 2:
				p_txn->p_block->set_string(j, tuesday);
				break;
			default:
				p_txn->p_block->set_string(j, nope);
				break;
			}
		}

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*25 + 8*3 + 16 + 22 + 256));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		REQUIRE(!strcmp(p_txn->p_block->get_string( 0), ""));
		REQUIRE(!strcmp(p_txn->p_block->get_string( 1), "Monday"));
		REQUIRE(!strcmp(p_txn->p_block->get_string( 2), "Tuesday"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(94), "Monday"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(95), "Tuesday"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(96), ""));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_LONG_INTEGER") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_LONG_INTEGER, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_LONG_INTEGER);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*49 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_longint[j] = j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*49 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_TIME") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_TIME, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_TIME);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*49 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_longint[j] = j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == true);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*49 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	GIVEN("A block of CELL_TYPE_DOUBLE") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_DOUBLE, dim_t3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &block_att)
				== SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_DOUBLE);
		REQUIRE(p_txn->p_block->rank == 1);

		memset(&dim_read, 1, sizeof(dim_read));

		p_txn->p_block->get_dimensions(dim_read.dim);

		REQUIRE(dim_read.dim[0] == 97);
		REQUIRE(dim_read.dim[1] == 0);
		REQUIRE(dim_read.dim[2] == 0);
		REQUIRE(dim_read.dim[3] == 0);
		REQUIRE(dim_read.dim[4] == 0);
		REQUIRE(dim_read.dim[5] == 0);

		REQUIRE(p_txn->p_block->size == 97);
		REQUIRE(p_txn->p_block->num_attributes == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*49 + 8*3 + 16 + 22);
		REQUIRE(p_txn->p_block->has_NA == true);
		for (int j = 0; j < 97; j++) p_txn->p_block->tensor.cell_double[j] = -0.1234567890123*j;

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);
		REQUIRE(elapsed_mu_sec(p_txn->p_block->created) < 3e6);
		REQUIRE(p_txn->p_block->hash64 == MurmurHash64A(&p_txn->p_block->tensor, 16*49 + 8*3 + 16 + 22));

		REQUIRE(p_txn->p_block->find_attribute(976555311) == nullptr);
		REQUIRE(p_txn->p_block->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(1357), "Hello world!"));
		REQUIRE(p_txn->p_block->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(222), "123."));
		REQUIRE(p_txn->p_block->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(p_txn->p_block->find_attribute(468), "Hi!"));

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	char const *text_file_0 = "",
			   *text_file_1 = "\n",
			   *text_file_2 = "\n\n\n",
			   *text_file_3 = "abc\ndef",
			   *text_file_4 = "abc\ndef\n",
			   *text_file_5 = "abc\ndef\n\n",
			   *text_file_6 = "This is a common\ntext file\n",
			   *text_file_7 = "\nThis is another\n\ncommon\ntext file.",
			   *text_file_8 = "January February March April May June July August September October November December",
			   *text_file_9 = "\n\n\nMon\n\nTue\nWed\n\n\n";

	GIVEN("A block of CELL_TYPE_STRING") {
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_NEW_DONT_FILL, nullptr, 0, text_file_0)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_NEW_WITH_ZERO, nullptr, 0, text_file_0)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_BOOLEAN_FILTER, nullptr, 0, text_file_0)
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_0) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 1);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == STRING_EMPTY);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 3);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "Q") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_1) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 1);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 1);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == STRING_EMPTY);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 3);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "#") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_2) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 3);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(2), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[2] == STRING_EMPTY);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 5);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "A") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_3) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 2);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 6 + 2);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), "abc"));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), "def"));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == 6);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 10);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "A") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_4) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 2);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 6 + 2);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), "abc"));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), "def"));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == 6);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 10);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "A") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_5) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 3);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 6 + 3);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), "abc"));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), "def"));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == 6);
		REQUIRE(!strcmp(p_txn->p_block->get_string(2), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[2] == STRING_EMPTY);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 11);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "A") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_6) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 2);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16 + 8 + 16 + 25 + 2);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), "This is a common"));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), "text file"));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == 19);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 29);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "A") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_7) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 5);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*2 + 8 + 16 + 31 + 5);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), "This is another"));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == 3);
		REQUIRE(!strcmp(p_txn->p_block->get_string(2), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[2] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(3), "common"));
		REQUIRE(p_txn->p_block->tensor.cell_int[3] == 20);
		REQUIRE(!strcmp(p_txn->p_block->get_string(4), "text file."));
		REQUIRE(p_txn->p_block->tensor.cell_int[4] == 27);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 38);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "S") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		dim_xx.dim[0] = 11;
		dim_xx.dim[1] = 0;
		dim_xx.dim[2] = 0;
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, dim_xx.dim, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ')
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		dim_xx.dim[0] = 13;
		dim_xx.dim[1] = 0;
		dim_xx.dim[2] = 0;
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, dim_xx.dim, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ')
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		dim_xx.dim[0] = 5;
		dim_xx.dim[1] = 2;
		dim_xx.dim[2] = 0;
		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, dim_xx.dim, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ')
				== SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_txn == nullptr);

		dim_xx.dim[0] = 6;
		dim_xx.dim[1] = 2;
		dim_xx.dim[2] = 0;

		REQUIRE(   CNT.new_block(p_txn, CELL_TYPE_STRING, dim_xx.dim, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ')
				== SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 2);

		REQUIRE(p_txn->p_block->size == 12);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*3 + 8 + 16 + 75 + 11);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0),  "January"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(1),  "February"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(2),  "March"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(3),  "April"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(4),  "May"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(5),  "June"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(6),  "July"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(7),  "August"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(8),  "September"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(9),  "October"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(10), "November"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(11), "December"));

		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "-") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);


		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, dim_t4.dim, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 3);

		REQUIRE(p_txn->p_block->size == 12);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*3 + 8 + 16 + 75 + 11);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0),  "January"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(1),  "February"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(2),  "March"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(3),  "April"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(4),  "May"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(5),  "June"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(6),  "July"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(7),  "August"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(8),  "September"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(9),  "October"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(10), "November"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(11), "December"));

		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "@") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ') == SERVICE_NO_ERROR);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 12);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*3 + 8 + 16 + 75 + 11);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0),  "January"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(1),  "February"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(2),  "March"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(3),  "April"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(4),  "May"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(5),  "June"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(6),  "July"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(7),  "August"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(8),  "September"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(9),  "October"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(10), "November"));
		REQUIRE(!strcmp(p_txn->p_block->get_string(11), "December"));

		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "T") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);

		REQUIRE(CNT.new_block(p_txn, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_9) == SERVICE_NO_ERROR);
		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_STRING);
		REQUIRE(p_txn->p_block->rank == 1);

		REQUIRE(p_txn->p_block->size == 9);
		REQUIRE(p_txn->p_block->total_bytes == 64 + 16*3 + 8 + 16 + 9 + 9);
		REQUIRE(p_txn->p_block->has_NA == false);

		check_and_finish(p_txn->p_block);

		REQUIRE(p_txn != nullptr);

		REQUIRE(p_txn->p_block->has_NA == false);

		REQUIRE(!strcmp(p_txn->p_block->get_string(0), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[0] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(1), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[1] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(2), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[2] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(3), "Mon"));
		REQUIRE(p_txn->p_block->tensor.cell_int[3] == 5);
		REQUIRE(!strcmp(p_txn->p_block->get_string(4), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[4] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(5), "Tue"));
		REQUIRE(p_txn->p_block->tensor.cell_int[5] == 10);
		REQUIRE(!strcmp(p_txn->p_block->get_string(6), "Wed"));
		REQUIRE(p_txn->p_block->tensor.cell_int[6] == 14);
		REQUIRE(!strcmp(p_txn->p_block->get_string(7), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[7] == STRING_EMPTY);
		REQUIRE(!strcmp(p_txn->p_block->get_string(8), ""));
		REQUIRE(p_txn->p_block->tensor.cell_int[8] == STRING_EMPTY);

		REQUIRE(p_txn->p_block->p_string_buffer()->last_idx == 20);
		REQUIRE(!p_txn->p_block->p_string_buffer()->alloc_failed);
		REQUIRE(p_txn->p_block->get_string_offset(p_txn->p_block->p_string_buffer(), "p") == STRING_NA);
		REQUIRE(p_txn->p_block->p_string_buffer()->alloc_failed);

		CNT.destroy(p_txn);
		REQUIRE(p_txn == nullptr);
	}

	bool filter_v_z[120], filter_v_1[120], filter_v_n[120];

	for (int i = 0; i < 120; i ++) {
		filter_v_z[i] = 0;
		filter_v_1[i] = true;
		filter_v_n[i] = (i % 7) == 2;
	}

	REQUIRE(CNT.new_block(p_txn, CELL_TYPE_DOUBLE, dim_t5.dim) == SERVICE_NO_ERROR);

	REQUIRE(p_txn != nullptr);

	REQUIRE(p_txn->p_block->cell_type == CELL_TYPE_DOUBLE);
	REQUIRE(p_txn->p_block->rank == 3);
	REQUIRE(p_txn->p_block->size == 2400);

	pTransaction p_filter_kpr;

	GIVEN("A filter of boolean") {
		REQUIRE(CNT.new_block(p_filter_kpr, CELL_TYPE_BYTE_BOOLEAN, dim_t6.dim, FILL_BOOLEAN_FILTER) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_filter_kpr == nullptr);

		REQUIRE(   CNT.new_block(p_filter_kpr, CELL_TYPE_BYTE_BOOLEAN, dim_t6.dim, FILL_BOOLEAN_FILTER, (bool *) &filter_v_n)
				== SERVICE_NO_ERROR);

		REQUIRE(p_filter_kpr != nullptr);

		REQUIRE(p_filter_kpr->p_block->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(p_filter_kpr->p_block->rank == 1);
		REQUIRE(p_filter_kpr->p_block->size == 120);
		REQUIRE(p_filter_kpr->p_block->num_attributes == 1);
		REQUIRE(p_filter_kpr->p_block->total_bytes == 64 + 16*8 + 8 + 16);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		for (int j = 0; j < 120; j++)
			REQUIRE(p_filter_kpr->p_block->tensor.cell_byte[j] == filter_v_n[j]);

		check_and_finish(p_filter_kpr->p_block);

		REQUIRE(p_filter_kpr->p_block != nullptr);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->filter_audit() == FILTER_TYPE_BOOLEAN);
		REQUIRE(p_filter_kpr->p_block->can_filter(p_txn->p_block));

		CNT.destroy(p_filter_kpr);
		REQUIRE(p_filter_kpr == nullptr);
	}

	GIVEN("Three filters of integer") {
		REQUIRE(CNT.new_block(p_filter_kpr, CELL_TYPE_INTEGER, dim_t6.dim, FILL_INTEGER_FILTER) == SERVICE_ERROR_NEW_BLOCK_ARGS);
		REQUIRE(p_filter_kpr == nullptr);

		REQUIRE(   CNT.new_block(p_filter_kpr, CELL_TYPE_INTEGER, dim_t6.dim, FILL_INTEGER_FILTER, (bool *) &filter_v_n)
				== SERVICE_NO_ERROR);

		REQUIRE(p_filter_kpr != nullptr);

		REQUIRE(p_filter_kpr->p_block->cell_type == CELL_TYPE_INTEGER);
		REQUIRE(p_filter_kpr->p_block->rank == 1);
		REQUIRE(p_filter_kpr->p_block->size == 120);
		REQUIRE(p_filter_kpr->p_block->num_attributes == 1);
		REQUIRE(p_filter_kpr->p_block->total_bytes == 64 + 16*30 + 8 + 16);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->range.filter.one == 1);
		REQUIRE(p_filter_kpr->p_block->range.filter.length == 17);
		for (int j = 0; j < p_filter_kpr->p_block->range.filter.length; j++)
			REQUIRE(p_filter_kpr->p_block->tensor.cell_int[j] == 7*j + 2);

		check_and_finish(p_filter_kpr->p_block);

		REQUIRE(p_filter_kpr->p_block != nullptr);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->filter_audit() == FILTER_TYPE_INTEGER);
		REQUIRE(p_filter_kpr->p_block->can_filter(p_txn->p_block));

		CNT.destroy(p_filter_kpr);
		REQUIRE(p_filter_kpr == nullptr);

		REQUIRE(CNT.new_block(p_filter_kpr, CELL_TYPE_INTEGER, dim_t6.dim, FILL_INTEGER_FILTER, (bool *) &filter_v_z) == SERVICE_NO_ERROR);
		REQUIRE(p_filter_kpr != nullptr);

		REQUIRE(p_filter_kpr->p_block->cell_type == CELL_TYPE_INTEGER);
		REQUIRE(p_filter_kpr->p_block->rank == 1);
		REQUIRE(p_filter_kpr->p_block->size == 120);
		REQUIRE(p_filter_kpr->p_block->num_attributes == 1);
		REQUIRE(p_filter_kpr->p_block->total_bytes == 64 + 16*30 + 8 + 16);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->range.filter.one == 1);
		REQUIRE(p_filter_kpr->p_block->range.filter.length == 0);

		check_and_finish(p_filter_kpr->p_block);

		REQUIRE(p_filter_kpr->p_block != nullptr);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->filter_audit() == FILTER_TYPE_INTEGER);
		REQUIRE(p_filter_kpr->p_block->can_filter(p_txn->p_block));

		CNT.destroy(p_filter_kpr);
		REQUIRE(p_filter_kpr == nullptr);

		REQUIRE(CNT.new_block(p_filter_kpr, CELL_TYPE_INTEGER, dim_t6.dim, FILL_INTEGER_FILTER, (bool *) &filter_v_1) == SERVICE_NO_ERROR);
		REQUIRE(p_filter_kpr != nullptr);

		REQUIRE(p_filter_kpr->p_block->cell_type == CELL_TYPE_INTEGER);
		REQUIRE(p_filter_kpr->p_block->rank == 1);
		REQUIRE(p_filter_kpr->p_block->size == 120);
		REQUIRE(p_filter_kpr->p_block->num_attributes == 1);
		REQUIRE(p_filter_kpr->p_block->total_bytes == 64 + 16*30 + 8 + 16);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->range.filter.one == 1);
		REQUIRE(p_filter_kpr->p_block->range.filter.length == 120);
		for (int j = 0; j < p_filter_kpr->p_block->range.filter.length; j++)
			REQUIRE(p_filter_kpr->p_block->tensor.cell_int[j] == j);

		check_and_finish(p_filter_kpr->p_block);

		REQUIRE(p_filter_kpr->p_block != nullptr);
		REQUIRE(p_filter_kpr->p_block->has_NA == false);
		REQUIRE(p_filter_kpr->p_block->filter_audit() == FILTER_TYPE_INTEGER);
		REQUIRE(p_filter_kpr->p_block->can_filter(p_txn->p_block));

		CNT.destroy(p_filter_kpr);
		REQUIRE(p_filter_kpr == nullptr);
	}

	CNT.destroy(p_txn);
	REQUIRE(p_txn == nullptr);

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT._lock_	 == 0);

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}


SCENARIO("Testing new_block() (2) Create a Kind or Tuple") {

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	GIVEN("We have 5 multiple purpose blocks") {
		pTransaction p_tx1, p_tx2, p_tx3, p_tx4, p_tx5;

		TensorDim dim_t1 {{27, 7, 3}}, dim_t2 {{3, 5, 4, 2, 0}}, dim_t3 {{10, 3, 0}}, dim_t4 {{2, 2, 3, 3, 1, 1}};

		REQUIRE(CNT.new_block(p_tx1, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx1 != nullptr);

		REQUIRE(CNT.new_block(p_tx2, CELL_TYPE_BYTE_BOOLEAN, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx2 != nullptr);

		REQUIRE(CNT.new_block(p_tx3, CELL_TYPE_TIME, dim_t3.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx3 != nullptr);

		struct tm junk = {0};
		struct tm *timeinfo = &junk;

		char buffer[20] = {"2021-08-01 12:13:14"};
		char fmt[20]	= {"%Y-%m-%d %H:%M:%S"};

		REQUIRE(strptime(buffer, fmt, timeinfo) != nullptr);

		REQUIRE(timeinfo->tm_mday == 1);

		for (int i = 0; i < 30; i++) {
			timeinfo->tm_mday =  1 + (3*i % 29);
			timeinfo->tm_hour =  7 + (5*i % 7);
			timeinfo->tm_min  = 13 + (7*i % 31);
			p_tx3->p_block->tensor.cell_time[i] = timegm(timeinfo);
		}

		REQUIRE(CNT.new_block(p_tx4, CELL_TYPE_SINGLE, dim_t4.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx4 != nullptr);

		char const *text_file = "January February March April May June July August September October November December";

		REQUIRE(CNT.new_block(p_tx5, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_tx5 != nullptr);

		WHEN("someone looks at it") {
			pTransaction p_tx_knd1, p_tx_knd2, p_tx_knd3;
			pTransaction p_tx_tup1, p_tx_tup2, p_tx_tup3;

			AttributeMap dims = {};
			dims [-1] = "color";
			AttributeMap att = {};
			att[BLOCK_ATTRIB_URL] = "who.knows.where";

			StaticBlockHeader p_hea1[5], p_hea2[5], p_hea3[5];
			pBlock			  p_blk1[5], p_blk2[5], p_blk3[5];

			Name p_names1[] = {"time", "text", "bool", "float"};
			Name p_names2[] = {"byte", "bool"};
			Name p_names3[] = {"time"};

			init_static_hea(p_hea1[0], p_blk1[0] = p_tx3->p_block);
			init_static_hea(p_hea1[1], p_blk1[1] = p_tx5->p_block);
			init_static_hea(p_hea1[2], p_blk1[2] = p_tx2->p_block);
			init_static_hea(p_hea1[3], p_blk1[3] = p_tx4->p_block);
			init_static_hea(p_hea2[0], p_blk2[0] = p_tx1->p_block);
			init_static_hea(p_hea2[1], p_blk2[1] = p_tx2->p_block);
			init_static_hea(p_hea3[0], p_blk3[0] = p_tx3->p_block);

			REQUIRE(CNT.new_block(p_tx_tup1, 4, p_hea1, p_names1, p_blk1, nullptr, nullptr) == SERVICE_NO_ERROR);
			REQUIRE(CNT.new_block(p_tx_tup2, 2, p_hea2, p_names2, p_blk2, nullptr, &att) == SERVICE_NO_ERROR);
			REQUIRE(CNT.new_block(p_tx_tup3, 1, p_hea3, p_names3, p_blk3, nullptr, &att) == SERVICE_NO_ERROR);

			REQUIRE(p_hea2[0].range.dim[0] == 27);
			REQUIRE(p_hea2[0].range.dim[1] ==  7);
			REQUIRE(p_hea2[0].range.dim[2] ==  3);
			p_hea2[0].range.dim[2] = -1;

			REQUIRE(p_hea2[1].range.dim[0] == 3);
			REQUIRE(p_hea2[1].range.dim[1] == 5);
			REQUIRE(p_hea2[1].range.dim[2] == 4);
			REQUIRE(p_hea2[1].range.dim[3] == 2);
			p_hea2[1].range.dim[0] = -1;

			REQUIRE(p_hea3[0].range.dim[0] == 10);
			REQUIRE(p_hea3[0].range.dim[1] ==  3);
			p_hea3[0].range.dim[1] = -1;

			REQUIRE(CNT.new_block(p_tx_knd1, 4, p_hea1, p_names1, nullptr, nullptr, nullptr) == SERVICE_NO_ERROR);
			REQUIRE(CNT.new_block(p_tx_knd2, 2, p_hea2, p_names2, nullptr, &dims, nullptr) == SERVICE_NO_ERROR);
			REQUIRE(CNT.new_block(p_tx_knd3, 1, p_hea3, p_names3, nullptr, &dims, &att) == SERVICE_NO_ERROR);

			THEN("it breaks") {
//TODO: add reqs here
				REQUIRE(2 > 1);
			}

			CNT.destroy_internal(p_tx_knd1);
			CNT.destroy_internal(p_tx_knd2);
			CNT.destroy_internal(p_tx_knd3);
			CNT.destroy_internal(p_tx_tup1);
			CNT.destroy_internal(p_tx_tup2);
			CNT.destroy_internal(p_tx_tup3);
		}

		CNT.destroy_internal(p_tx1);
		CNT.destroy_internal(p_tx2);
		CNT.destroy_internal(p_tx3);
		CNT.destroy_internal(p_tx4);
		CNT.destroy_internal(p_tx5);
	}

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT._lock_	 == 0);

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}



SCENARIO("Testing new_block() (3) Create a Tensor by selecting rows (filtering) from another Tensor.") {
	pTransaction p_db_r1, p_db_r3, p_db_r6, p_st_r1, p_st_r3, p_st_r6, p_by_r1, p_by_r3, p_by_r6;
	pTransaction p_if_r1, p_if_r3, p_if_r6, p_bf_r1, p_bf_r3, p_bf_r6;

	TensorDim dim_r1 {{107, 0}}, dim_r3 {{17, 9, 3, 0}}, dim_r6 {{2, 3, 2, 5, 2, 7}};

	AttributeMap old_str, new_str, no_str;

	old_str [256] = "Life's but a walking shadow";		// Both old_str and new_str have the same number of chars
	old_str [313] = "... a poor player";
	old_str [921] = "that struts and frets his hour";
	old_str [222] = "upon the stage and";
	old_str [321] = "then ...";

	new_str [921] = "is heard nomore ...";
	new_str [313] = "It's a tale..";
	new_str [358] = "told by an idiot..";
	new_str [222] = "full of sound and fury..";
	new_str [676] = "signifying ..";
	new_str [321] = "NULL";

	no_str [123] = (char *) nullptr;
	no_str [456] = "";

	const char *month[12] = {"January", "February", "March", "April", "May", "June", "July", "August",
							 "September", "October", "November", "December"};

	bool buff_1k[1024] = {false};

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	GIVEN("A set of 9 blocks of 3 types x 3 ranks") {
		REQUIRE(   CNT.new_block(p_db_r1, CELL_TYPE_DOUBLE, dim_r1.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &old_str)
				== SERVICE_NO_ERROR);

		REQUIRE(p_db_r1 != nullptr);
		REQUIRE(p_db_r1->p_block->size == 107);

		REQUIRE(   CNT.new_block(p_db_r3, CELL_TYPE_DOUBLE, dim_r3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n',  &no_str)
				== SERVICE_NO_ERROR);

		REQUIRE(p_db_r3 != nullptr);
		REQUIRE(p_db_r3->p_block->size == 459);

		REQUIRE(CNT.new_block(p_db_r6, CELL_TYPE_DOUBLE, dim_r6.dim) == SERVICE_NO_ERROR);

		REQUIRE(p_db_r6 != nullptr);
		REQUIRE(p_db_r6->p_block->size == 840);

		REQUIRE(   CNT.new_block(p_st_r1, CELL_TYPE_STRING, dim_r1.dim, FILL_NEW_DONT_FILL, nullptr, 256, nullptr, '\n', &no_str)
				== SERVICE_NO_ERROR);

		REQUIRE(p_st_r1 != nullptr);
		REQUIRE(p_st_r1->p_block->size == 107);

		REQUIRE(CNT.new_block(p_st_r3, CELL_TYPE_STRING, dim_r3.dim, FILL_NEW_DONT_FILL, nullptr, 256) == SERVICE_NO_ERROR);

		REQUIRE(p_st_r3 != nullptr);
		REQUIRE(p_st_r3->p_block->size == 459);

		REQUIRE(   CNT.new_block(p_st_r6, CELL_TYPE_STRING, dim_r6.dim, FILL_NEW_DONT_FILL, nullptr, 256, nullptr, '\n', &old_str)
				== SERVICE_NO_ERROR);

		REQUIRE(p_st_r6 != nullptr);
		REQUIRE(p_st_r6->p_block->size == 840);

		REQUIRE(CNT.new_block(p_by_r1, CELL_TYPE_BYTE, dim_r1.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);

		REQUIRE(p_by_r1 != nullptr);
		REQUIRE(p_by_r1->p_block->size == 107);

		REQUIRE(   CNT.new_block(p_by_r3, CELL_TYPE_BYTE, dim_r3.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &old_str)
				== SERVICE_NO_ERROR);

		REQUIRE(p_by_r3 != nullptr);
		REQUIRE(p_by_r3->p_block->size == 459);

		REQUIRE(   CNT.new_block(p_by_r6, CELL_TYPE_BYTE, dim_r6.dim, FILL_NEW_DONT_FILL, nullptr, 0, nullptr, '\n', &no_str)
				== SERVICE_NO_ERROR);

		REQUIRE(p_by_r6 != nullptr);
		REQUIRE(p_by_r6->p_block->size == 840);

		int index[6];

		for (int i = 0; i < 107; i++) {
			index[0] = i;

			p_db_r1->p_block->tensor.cell_double[p_db_r1->p_block->get_offset((int *) &index)] = i/10.0;
			p_by_r1->p_block->tensor.cell_byte  [p_by_r1->p_block->get_offset((int *) &index)] = 7 + 2*i;

			p_st_r1->p_block->set_string((int *) &index, month[i % 12]);
		}

		REQUIRE(p_db_r1->p_block->tensor.cell_double[33] == 3.3);
		REQUIRE(p_by_r1->p_block->tensor.cell_byte  [33] == 73);
		REQUIRE(!strcmp(p_st_r1->p_block->get_string(15), "April"));
		REQUIRE(!p_st_r1->p_block->p_string_buffer()->alloc_failed);

		check_and_finish(p_db_r1->p_block);
		check_and_finish(p_st_r1->p_block);
		check_and_finish(p_by_r1->p_block);

		for (int i = 0; i < 17; i++) {
			for (int j = 0; j < 9; j++) {
				for (int k = 0; k < 3; k++) {
					index[0] = i;
					index[1] = j;
					index[2] = k;

					p_db_r3->p_block->tensor.cell_double[p_db_r3->p_block->get_offset((int *) &index)] = 1e6*i + 1e3*j + k;
					p_by_r3->p_block->tensor.cell_byte  [p_by_r3->p_block->get_offset((int *) &index)] = 7*i + 5*j + 3*k;

					p_st_r3->p_block->set_string((int *) &index, month[(7*i + 5*j + 3*k) % 12]);
				}
			}
		}

		REQUIRE(p_db_r3->p_block->tensor.cell_double[334] == 12003001.0);
		REQUIRE(p_by_r3->p_block->tensor.cell_byte  [334] == 102);
		REQUIRE(!strcmp(p_st_r3->p_block->get_string(334), "July"));
		REQUIRE(!p_st_r3->p_block->p_string_buffer()->alloc_failed);

		check_and_finish(p_db_r3->p_block);
		check_and_finish(p_st_r3->p_block);
		check_and_finish(p_by_r3->p_block);

		for (int i = 0; i < 2; i++) {
			for (int j = 0; j < 3; j++) {
				for (int k = 0; k < 2; k++) {
					for (int u = 0; u < 5; u++) {
						for (int v = 0; v < 2; v++) {
							for (int w = 0; w < 7; w++) {
								index[0] = i;
								index[1] = j;
								index[2] = k;
								index[3] = u;
								index[4] = v;
								index[5] = w;

								p_db_r6->p_block->tensor.cell_double[p_db_r6->p_block->get_offset((int *) &index)]
									= 1e8*i + 1e7*j + 1e6*k + 100*u + 11*v - w;
								p_by_r6->p_block->tensor.cell_byte  [p_by_r6->p_block->get_offset((int *) &index)]
									= 45*i + 34*j + 23*k + 12*u + 6*v + 3*w;

								p_st_r6->p_block->set_string((int *) &index, month[(45*i + 34*j + 23*k + 12*u + 6*v + 3*w) % 12]);
							}
						}
					}
				}
			}
		}

		REQUIRE(p_db_r6->p_block->tensor.cell_double[753] == 120000307.0);
		REQUIRE(p_by_r6->p_block->tensor.cell_byte  [753] == 167);
		REQUIRE(!strcmp(p_st_r6->p_block->get_string(753), "December"));
		REQUIRE(!p_st_r6->p_block->p_string_buffer()->alloc_failed);

		check_and_finish(p_db_r6->p_block);
		check_and_finish(p_st_r6->p_block);
		check_and_finish(p_by_r6->p_block);

		dim_r1.dim[1] = 0;
		dim_r3.dim[1] = 0;
		dim_r6.dim[1] = 0;

		REQUIRE(CNT.new_block(p_if_r1, CELL_TYPE_INTEGER, dim_r1.dim, FILL_INTEGER_FILTER, (bool *) &buff_1k) == SERVICE_NO_ERROR);

		REQUIRE(p_if_r1 != nullptr);
		REQUIRE(p_if_r1->p_block->can_filter(p_db_r1->p_block));
		REQUIRE(p_if_r1->p_block->can_filter(p_st_r1->p_block));
		REQUIRE(p_if_r1->p_block->can_filter(p_by_r1->p_block));

		REQUIRE(CNT.new_block(p_if_r3, CELL_TYPE_INTEGER, dim_r3.dim, FILL_INTEGER_FILTER, (bool *) &buff_1k) == SERVICE_NO_ERROR);

		REQUIRE(p_if_r3 != nullptr);
		REQUIRE(p_if_r3->p_block->can_filter(p_db_r3->p_block));
		REQUIRE(p_if_r3->p_block->can_filter(p_st_r3->p_block));
		REQUIRE(p_if_r3->p_block->can_filter(p_by_r3->p_block));

		REQUIRE(CNT.new_block(p_if_r6, CELL_TYPE_INTEGER, dim_r6.dim, FILL_INTEGER_FILTER, (bool *) &buff_1k) == SERVICE_NO_ERROR);

		REQUIRE(p_if_r6 != nullptr);
		REQUIRE(p_if_r6->p_block->can_filter(p_db_r6->p_block));
		REQUIRE(p_if_r6->p_block->can_filter(p_st_r6->p_block));
		REQUIRE(p_if_r6->p_block->can_filter(p_by_r6->p_block));

		REQUIRE(CNT.new_block(p_bf_r1, CELL_TYPE_BYTE_BOOLEAN, dim_r1.dim, FILL_BOOLEAN_FILTER, (bool *) &buff_1k) == SERVICE_NO_ERROR);

		REQUIRE(p_bf_r1 != nullptr);
		REQUIRE(p_bf_r1->p_block->can_filter(p_db_r1->p_block));
		REQUIRE(p_bf_r1->p_block->can_filter(p_st_r1->p_block));
		REQUIRE(p_bf_r1->p_block->can_filter(p_by_r1->p_block));

		REQUIRE(CNT.new_block(p_bf_r3, CELL_TYPE_BYTE_BOOLEAN, dim_r3.dim, FILL_BOOLEAN_FILTER, (bool *) &buff_1k) == SERVICE_NO_ERROR);

		REQUIRE(p_bf_r3 != nullptr);
		REQUIRE(p_bf_r3->p_block->can_filter(p_db_r3->p_block));
		REQUIRE(p_bf_r3->p_block->can_filter(p_st_r3->p_block));
		REQUIRE(p_bf_r3->p_block->can_filter(p_by_r3->p_block));

		REQUIRE(CNT.new_block(p_bf_r6, CELL_TYPE_BYTE_BOOLEAN, dim_r6.dim, FILL_BOOLEAN_FILTER, (bool *) &buff_1k) == SERVICE_NO_ERROR);

		REQUIRE(p_bf_r6 != nullptr);
		REQUIRE(p_bf_r6->p_block->can_filter(p_db_r6->p_block));
		REQUIRE(p_bf_r6->p_block->can_filter(p_st_r6->p_block));
		REQUIRE(p_bf_r6->p_block->can_filter(p_by_r6->p_block));

		WHEN("I give wrong arguments, I get nullptr.") {
			pTransaction pcp;

			REQUIRE(CNT.new_block(pcp, (pBlock) nullptr, (pBlock) nullptr) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, p_bf_r3->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, p_bf_r6->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, p_if_r3->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, p_if_r6->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, p_bf_r1->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, p_bf_r6->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, p_if_r1->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, p_if_r6->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, p_bf_r1->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, p_bf_r3->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, p_if_r1->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, p_if_r3->p_block) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			AttributeMap all_att {};

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_db_r1->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_by_r3->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);

			REQUIRE(CNT.new_block(pcp, p_st_r6->p_block, (pBlock) nullptr, &all_att) == SERVICE_ERROR_NEW_BLOCK_ARGS);
			REQUIRE(pcp == nullptr);
		}

		WHEN("I create identical blocks") {
			pTransaction pcp_db_r1, pcp_db_r3, pcp_db_r6, pcp_st_r1, pcp_st_r3, pcp_st_r6, pcp_by_r1, pcp_by_r3, pcp_by_r6;

			REQUIRE(CNT.new_block(pcp_db_r1, p_db_r1->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_db_r1 != nullptr);
			REQUIRE(pcp_db_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(pcp_db_r3, p_db_r3->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_db_r3 != nullptr);
			REQUIRE(pcp_db_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(pcp_db_r6, p_db_r6->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_db_r6 != nullptr);
			REQUIRE(pcp_db_r6->p_block->size == 840);

			REQUIRE(CNT.new_block(pcp_st_r1, p_st_r1->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_st_r1 != nullptr);
			REQUIRE(pcp_st_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(pcp_st_r3, p_st_r3->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_st_r3 != nullptr);
			REQUIRE(pcp_st_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(pcp_st_r6, p_st_r6->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_st_r6 != nullptr);
			REQUIRE(pcp_st_r6->p_block->size == 840);

			REQUIRE(CNT.new_block(pcp_by_r1, p_by_r1->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_by_r1 != nullptr);
			REQUIRE(pcp_by_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(pcp_by_r3, p_by_r3->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_by_r3 != nullptr);
			REQUIRE(pcp_by_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(pcp_by_r6, p_by_r6->p_block, (pBlock) nullptr) == SERVICE_NO_ERROR);

			REQUIRE(pcp_by_r6 != nullptr);
			REQUIRE(pcp_by_r6->p_block->size == 840);

			THEN("Their structure is as expected.") {
				REQUIRE(pcp_db_r1->p_block->cell_type	 == p_db_r1->p_block->cell_type);
				REQUIRE(pcp_st_r6->p_block->cell_type	 == p_st_r6->p_block->cell_type);
				REQUIRE(pcp_by_r3->p_block->rank		 == p_by_r3->p_block->rank);
				REQUIRE(pcp_db_r1->p_block->rank		 == p_db_r1->p_block->rank);
				REQUIRE(pcp_st_r6->p_block->range.dim[0] == p_st_r6->p_block->range.dim[0]);

				REQUIRE(pcp_by_r3->p_block->range.dim[2]   == p_by_r3->p_block->range.dim[2]);
				REQUIRE(pcp_db_r1->p_block->range.dim[3]   == p_db_r1->p_block->range.dim[3]);
				REQUIRE(pcp_st_r6->p_block->size		   == p_st_r6->p_block->size);
				REQUIRE(pcp_by_r3->p_block->size		   == p_by_r3->p_block->size);
				REQUIRE(pcp_db_r1->p_block->num_attributes == p_db_r1->p_block->num_attributes);

				REQUIRE(pcp_st_r6->p_block->num_attributes == p_st_r6->p_block->num_attributes);
				REQUIRE(pcp_by_r3->p_block->total_bytes	   == p_by_r3->p_block->total_bytes);
				REQUIRE(pcp_db_r1->p_block->total_bytes	   == p_db_r1->p_block->total_bytes);
				REQUIRE(pcp_st_r6->p_block->has_NA		   == p_st_r6->p_block->has_NA);
				REQUIRE(pcp_by_r3->p_block->has_NA		   == p_by_r3->p_block->has_NA);

				REQUIRE(pcp_db_r1->p_block->has_NA				   == p_db_r1->p_block->has_NA);
				REQUIRE(pcp_st_r6->p_block->tensor.cell_int [67]   == p_st_r6->p_block->tensor.cell_int [67]);
				REQUIRE(pcp_by_r3->p_block->tensor.cell_byte[13]   == p_by_r3->p_block->tensor.cell_byte[13]);
				REQUIRE(pcp_db_r1->p_block->tensor.cell_double[33] == p_db_r1->p_block->tensor.cell_double[33]);
				REQUIRE(pcp_st_r6->p_block->tensor.cell_int[27]	   == p_st_r6->p_block->tensor.cell_int[27]);

				REQUIRE(pcp_by_r3->p_block->p_attribute_keys()[0]				  == p_by_r3->p_block->p_attribute_keys()[0]);
				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->stop_check_4_match == p_db_r1->p_block->p_string_buffer()->stop_check_4_match);
				REQUIRE(pcp_st_r6->p_block->p_attribute_keys()[0]				  == p_st_r6->p_block->p_attribute_keys()[0]);
				REQUIRE(pcp_by_r3->p_block->p_string_buffer()->alloc_failed		  == p_by_r3->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->last_idx			  == p_db_r1->p_block->p_string_buffer()->last_idx);

				REQUIRE(pcp_st_r6->p_block->p_string_buffer()->last_idx		== p_st_r6->p_block->p_string_buffer()->last_idx);
				REQUIRE(pcp_by_r3->p_block->p_string_buffer()->last_idx		== p_by_r3->p_block->p_string_buffer()->last_idx);
				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->buffer_size	== p_db_r1->p_block->p_string_buffer()->buffer_size);
				REQUIRE(pcp_st_r6->p_block->p_string_buffer()->buffer_size	== p_st_r6->p_block->p_string_buffer()->buffer_size);
				REQUIRE(pcp_by_r3->p_block->p_string_buffer()->buffer[3]	== p_by_r3->p_block->p_string_buffer()->buffer[3]);

				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->buffer[4]  == p_db_r1->p_block->p_string_buffer()->buffer[4]);
				REQUIRE(pcp_st_r6->p_block->p_string_buffer()->buffer[20] == p_st_r6->p_block->p_string_buffer()->buffer[20]);

				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(256), "Life's but a walking shadow"));
				REQUIRE(!strcmp(pcp_st_r6->p_block->find_attribute(313), "... a poor player"));
				REQUIRE(!strcmp(pcp_by_r3->p_block->find_attribute(921), "that struts and frets his hour"));
				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(222), "upon the stage and"));
				REQUIRE(!strcmp(pcp_st_r6->p_block->find_attribute(321), "then ..."));
				REQUIRE(pcp_by_r3->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) == nullptr);
				REQUIRE(pcp_db_r1->p_block->find_attribute(9999) == nullptr);
				REQUIRE(pcp_st_r6->p_block->find_attribute(486)	 == nullptr);
				REQUIRE(pcp_by_r3->p_block->find_attribute(487)	 == nullptr);

				REQUIRE(!strcmp(pcp_db_r3->p_block->find_attribute(123), ""));
				REQUIRE(!strcmp(pcp_st_r1->p_block->find_attribute(456), ""));
				REQUIRE(!strcmp(pcp_by_r6->p_block->find_attribute(123), ""));
				REQUIRE(pcp_db_r3->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) == nullptr);
				REQUIRE(pcp_st_r1->p_block->find_attribute(9999) == nullptr);
				REQUIRE(pcp_by_r6->p_block->find_attribute(487)  == nullptr);

				REQUIRE(!strcmp(pcp_db_r6->p_block->find_attribute(BLOCK_ATTRIB_EMPTY), ""));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(BLOCK_ATTRIB_EMPTY), ""));
				REQUIRE(!strcmp(pcp_by_r1->p_block->find_attribute(BLOCK_ATTRIB_EMPTY), ""));
				REQUIRE(pcp_db_r6->p_block->find_attribute(9999) == nullptr);
				REQUIRE(pcp_st_r3->p_block->find_attribute(9999) == nullptr);
				REQUIRE(pcp_by_r1->p_block->find_attribute(487)	 == nullptr);

				REQUIRE(pcp_db_r1->p_block->tensor.cell_double[33] == 3.3);
				REQUIRE(pcp_by_r1->p_block->tensor.cell_byte  [33] == 73);
				REQUIRE(!strcmp(pcp_st_r1->p_block->get_string(15), "April"));
				REQUIRE(!pcp_st_r1->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(pcp_db_r1->p_block);
				check_and_finish(pcp_st_r1->p_block);
				check_and_finish(pcp_by_r1->p_block);

				REQUIRE(pcp_db_r3->p_block->tensor.cell_double[334] == 12003001.0);
				REQUIRE(pcp_by_r3->p_block->tensor.cell_byte  [334] == 102);
				REQUIRE(!strcmp(pcp_st_r3->p_block->get_string(334), "July"));
				REQUIRE(!pcp_st_r3->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(pcp_db_r3->p_block);
				check_and_finish(pcp_st_r3->p_block);
				check_and_finish(pcp_by_r3->p_block);

				REQUIRE(pcp_db_r6->p_block->tensor.cell_double[753] == 120000307.0);
				REQUIRE(pcp_by_r6->p_block->tensor.cell_byte  [753] == 167);
				REQUIRE(!strcmp(pcp_st_r6->p_block->get_string(753), "December"));
				REQUIRE(!pcp_st_r6->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(pcp_db_r6->p_block);
				check_and_finish(pcp_st_r6->p_block);
				check_and_finish(pcp_by_r6->p_block);
			}

			CNT.destroy(pcp_db_r1);
			REQUIRE(pcp_db_r1 == nullptr);

			CNT.destroy(pcp_db_r3);
			REQUIRE(pcp_db_r3 == nullptr);

			CNT.destroy(pcp_db_r6);
			REQUIRE(pcp_db_r6 == nullptr);

			CNT.destroy(pcp_st_r1);
			REQUIRE(pcp_st_r1 == nullptr);

			CNT.destroy(pcp_st_r3);
			REQUIRE(pcp_st_r3 == nullptr);

			CNT.destroy(pcp_st_r6);
			REQUIRE(pcp_st_r6 == nullptr);

			CNT.destroy(pcp_by_r1);
			REQUIRE(pcp_by_r1 == nullptr);

			CNT.destroy(pcp_by_r3);
			REQUIRE(pcp_by_r3 == nullptr);

			CNT.destroy(pcp_by_r6);
			REQUIRE(pcp_by_r6 == nullptr);
		}

		WHEN("I create identical blocks with different attributes") {
			pTransaction pcp_db_r1, pcp_db_r3, pcp_db_r6, pcp_st_r1, pcp_st_r3, pcp_st_r6, pcp_by_r1, pcp_by_r3, pcp_by_r6;

			REQUIRE(CNT.new_block(pcp_db_r1, p_db_r1->p_block, (pBlock) nullptr, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_db_r1 != nullptr);
			REQUIRE(pcp_db_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(pcp_db_r3, p_db_r3->p_block, (pBlock) nullptr, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_db_r3 != nullptr);
			REQUIRE(pcp_db_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(pcp_db_r6, p_db_r6->p_block, (pBlock) nullptr, &no_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_db_r6 != nullptr);
			REQUIRE(pcp_db_r6->p_block->size == 840);

			REQUIRE(CNT.new_block(pcp_st_r1, p_st_r1->p_block, (pBlock) nullptr, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_st_r1 != nullptr);
			REQUIRE(pcp_st_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(pcp_st_r3, p_st_r3->p_block, (pBlock) nullptr, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_st_r3 != nullptr);
			REQUIRE(pcp_st_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(pcp_st_r6, p_st_r6->p_block, (pBlock) nullptr, &no_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_st_r6 != nullptr);
			REQUIRE(pcp_st_r6->p_block->size == 840);

			REQUIRE(CNT.new_block(pcp_by_r1, p_by_r1->p_block, (pBlock) nullptr, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_by_r1 != nullptr);
			REQUIRE(pcp_by_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(pcp_by_r3, p_by_r3->p_block, (pBlock) nullptr, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_by_r3 != nullptr);
			REQUIRE(pcp_by_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(pcp_by_r6, p_by_r6->p_block, (pBlock) nullptr, &no_str) == SERVICE_NO_ERROR);

			REQUIRE(pcp_by_r6 != nullptr);
			REQUIRE(pcp_by_r6->p_block->size == 840);

			THEN("Their structure is as expected.") {
				REQUIRE(pcp_db_r1->p_block->cell_type	 == p_db_r1->p_block->cell_type);
				REQUIRE(pcp_st_r6->p_block->cell_type	 == p_st_r6->p_block->cell_type);
				REQUIRE(pcp_by_r3->p_block->rank		 == p_by_r3->p_block->rank);
				REQUIRE(pcp_db_r1->p_block->rank		 == p_db_r1->p_block->rank);
				REQUIRE(pcp_st_r6->p_block->range.dim[0] == p_st_r6->p_block->range.dim[0]);

				REQUIRE(pcp_by_r3->p_block->range.dim[2]   == p_by_r3->p_block->range.dim[2]);
				REQUIRE(pcp_db_r1->p_block->range.dim[3]   == p_db_r1->p_block->range.dim[3]);
				REQUIRE(pcp_st_r6->p_block->size		   == p_st_r6->p_block->size);
				REQUIRE(pcp_by_r3->p_block->size		   == p_by_r3->p_block->size);
				REQUIRE(pcp_db_r1->p_block->num_attributes == 6);

				REQUIRE(pcp_st_r6->p_block->num_attributes == 2);
				REQUIRE(pcp_by_r3->p_block->total_bytes	   == p_by_r3->p_block->total_bytes);
				REQUIRE(pcp_db_r1->p_block->total_bytes	   == p_db_r1->p_block->total_bytes);	// Same number of chars in old and new
				REQUIRE(pcp_st_r6->p_block->has_NA		   == p_st_r6->p_block->has_NA);
				REQUIRE(pcp_by_r3->p_block->has_NA		   == p_by_r3->p_block->has_NA);

				REQUIRE(pcp_db_r1->p_block->has_NA				   == p_db_r1->p_block->has_NA);
				REQUIRE(pcp_st_r6->p_block->tensor.cell_int [67]   == p_st_r6->p_block->tensor.cell_int [67]);
				REQUIRE(pcp_by_r3->p_block->tensor.cell_byte[13]   == p_by_r3->p_block->tensor.cell_byte[13]);
				REQUIRE(pcp_db_r1->p_block->tensor.cell_double[33] == p_db_r1->p_block->tensor.cell_double[33]);
				REQUIRE(pcp_st_r6->p_block->tensor.cell_int[27]	   == p_st_r6->p_block->tensor.cell_int[27]);

				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->stop_check_4_match == p_db_r1->p_block->p_string_buffer()->stop_check_4_match);
				REQUIRE(pcp_by_r3->p_block->p_string_buffer()->alloc_failed		  == p_by_r3->p_block->p_string_buffer()->alloc_failed);

				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(pcp_st_r1->p_block->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(pcp_by_r1->p_block->find_attribute(358), "told by an idiot.."));
				REQUIRE(!strcmp(pcp_db_r3->p_block->find_attribute(222), "full of sound and fury.."));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(676), "signifying .."));
				REQUIRE(pcp_by_r3->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) == nullptr);
				REQUIRE(pcp_db_r1->p_block->find_attribute(9999) == nullptr);
				REQUIRE(pcp_st_r1->p_block->find_attribute(486)	 == nullptr);
				REQUIRE(pcp_by_r1->p_block->find_attribute(487)	 == nullptr);
				REQUIRE(!strcmp(pcp_db_r3->p_block->find_attribute(321), "NULL"));

				REQUIRE(!strcmp(pcp_st_r6->p_block->find_attribute(456), ""));
				REQUIRE(!strcmp(pcp_by_r6->p_block->find_attribute(123), ""));
				REQUIRE(pcp_db_r6->p_block->find_attribute(BLOCK_ATTRIB_EMPTY) == nullptr);
				REQUIRE(pcp_st_r6->p_block->find_attribute(9999) == nullptr);

				REQUIRE(pcp_db_r1->p_block->tensor.cell_double[33] == 3.3);
				REQUIRE(pcp_by_r1->p_block->tensor.cell_byte  [33] == 73);
				REQUIRE(!strcmp(pcp_st_r1->p_block->get_string(15), "April"));
				REQUIRE(!pcp_st_r1->p_block->p_string_buffer()->alloc_failed);

				// Not a string, from old_str to new_str:
				REQUIRE(pcp_db_r1->p_block->total_bytes					   == p_db_r1->p_block->total_bytes);
				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->buffer_size == p_db_r1->p_block->p_string_buffer()->buffer_size - 8);
				REQUIRE(pcp_db_r1->p_block->p_string_buffer()->last_idx	   == p_db_r1->p_block->p_string_buffer()->last_idx - 8);

				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(358), "told by an idiot.."));
				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(222), "full of sound and fury.."));
				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(676), "signifying .."));
				REQUIRE(!strcmp(pcp_db_r1->p_block->find_attribute(321), "NULL"));

				// Not a string, from nullptr to new_str:
				REQUIRE(pcp_by_r1->p_block->total_bytes					   == p_by_r1->p_block->total_bytes + 8*5 + 97);
				REQUIRE(pcp_by_r1->p_block->p_string_buffer()->buffer_size == pcp_db_r1->p_block->p_string_buffer()->buffer_size);
				REQUIRE(pcp_by_r1->p_block->p_string_buffer()->last_idx	   == pcp_db_r1->p_block->p_string_buffer()->last_idx);

				// String, from no_str to new_str:
				REQUIRE(pcp_st_r1->p_block->total_bytes	   == p_st_r1->p_block->total_bytes + 8*4 + 97);
				REQUIRE(pcp_st_r1->p_block->num_attributes == p_st_r1->p_block->num_attributes + 4);

				REQUIRE(pcp_st_r1->p_block->p_string_buffer()->buffer_size == p_st_r1->p_block->p_string_buffer()->buffer_size + 97);

				// String, from nullptr to new_str:
				REQUIRE(pcp_st_r3->p_block->total_bytes					   == p_st_r3->p_block->total_bytes + 8*5 + 97);
				REQUIRE(pcp_st_r3->p_block->p_string_buffer()->buffer_size == p_st_r3->p_block->p_string_buffer()->buffer_size + 97);

				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(358), "told by an idiot.."));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(222), "full of sound and fury.."));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(676), "signifying .."));
				REQUIRE(!strcmp(pcp_st_r3->p_block->find_attribute(321), "NULL"));

				// String, from old_str to no_str:
				REQUIRE(pcp_st_r6->p_block->total_bytes					   == p_st_r6->p_block->total_bytes - 8*3);
				REQUIRE(pcp_st_r6->p_block->p_string_buffer()->buffer_size == p_st_r6->p_block->p_string_buffer()->buffer_size);
				REQUIRE(pcp_st_r6->p_block->p_string_buffer()->last_idx	   == p_st_r6->p_block->p_string_buffer()->last_idx);
				REQUIRE(!strcmp(pcp_st_r6->p_block->find_attribute(456), ""));
				REQUIRE(!strcmp(pcp_st_r6->p_block->find_attribute(123), ""));
				REQUIRE(pcp_st_r6->p_block->find_attribute(654) == nullptr);

				for (int i = 0; i < 10; i++) {
					REQUIRE(pcp_st_r1->p_block->tensor.cell_int[i] == p_st_r1->p_block->tensor.cell_int[i]);
					REQUIRE(pcp_st_r3->p_block->tensor.cell_int[i] == p_st_r3->p_block->tensor.cell_int[i]);
					REQUIRE(pcp_st_r6->p_block->tensor.cell_int[i] == p_st_r6->p_block->tensor.cell_int[i]);
				}

				check_and_finish(pcp_db_r1->p_block);
				check_and_finish(pcp_st_r1->p_block);
				check_and_finish(pcp_by_r1->p_block);

				REQUIRE(pcp_db_r3->p_block->tensor.cell_double[334] == 12003001.0);
				REQUIRE(pcp_by_r3->p_block->tensor.cell_byte  [334] == 102);
				REQUIRE(!strcmp(pcp_st_r3->p_block->get_string(334), "July"));
				REQUIRE(!pcp_st_r3->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(pcp_db_r3->p_block);
				check_and_finish(pcp_st_r3->p_block);
				check_and_finish(pcp_by_r3->p_block);

				REQUIRE(pcp_db_r6->p_block->tensor.cell_double[753] == 120000307.0);
				REQUIRE(pcp_by_r6->p_block->tensor.cell_byte  [753] == 167);
				REQUIRE(!strcmp(pcp_st_r6->p_block->get_string(753), "December"));
				REQUIRE(!pcp_st_r6->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(pcp_db_r6->p_block);
				check_and_finish(pcp_st_r6->p_block);
				check_and_finish(pcp_by_r6->p_block);
			}

			CNT.destroy(pcp_db_r1);
			REQUIRE(pcp_db_r1 == nullptr);

			CNT.destroy(pcp_db_r3);
			REQUIRE(pcp_db_r3 == nullptr);

			CNT.destroy(pcp_db_r6);
			REQUIRE(pcp_db_r6 == nullptr);

			CNT.destroy(pcp_st_r1);
			REQUIRE(pcp_st_r1 == nullptr);

			CNT.destroy(pcp_st_r3);
			REQUIRE(pcp_st_r3 == nullptr);

			CNT.destroy(pcp_st_r6);
			REQUIRE(pcp_st_r6 == nullptr);

			CNT.destroy(pcp_by_r1);
			REQUIRE(pcp_by_r1 == nullptr);

			CNT.destroy(pcp_by_r3);
			REQUIRE(pcp_by_r3 == nullptr);

			CNT.destroy(pcp_by_r6);
			REQUIRE(pcp_by_r6 == nullptr);
		}

		WHEN("I filter with all combinations of blocks an filters") {
			pTransaction p_pa_db_r1, p_pa_db_r3, p_pa_db_r6, p_pa_st_r1, p_pa_st_r3, p_pa_st_r6, p_pa_by_r1, p_pa_by_r3, p_pa_by_r6,
						 p_pb_db_r1, p_pb_db_r3, p_pb_db_r6, p_pb_st_r1, p_pb_st_r3, p_pb_st_r6, p_pb_by_r1, p_pb_by_r3, p_pb_by_r6;

			// Select all elements with binary, correct, and integer fitting dimension properly
			for (int i = 0; i < p_if_r1->p_block->size; i++) {
				p_if_r1->p_block->tensor.cell_int[i]  = i;
				p_bf_r1->p_block->tensor.cell_bool[i] = true;
			}
			p_if_r1->p_block->range.filter.length = p_if_r1->p_block->size;

			for (int i = 0; i < p_if_r3->p_block->size; i++) {
				p_if_r3->p_block->tensor.cell_int[i]  = 0;
				p_bf_r3->p_block->tensor.cell_bool[i] = true;
			}
			p_if_r3->p_block->range.filter.length = p_if_r3->p_block->size;

			for (int i = 0; i < p_if_r6->p_block->size; i++) {
				p_if_r6->p_block->tensor.cell_int[i]  = -i;
				p_bf_r6->p_block->tensor.cell_bool[i] = true;
			}
			p_if_r6->p_block->range.filter.length = p_if_r6->p_block->size;

			REQUIRE(CNT.new_block(p_pa_db_r1, p_db_r1->p_block, p_if_r1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_db_r1 != nullptr);
			REQUIRE(p_pa_db_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(p_pa_db_r3, p_db_r3->p_block, p_if_r3->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_db_r3 != nullptr);
			REQUIRE(p_pa_db_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(p_pa_db_r6, p_db_r6->p_block, p_if_r6->p_block, &no_str) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_db_r6 != nullptr);
			REQUIRE(p_pa_db_r6->p_block->size == 840);

			REQUIRE(CNT.new_block(p_pa_st_r1, p_st_r1->p_block, p_bf_r1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_st_r1 != nullptr);
			REQUIRE(p_pa_st_r1->p_block->size == 107);

			REQUIRE(CNT.new_block(p_pa_st_r3, p_st_r3->p_block, p_bf_r3->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_st_r3 != nullptr);
			REQUIRE(p_pa_st_r3->p_block->size == 459);

			REQUIRE(CNT.new_block(p_pa_st_r6, p_st_r6->p_block, p_bf_r6->p_block, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_st_r6 != nullptr);
			REQUIRE(p_pa_st_r6->p_block->size == 840);

			// Select no elements with binary and integer
			for (int i = 0; i < p_if_r1->p_block->size; i++) {
				p_bf_r1->p_block->tensor.cell_bool[i] = false;
			}
			p_if_r1->p_block->range.filter.length = 0;

			for (int i = 0; i < p_if_r3->p_block->size; i++) {
				p_bf_r3->p_block->tensor.cell_bool[i] = false;
			}
			p_if_r3->p_block->range.filter.length = 0;

			for (int i = 0; i < p_if_r6->p_block->size; i++) {
				p_bf_r6->p_block->tensor.cell_bool[i] = false;
			}
			p_if_r6->p_block->range.filter.length = 0;

			REQUIRE(CNT.new_block(p_pa_by_r1, p_by_r1->p_block, p_if_r1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_by_r1 != nullptr);
			REQUIRE(p_pa_by_r1->p_block->size == 0);
			REQUIRE(p_pa_by_r1->p_block->rank == 1);

			REQUIRE(CNT.new_block(p_pa_by_r3, p_by_r3->p_block, p_if_r3->p_block, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_by_r3 != nullptr);
			REQUIRE(p_pa_by_r3->p_block->size == 0);
			REQUIRE(p_pa_by_r3->p_block->rank == 3);

			REQUIRE(CNT.new_block(p_pa_by_r6, p_by_r6->p_block, p_if_r6->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pa_by_r6 != nullptr);
			REQUIRE(p_pa_by_r6->p_block->size == 0);
			REQUIRE(p_pa_by_r6->p_block->rank == 6);

			REQUIRE(CNT.new_block(p_pb_db_r1, p_db_r1->p_block, p_bf_r1->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_db_r1 != nullptr);
			REQUIRE(p_pb_db_r1->p_block->size == 0);
			REQUIRE(p_pb_db_r1->p_block->rank == 1);

			REQUIRE(CNT.new_block(p_pb_db_r3, p_db_r3->p_block, p_bf_r3->p_block, &no_str) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_db_r3 != nullptr);
			REQUIRE(p_pb_db_r3->p_block->size == 0);
			REQUIRE(p_pb_db_r3->p_block->rank == 3);

			REQUIRE(CNT.new_block(p_pb_db_r6, p_db_r6->p_block, p_bf_r6->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_db_r6 != nullptr);
			REQUIRE(p_pb_db_r6->p_block->size == 0);
			REQUIRE(p_pb_db_r6->p_block->rank == 6);

			// Select some elements with binary and integer	 - dim_r1 {{107, 0}}, dim_r3 {{17, 9, 3, 0}}, dim_r6 {{2, 3, 2, 5, 2, 7}};
			for (int i = 0; i < p_if_r1->p_block->size; i++) {
				p_if_r1->p_block->tensor.cell_int[i]  = 3*i + 4;
				p_bf_r1->p_block->tensor.cell_bool[i] = i % 3 == 2;
			}
			p_if_r1->p_block->range.filter.length = 17;

			for (int i = 0; i < p_if_r3->p_block->size; i++) {
				p_if_r3->p_block->tensor.cell_int[i]  = i;
				p_bf_r3->p_block->tensor.cell_bool[i] = i % 4 == 2;
			}
			p_if_r3->p_block->range.filter.length = 7;

			for (int i = 0; i < p_if_r6->p_block->size; i++) {
				p_if_r6->p_block->tensor.cell_int[i]  = 1;
				p_bf_r6->p_block->tensor.cell_bool[i] = i == 0;
			}
			p_if_r6->p_block->range.filter.length = 1;

			REQUIRE(CNT.new_block(p_pb_st_r1, p_st_r1->p_block, p_if_r1->p_block, &no_str) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_st_r1 != nullptr);
			REQUIRE(p_pb_st_r1->p_block->size == 17);

			REQUIRE(CNT.new_block(p_pb_st_r3, p_st_r3->p_block, p_if_r3->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_st_r3 != nullptr);
			REQUIRE(p_pb_st_r3->p_block->size == 189);

			REQUIRE(CNT.new_block(p_pb_st_r6, p_st_r6->p_block, p_if_r6->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_st_r6 != nullptr);
			REQUIRE(p_pb_st_r6->p_block->size == 420);

			REQUIRE(CNT.new_block(p_pb_by_r1, p_by_r1->p_block, p_bf_r1->p_block, &new_str) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_by_r1 != nullptr);
			REQUIRE(p_pb_by_r1->p_block->size == 35);

			REQUIRE(CNT.new_block(p_pb_by_r3, p_by_r3->p_block, p_bf_r3->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_by_r3 != nullptr);
			REQUIRE(p_pb_by_r3->p_block->size == 108);

			REQUIRE(CNT.new_block(p_pb_by_r6, p_by_r6->p_block, p_bf_r6->p_block) == SERVICE_NO_ERROR);

			REQUIRE(p_pb_by_r6 != nullptr);
			REQUIRE(p_pb_by_r6->p_block->size == 420);

			THEN("Their structure is as expected.") {
				REQUIRE(p_pa_db_r1->p_block->cell_type	  == p_db_r1->p_block->cell_type);
				REQUIRE(p_pa_st_r6->p_block->cell_type	  == p_st_r6->p_block->cell_type);
				REQUIRE(p_pa_db_r3->p_block->rank		  == p_db_r3->p_block->rank);
				REQUIRE(p_pa_db_r1->p_block->rank		  == p_db_r1->p_block->rank);
				REQUIRE(p_pa_st_r6->p_block->range.dim[0] == p_st_r6->p_block->range.dim[0]);

				REQUIRE(p_pa_db_r3->p_block->range.dim[2]   == p_db_r3->p_block->range.dim[2]);
				REQUIRE(p_pa_st_r1->p_block->range.dim[3]   == p_st_r1->p_block->range.dim[3]);
				REQUIRE(p_pa_st_r6->p_block->size		    == p_st_r6->p_block->size);
				REQUIRE(p_pa_db_r3->p_block->size		    == p_db_r3->p_block->size);
				REQUIRE(p_pa_db_r1->p_block->num_attributes == p_db_r1->p_block->num_attributes);

				REQUIRE(p_pa_st_r6->p_block->num_attributes	== 6);
				REQUIRE(p_pa_st_r3->p_block->total_bytes	== p_st_r3->p_block->total_bytes);
				REQUIRE(p_pa_db_r1->p_block->total_bytes	== p_db_r1->p_block->total_bytes);
				REQUIRE(p_pa_st_r6->p_block->has_NA			== p_st_r6->p_block->has_NA);
				REQUIRE(p_pa_db_r3->p_block->has_NA			== p_db_r3->p_block->has_NA);

				REQUIRE(p_pa_db_r1->p_block->has_NA					== p_db_r1->p_block->has_NA);
				REQUIRE(p_pa_st_r6->p_block->tensor.cell_int [67]	== p_st_r6->p_block->tensor.cell_int [67]);
				REQUIRE(p_pa_db_r3->p_block->tensor.cell_byte[13]	== p_db_r3->p_block->tensor.cell_byte[13]);
				REQUIRE(p_pa_db_r1->p_block->tensor.cell_double[33]	== p_db_r1->p_block->tensor.cell_double[33]);
				REQUIRE(p_pa_st_r6->p_block->tensor.cell_int[27]	== p_st_r6->p_block->tensor.cell_int[27]);

				REQUIRE(p_pa_db_r3->p_block->p_attribute_keys()[0]				   == p_db_r3->p_block->p_attribute_keys()[0]);
				REQUIRE(p_pa_db_r1->p_block->p_string_buffer()->stop_check_4_match == p_db_r1->p_block->p_string_buffer()->stop_check_4_match);
				REQUIRE(p_pa_db_r1->p_block->p_string_buffer()->last_idx		   == p_db_r1->p_block->p_string_buffer()->last_idx);
				REQUIRE(p_pa_db_r3->p_block->p_string_buffer()->last_idx		   == p_db_r3->p_block->p_string_buffer()->last_idx);
				REQUIRE(p_pa_db_r1->p_block->p_string_buffer()->buffer_size		   == p_db_r1->p_block->p_string_buffer()->buffer_size);
				REQUIRE(p_pa_db_r3->p_block->p_string_buffer()->buffer[3]		   == p_db_r3->p_block->p_string_buffer()->buffer[3]);
				REQUIRE(p_pa_db_r1->p_block->p_string_buffer()->buffer[4]		   == p_db_r1->p_block->p_string_buffer()->buffer[4]);

				REQUIRE(!strcmp(p_pa_db_r1->p_block->find_attribute(256), "Life's but a walking shadow"));
				REQUIRE(!strcmp(p_pa_db_r3->p_block->find_attribute(123), ""));
				REQUIRE(!strcmp(p_pa_db_r6->p_block->find_attribute(456), ""));

				REQUIRE(p_pa_st_r1->p_block->find_attribute(9999) == nullptr);
				REQUIRE(!strcmp(p_pa_st_r3->p_block->find_attribute(BLOCK_ATTRIB_EMPTY), ""));

				REQUIRE(!strcmp(p_pa_st_r6->p_block->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(p_pa_st_r6->p_block->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(p_pa_st_r6->p_block->find_attribute(358), "told by an idiot.."));

				REQUIRE(p_pa_db_r1->p_block->tensor.cell_double[33] == 3.3);
				REQUIRE(!strcmp(p_pa_st_r1->p_block->get_string(15), "April"));
				REQUIRE(!p_pa_st_r1->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(p_pa_db_r1->p_block);
				check_and_finish(p_pa_st_r1->p_block);

				REQUIRE(p_pa_db_r3->p_block->tensor.cell_double[334] == 12003001.0);
				REQUIRE(!strcmp(p_pa_st_r3->p_block->get_string(334), "July"));
				REQUIRE(!p_pa_st_r3->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(p_pa_db_r3->p_block);
				check_and_finish(p_pa_st_r3->p_block);

				REQUIRE(p_pa_db_r6->p_block->tensor.cell_double[753] == 120000307.0);
				REQUIRE(!strcmp(p_pa_st_r6->p_block->get_string(753), "December"));
				REQUIRE(!p_pa_st_r6->p_block->p_string_buffer()->alloc_failed);

				check_and_finish(p_pa_db_r6->p_block);
				check_and_finish(p_pa_st_r6->p_block);

				int index[6];

				for (int i = 0; i < 107; i++) {
					index[0] = i;

					REQUIRE(p_pa_db_r1->p_block->tensor.cell_double[p_pa_db_r1->p_block->get_offset((int *) &index)] == i/10.0);

					REQUIRE(!strcmp(p_pa_st_r1->p_block->get_string((int *) &index), month[i % 12]));
					REQUIRE(   p_pa_st_r1->p_block->tensor.cell_int[p_pa_st_r1->p_block->get_offset((int *) &index)]
							== p_st_r1->p_block->tensor.cell_int[p_st_r1->p_block->get_offset((int *) &index)]);
				}

				for (int i = 0; i < 17; i++) {
					for (int j = 0; j < 9; j++) {
						for (int k = 0; k < 3; k++) {
							index[0] = i;
							index[1] = j;
							index[2] = k;

							REQUIRE(p_pa_db_r3->p_block->tensor.cell_double[p_pa_db_r3->p_block->get_offset((int *) &index)] == 1e6*i + 1e3*j + k);

							REQUIRE(!strcmp(p_pa_st_r3->p_block->get_string((int *) &index), month[(7*i + 5*j + 3*k) % 12]));
							REQUIRE(   p_pa_st_r3->p_block->tensor.cell_int[p_pa_st_r3->p_block->get_offset((int *) &index)]
									== p_st_r3->p_block->tensor.cell_int[p_st_r3->p_block->get_offset((int *) &index)]);
						}
					}
				}

				for (int i = 0; i < 2; i++) {
					for (int j = 0; j < 3; j++) {
						for (int k = 0; k < 2; k++) {
							for (int u = 0; u < 5; u++) {
								for (int v = 0; v < 2; v++) {
									for (int w = 0; w < 7; w++) {
										index[0] = i;
										index[1] = j;
										index[2] = k;
										index[3] = u;
										index[4] = v;
										index[5] = w;

										REQUIRE(   p_pa_db_r6->p_block->tensor.cell_double[p_pa_db_r6->p_block->get_offset((int *) &index)]
												== 1e8*i + 1e7*j + 1e6*k + 100*u + 11*v - w);

										REQUIRE(!strcmp(p_pa_st_r6->p_block->get_string((int *) &index),
														month[(45*i + 34*j + 23*k + 12*u + 6*v + 3*w) % 12]));
										REQUIRE(   p_pa_st_r6->p_block->tensor.cell_int[p_pa_st_r6->p_block->get_offset((int *) &index)]
												== p_st_r6->p_block->tensor.cell_int[p_st_r6->p_block->get_offset((int *) &index)]);
									}
								}
							}
						}
					}
				}

				REQUIRE(p_pa_by_r1->p_block->cell_type		== p_by_r1->p_block->cell_type);
				REQUIRE(p_pb_db_r6->p_block->cell_type		== p_db_r6->p_block->cell_type);
				REQUIRE(p_pa_by_r3->p_block->rank			== p_by_r3->p_block->rank);
				REQUIRE(p_pb_db_r1->p_block->rank			== p_db_r1->p_block->rank);
				REQUIRE(p_pa_by_r6->p_block->range.dim[0]	== p_by_r6->p_block->range.dim[0]);
				REQUIRE(p_pa_by_r3->p_block->range.dim[2]	== p_by_r3->p_block->range.dim[2]);
				REQUIRE(p_pb_db_r1->p_block->range.dim[3]	== p_db_r1->p_block->range.dim[3]);
				REQUIRE(p_pb_db_r6->p_block->size			== 0);
				REQUIRE(p_pa_by_r3->p_block->size			== 0);
				REQUIRE(p_pb_db_r1->p_block->num_attributes == p_db_r1->p_block->num_attributes);
				REQUIRE(p_pa_by_r6->p_block->num_attributes == p_by_r6->p_block->num_attributes);

				REQUIRE(   p_pa_by_r1->p_block->total_bytes
						== p_by_r1->p_block->total_bytes - (uintptr_t) p_pa_by_r1->p_block->align_128bit(p_by_r1->p_block->size));
				REQUIRE(   p_pa_by_r3->p_block->total_bytes
						== p_by_r3->p_block->total_bytes - (uintptr_t) p_pa_by_r3->p_block->align_128bit(p_by_r3->p_block->size));
				REQUIRE(   p_pa_by_r6->p_block->total_bytes
						== p_by_r6->p_block->total_bytes - (uintptr_t) p_pa_by_r6->p_block->align_128bit(p_by_r6->p_block->size));
				REQUIRE(   p_pb_db_r1->p_block->total_bytes
						== p_db_r1->p_block->total_bytes - (uintptr_t) p_pb_db_r1->p_block->align_128bit(8*p_db_r1->p_block->size));
				REQUIRE(   p_pb_db_r3->p_block->total_bytes
						== p_db_r3->p_block->total_bytes - (uintptr_t) p_pb_db_r3->p_block->align_128bit(8*p_db_r3->p_block->size));
				REQUIRE(   p_pb_db_r6->p_block->total_bytes
						== p_db_r6->p_block->total_bytes - (uintptr_t) p_pb_db_r6->p_block->align_128bit(8*p_db_r6->p_block->size));

				REQUIRE(!p_pa_by_r1->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pa_by_r3->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pa_by_r6->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_db_r1->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_db_r3->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_db_r6->p_block->p_string_buffer()->alloc_failed);

				REQUIRE(!strcmp(p_pb_db_r3->p_block->find_attribute(123), ""));
				REQUIRE(!strcmp(p_pb_db_r3->p_block->find_attribute(456), ""));

				REQUIRE(!strcmp(p_pa_by_r3->p_block->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(p_pa_by_r3->p_block->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(p_pa_by_r3->p_block->find_attribute(358), "told by an idiot.."));

				check_and_finish(p_pb_db_r1->p_block);
				check_and_finish(p_pa_by_r1->p_block);

				check_and_finish(p_pb_db_r3->p_block);
				check_and_finish(p_pa_by_r3->p_block);

				check_and_finish(p_pb_db_r6->p_block);
				check_and_finish(p_pa_by_r6->p_block);

				REQUIRE(p_pb_by_r1->p_block->cell_type == p_by_r1->p_block->cell_type);
				REQUIRE(p_pb_st_r6->p_block->cell_type == p_st_r6->p_block->cell_type);
				REQUIRE(p_pb_by_r3->p_block->rank	   == p_by_r3->p_block->rank);
				REQUIRE(p_pb_st_r1->p_block->rank	   == p_st_r1->p_block->rank);

				REQUIRE(p_pb_st_r6->p_block->range.dim[0] == p_st_r6->p_block->range.dim[0]);
				REQUIRE(p_pb_by_r3->p_block->range.dim[2] == p_by_r3->p_block->range.dim[2]);
				REQUIRE(p_pb_st_r1->p_block->range.dim[3] == p_st_r1->p_block->range.dim[3]);

				REQUIRE(p_pb_st_r1->p_block->num_attributes == 2);
				REQUIRE(p_pb_st_r3->p_block->num_attributes == p_st_r3->p_block->num_attributes);
				REQUIRE(p_pb_st_r6->p_block->num_attributes == p_st_r6->p_block->num_attributes);
				REQUIRE(p_pb_by_r1->p_block->num_attributes == 6);
				REQUIRE(p_pb_by_r3->p_block->num_attributes == p_by_r3->p_block->num_attributes);
				REQUIRE(p_pb_by_r6->p_block->num_attributes == p_by_r6->p_block->num_attributes);

				REQUIRE(p_pb_st_r1->p_block->total_bytes ==
						p_st_r1->p_block->total_bytes
						- (uintptr_t) p_pb_st_r1->p_block->align_128bit(4*(p_st_r1->p_block->size))
						+ (uintptr_t) p_pb_st_r1->p_block->align_128bit(4*(p_pb_st_r1->p_block->size)));
				REQUIRE(p_pb_st_r3->p_block->total_bytes ==
						p_st_r3->p_block->total_bytes
						- (uintptr_t) p_pb_st_r3->p_block->align_128bit(4*(p_st_r3->p_block->size))
						+ (uintptr_t) p_pb_st_r3->p_block->align_128bit(4*(p_pb_st_r3->p_block->size)));
				REQUIRE(p_pb_st_r6->p_block->total_bytes ==
						p_st_r6->p_block->total_bytes
						- (uintptr_t) p_pb_st_r6->p_block->align_128bit(4*(p_st_r6->p_block->size))
						+ (uintptr_t) p_pb_st_r6->p_block->align_128bit(4*(p_pb_st_r6->p_block->size)));
				REQUIRE(p_pb_by_r1->p_block->total_bytes ==
						p_by_r1->p_block->total_bytes + p_pb_by_r1->p_block->p_string_buffer()->buffer_size - 4 + 2*(6 -1)*sizeof(int)
						- (uintptr_t) p_pb_by_r1->p_block->align_128bit(p_by_r1->p_block->size)
						+ (uintptr_t) p_pb_by_r1->p_block->align_128bit(p_pb_by_r1->p_block->size));
				REQUIRE(p_pb_by_r3->p_block->total_bytes ==
						p_by_r3->p_block->total_bytes
						- (uintptr_t) p_pb_by_r3->p_block->align_128bit(p_by_r3->p_block->size)
						+ (uintptr_t) p_pb_by_r3->p_block->align_128bit(p_pb_by_r3->p_block->size));
				REQUIRE(p_pb_by_r6->p_block->total_bytes ==
						p_by_r6->p_block->total_bytes
						- (uintptr_t) p_pb_by_r6->p_block->align_128bit(p_by_r6->p_block->size)
						+ (uintptr_t) p_pb_by_r6->p_block->align_128bit(p_pb_by_r6->p_block->size));

				REQUIRE(!p_pb_by_r1->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_by_r3->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_by_r6->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_st_r1->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_st_r3->p_block->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_st_r6->p_block->p_string_buffer()->alloc_failed);

				REQUIRE(!strcmp(p_pb_st_r1->p_block->find_attribute(123), ""));
				REQUIRE(!strcmp(p_pb_st_r1->p_block->find_attribute(456), ""));

				REQUIRE(!strcmp(p_pb_by_r1->p_block->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(p_pb_by_r1->p_block->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(p_pb_by_r1->p_block->find_attribute(358), "told by an idiot.."));

				check_and_finish(p_pb_st_r1->p_block);
				check_and_finish(p_pb_by_r1->p_block);

				check_and_finish(p_pb_st_r3->p_block);
				check_and_finish(p_pb_by_r3->p_block);

				check_and_finish(p_pb_st_r6->p_block);
				check_and_finish(p_pb_by_r6->p_block);

				int index_o[6];
				int i_i = 0, i_b = 0;

				for (int i_o = 0; i_o < 107; i_o++) {
					if (p_bf_r1->p_block->tensor.cell_bool[i_o]) {
						index[0] = i_b;

						REQUIRE(p_pb_by_r1->p_block->tensor.cell_byte[p_pb_by_r1->p_block->get_offset((int *) &index)] == 7 + 2*i_o);

						i_b++;
					}
					if (i_i < p_if_r1->p_block->range.filter.length && p_if_r1->p_block->tensor.cell_int[i_i] == i_o) {
						index[0]   = i_i;
						index_o[0] = i_o;

						REQUIRE(!strcmp(p_pb_st_r1->p_block->get_string((int *) &index), month[i_o % 12]));
						REQUIRE(p_pb_st_r1->p_block->tensor.cell_int[p_pb_st_r1->p_block->get_offset((int *) &index)] ==
								p_st_r1->p_block->tensor.cell_int[p_st_r1->p_block->get_offset((int *) &index_o)]);

						i_i++;
					}
				}

				i_i = 0, i_b = 0;
				for (int i_o = 0; i_o < 17; i_o++) {
					index_o[0] = i_o;
					if (p_bf_r3->p_block->tensor.cell_bool[i_o]) {
						index[0] = i_b;

						for (int j = 0; j < 9; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 3; k++) {
								index[2] = index_o[2] = k;

								REQUIRE(   p_pb_by_r3->p_block->tensor.cell_byte[p_pb_by_r3->p_block->get_offset((int *) &index)]
										== 7*i_o + 5*j + 3*k);
							}
						}

						i_b++;
					}
					if (i_i < p_if_r3->p_block->range.filter.length && p_if_r3->p_block->tensor.cell_int[i_i] == i_o) {
						index[0] = i_i;

						for (int j = 0; j < 9; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 3; k++) {
								index[2] = index_o[2] = k;

								REQUIRE(!strcmp(p_pb_st_r3->p_block->get_string((int *) &index), month[(7*i_o + 5*j + 3*k) % 12]));
								REQUIRE(   p_pb_st_r3->p_block->tensor.cell_int[p_pb_st_r3->p_block->get_offset((int *) &index)]
										== p_st_r3->p_block->tensor.cell_int[p_st_r3->p_block->get_offset((int *) &index_o)]);
							}
						}

						i_i++;
					}
				}

				i_i = 0, i_b = 0;
				for (int i_o = 0; i_o < 2; i_o++) {
					index_o[0] = i_o;
					if (p_bf_r6->p_block->tensor.cell_bool[i_o]) {
						index[0] = i_b;

						for (int j = 0; j < 3; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 2; k++) {
								index[2] = index_o[2] = k;
								for (int u = 0; u < 5; u++) {
									index[3] = index_o[3] = u;
									for (int v = 0; v < 2; v++) {
										index[4] = index_o[4] = v;
										for (int w = 0; w < 7; w++) {
											index[5] = index_o[5] = w;

											REQUIRE(   p_pb_by_r6->p_block->tensor.cell_byte[p_pb_by_r6->p_block->get_offset((int *) &index)]
													== 45*i_o + 34*j + 23*k + 12*u + 6*v + 3*w);
										}
									}
								}
							}
						}

						i_b++;
					}
					if (i_i < p_if_r6->p_block->range.filter.length && p_if_r6->p_block->tensor.cell_int[i_i] == i_o) {
						index[0] = i_i;

						for (int j = 0; j < 3; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 2; k++) {
								index[2] = index_o[2] = k;
								for (int u = 0; u < 5; u++) {
									index[3] = index_o[3] = u;
									for (int v = 0; v < 2; v++) {
										index[4] = index_o[4] = v;
										for (int w = 0; w < 7; w++) {
											index[5] = index_o[5] = w;

											REQUIRE(!strcmp(p_pb_st_r6->p_block->get_string((int *) &index),
															month[(45*i_o + 34*j + 23*k + 12*u + 6*v + 3*w) % 12]));
											REQUIRE(   p_pb_st_r6->p_block->tensor.cell_int[p_pb_st_r6->p_block->get_offset((int *) &index)]
													== p_st_r6->p_block->tensor.cell_int[p_st_r6->p_block->get_offset((int *) &index_o)]);
										}
									}
								}
							}
						}
						i_i++;
					}
				}
			}

			CNT.destroy(p_pa_db_r1);
			REQUIRE(p_pa_db_r1 == nullptr);

			CNT.destroy(p_pa_db_r3);
			REQUIRE(p_pa_db_r3 == nullptr);

			CNT.destroy(p_pa_db_r6);
			REQUIRE(p_pa_db_r6 == nullptr);

			CNT.destroy(p_pa_st_r1);
			REQUIRE(p_pa_st_r1 == nullptr);

			CNT.destroy(p_pa_st_r3);
			REQUIRE(p_pa_st_r3 == nullptr);

			CNT.destroy(p_pa_st_r6);
			REQUIRE(p_pa_st_r6 == nullptr);

			CNT.destroy(p_pa_by_r1);
			REQUIRE(p_pa_by_r1 == nullptr);

			CNT.destroy(p_pa_by_r3);
			REQUIRE(p_pa_by_r3 == nullptr);

			CNT.destroy(p_pa_by_r6);
			REQUIRE(p_pa_by_r6 == nullptr);

			CNT.destroy(p_pb_db_r1);
			REQUIRE(p_pb_db_r1 == nullptr);

			CNT.destroy(p_pb_db_r3);
			REQUIRE(p_pb_db_r3 == nullptr);

			CNT.destroy(p_pb_db_r6);
			REQUIRE(p_pb_db_r6 == nullptr);

			CNT.destroy(p_pb_st_r1);
			REQUIRE(p_pb_st_r1 == nullptr);

			CNT.destroy(p_pb_st_r3);
			REQUIRE(p_pb_st_r3 == nullptr);

			CNT.destroy(p_pb_st_r6);
			REQUIRE(p_pb_st_r6 == nullptr);

			CNT.destroy(p_pb_by_r1);
			REQUIRE(p_pb_by_r1 == nullptr);

			CNT.destroy(p_pb_by_r3);
			REQUIRE(p_pb_by_r3 == nullptr);

			CNT.destroy(p_pb_by_r6);
			REQUIRE(p_pb_by_r6 == nullptr);
		}

		CNT.destroy(p_if_r1);
		REQUIRE(p_if_r1 == nullptr);

		CNT.destroy(p_if_r3);
		REQUIRE(p_if_r3 == nullptr);

		CNT.destroy(p_if_r6);
		REQUIRE(p_if_r6 == nullptr);

		CNT.destroy(p_bf_r1);
		REQUIRE(p_bf_r1 == nullptr);

		CNT.destroy(p_bf_r3);
		REQUIRE(p_bf_r3 == nullptr);

		CNT.destroy(p_bf_r6);
		REQUIRE(p_bf_r6 == nullptr);

		CNT.destroy(p_db_r1);
		REQUIRE(p_db_r1 == nullptr);

		CNT.destroy(p_db_r3);
		REQUIRE(p_db_r3 == nullptr);

		CNT.destroy(p_db_r6);
		REQUIRE(p_db_r6 == nullptr);

		CNT.destroy(p_st_r1);
		REQUIRE(p_st_r1 == nullptr);

		CNT.destroy(p_st_r3);
		REQUIRE(p_st_r3 == nullptr);

		CNT.destroy(p_st_r6);
		REQUIRE(p_st_r6 == nullptr);

		CNT.destroy(p_by_r1);
		REQUIRE(p_by_r1 == nullptr);

		CNT.destroy(p_by_r3);
		REQUIRE(p_by_r3 == nullptr);

		CNT.destroy(p_by_r6);
		REQUIRE(p_by_r6 == nullptr);
	}

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT._lock_	 == 0);

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}


SCENARIO("Testing new_block() (4) Create a Tensor by selecting an item from a Tuple.") {

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	GIVEN("We have 5 multiple purpose blocks") {
		pTransaction p_tx1, p_tx2, p_tx3, p_tx4, p_tx5;

		TensorDim dim_t1 {{27, 7, 3}}, dim_t2 {{3, 5, 4, 2, 0}}, dim_t3 {{10, 3, 0}}, dim_t4 {{2, 2, 3, 3, 1, 1}};


		REQUIRE(CNT.new_block(p_tx1, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx1 != nullptr);

		REQUIRE(CNT.new_block(p_tx2, CELL_TYPE_DOUBLE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx2 != nullptr);

		REQUIRE(CNT.new_block(p_tx3, CELL_TYPE_TIME, dim_t3.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx3 != nullptr);

		struct tm junk = {0};
		struct tm *timeinfo = &junk;

		char buffer[20] = {"2021-08-01 12:13:14"};
		char fmt[20]	= {"%Y-%m-%d %H:%M:%S"};

		REQUIRE(strptime(buffer, fmt, timeinfo) != nullptr);

		REQUIRE(timeinfo->tm_mday == 1);

		for (int i = 0; i < 30; i++) {
			timeinfo->tm_mday =  1 + (3*i % 29);
			timeinfo->tm_hour =  7 + (5*i % 7);
			timeinfo->tm_min  = 13 + (7*i % 31);
			p_tx3->p_block->tensor.cell_time[i] = timegm(timeinfo);
		}

		REQUIRE(CNT.new_block(p_tx4, CELL_TYPE_SINGLE, dim_t4.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx4 != nullptr);

		char const *text_file = "January February March April May June July August September October November December";

		REQUIRE(CNT.new_block(p_tx5, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_tx5 != nullptr);

//TODO: Write tests for this!

		WHEN("someone looks at it") {
			THEN("it breaks") {
				REQUIRE(2 > 1);
			}
		}

		CNT.destroy_internal(p_tx1);
		CNT.destroy_internal(p_tx2);
		CNT.destroy_internal(p_tx3);
		CNT.destroy_internal(p_tx4);
		CNT.destroy_internal(p_tx5);
	}

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT._lock_	 == 0);

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}


SCENARIO("Testing new_block() (5) Create a Tensor, Kind or Tuple from a Text block.") {

//TODO: Write tests for this!

	// struct tm *timeinfo;
	// time_t now_t;
	// char buffer [80];

	// time (&now_t);

	// timeinfo = localtime (&now_t);
	// strftime (buffer, 80, "Local: %Y-%m-%d %H:%M:%S\n", timeinfo);
	// printf ("%s", buffer);

	// timeinfo = gmtime(&now_t);
	// strftime (buffer, 80, "UTC: %Y-%m-%d %H:%M:%S\n", timeinfo);
	// printf ("%s", buffer);

	// time_t tt = timegm(timeinfo);

	// printf ("%ld\n", tt);

	// struct tm *tm = gmtime(&tt);
	// strftime (buffer, 80, "Round trip: %H:%M:%S, %A %B %m %Y\n", tm);
	// printf ("%s", buffer);

	REQUIRE(2*MAX_TENSOR_RANK + 3 < MAX_SIZE_OF_CELL_AS_TEXT);

	long long now64;
	jazz_elements::TimePoint big_bang;
	time_t nowXX;

	REQUIRE(sizeof(now64)	 == 8);
	REQUIRE(sizeof(big_bang) == 8);
	REQUIRE(sizeof(nowXX)	 == 8);

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	GIVEN("We have 5 multiple purpose blocks") {
		pTransaction p_tx1, p_tx2, p_tx3, p_tx4, p_tx5;

		TensorDim dim_t1 {{27, 7, 3}}, dim_t2 {{3, 5, 4, 2, 0}}, dim_t3 {{10, 3, 0}}, dim_t4 {{2, 2, 3, 3, 1, 1}};


		REQUIRE(CNT.new_block(p_tx1, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx1 != nullptr);

		REQUIRE(CNT.new_block(p_tx2, CELL_TYPE_DOUBLE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx2 != nullptr);

		REQUIRE(CNT.new_block(p_tx3, CELL_TYPE_TIME, dim_t3.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx3 != nullptr);

		struct tm junk = {0};
		struct tm *timeinfo = &junk;

		char buffer[20] = {"2021-08-01 12:13:14"};
		char fmt[20]	= {"%Y-%m-%d %H:%M:%S"};

		REQUIRE(strptime(buffer, fmt, timeinfo) != nullptr);

		REQUIRE(timeinfo->tm_mday == 1);

		for (int i = 0; i < 30; i++) {
			timeinfo->tm_mday =  1 + (3*i % 29);
			timeinfo->tm_hour =  7 + (5*i % 7);
			timeinfo->tm_min  = 13 + (7*i % 31);
			p_tx3->p_block->tensor.cell_time[i] = timegm(timeinfo);
		}

		REQUIRE(CNT.new_block(p_tx4, CELL_TYPE_SINGLE, dim_t4.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx4 != nullptr);

		char const *text_file = "January February March April May June July August September October November December";

		REQUIRE(CNT.new_block(p_tx5, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_tx5 != nullptr);

//TODO: Write tests for this!

		WHEN("someone looks at it") {
			THEN("it breaks") {
				REQUIRE(2 > 1);
			}
		}

		CNT.destroy_internal(p_tx1);
		CNT.destroy_internal(p_tx2);
		CNT.destroy_internal(p_tx3);
		CNT.destroy_internal(p_tx4);
		CNT.destroy_internal(p_tx5);
	}

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT._lock_	 == 0);

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}


SCENARIO("Testing new_block() (6) Create a Tensor of CELL_TYPE_BYTE of rank == 1 with a text serialization.") {

	REQUIRE(CNT.start() == SERVICE_NO_ERROR);

	REQUIRE(CNT.max_num_keepers > 0);
	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.warn_alloc_bytes > 0);
	REQUIRE(CNT.fail_alloc_bytes > 0);
	REQUIRE(CNT.alloc_warning_issued == false);
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == CNT.p_buffer);
	REQUIRE(CNT.p_free->p_next == &CNT.p_buffer[1]);
	REQUIRE(CNT.p_free->p_next->p_next == &CNT.p_buffer[2]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 2].p_next == &CNT.p_buffer[CNT.max_num_keepers - 1]);
	REQUIRE(CNT.p_buffer[CNT.max_num_keepers - 1].p_next == nullptr);
	REQUIRE(CNT._lock_ == 0);

	GIVEN("We have 5 multiple purpose blocks") {
		pTransaction p_tx1, p_tx2, p_tx3, p_tx4, p_tx5;

		TensorDim dim_t1 {{27, 7, 3}}, dim_t2 {{3, 5, 4, 2, 0}}, dim_t3 {{10, 3, 0}}, dim_t4 {{2, 2, 3, 3, 1, 1}};


		REQUIRE(CNT.new_block(p_tx1, CELL_TYPE_BYTE, dim_t1.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx1 != nullptr);

		REQUIRE(CNT.new_block(p_tx2, CELL_TYPE_DOUBLE, dim_t2.dim, FILL_NEW_WITH_ZERO) == SERVICE_NO_ERROR);
		REQUIRE(p_tx2 != nullptr);

		REQUIRE(CNT.new_block(p_tx3, CELL_TYPE_TIME, dim_t3.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx3 != nullptr);

		struct tm junk = {0};
		struct tm *timeinfo = &junk;

		char buffer[20] = {"2021-08-01 12:13:14"};
		char fmt[20]	= {"%Y-%m-%d %H:%M:%S"};

		REQUIRE(strptime(buffer, fmt, timeinfo) != nullptr);

		REQUIRE(timeinfo->tm_mday == 1);

		for (int i = 0; i < 30; i++) {
			timeinfo->tm_mday =  1 + (3*i % 29);
			timeinfo->tm_hour =  7 + (5*i % 7);
			timeinfo->tm_min  = 13 + (7*i % 31);
			p_tx3->p_block->tensor.cell_time[i] = timegm(timeinfo);
		}

		REQUIRE(CNT.new_block(p_tx4, CELL_TYPE_SINGLE, dim_t4.dim, FILL_NEW_DONT_FILL) == SERVICE_NO_ERROR);
		REQUIRE(p_tx4 != nullptr);

		char const *text_file = "January February March April May June July August September October November December";

		REQUIRE(CNT.new_block(p_tx5, CELL_TYPE_STRING, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file, ' ') == SERVICE_NO_ERROR);
		REQUIRE(p_tx5 != nullptr);

//TODO: Write tests for this!

		WHEN("someone looks at it") {
			THEN("it breaks") {
				REQUIRE(2 > 1);
			}
		}

		CNT.destroy_internal(p_tx1);
		CNT.destroy_internal(p_tx2);
		CNT.destroy_internal(p_tx3);
		CNT.destroy_internal(p_tx4);
		CNT.destroy_internal(p_tx5);
	}

	REQUIRE(CNT.alloc_bytes == CNT.max_num_keepers*sizeof(StoredTransaction));
	REQUIRE(CNT.p_buffer != nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT._lock_	 == 0);

	REQUIRE(CNT.shut_down() == SERVICE_NO_ERROR);

	REQUIRE(CNT.alloc_bytes == 0);
	REQUIRE(CNT.p_buffer == nullptr);
	REQUIRE(CNT.p_alloc  == nullptr);
	REQUIRE(CNT.p_free	 == nullptr);
	REQUIRE(CNT._lock_	 == 0);
}


SCENARIO("Testing new_block() (7) Create an empty Index block.") {

//TODO: Write tests for this!

	GIVEN("Something") {
		WHEN("someone looks at it") {
			THEN("it breaks") {
				REQUIRE(2 > 1);
			}
		}
	}
}
