/* Jazz (c) 2018-2021 kaalam.ai (The Authors of Jazz), using (under the same license):

	1. Biomodelling - The AATBlockQueue class (c) Jacques Basaldúa, 2009-2012 licensed
	  exclusively for the use in the Jazz server software.

	  Copyright 2009-2012 Jacques Basaldúa

	2. BBVA - Jazz: A lightweight analytical web server for data-driven applications.

      Copyright 2016-2017 Banco Bilbao Vizcaya Argentaria, S.A.

      This product includes software developed at

      BBVA (https://www.bbva.com/)

	3. LMDB, Copyright 2011-2017 Howard Chu, Symas Corp. All rights reserved.

	  Licensed under http://www.OpenLDAP.org/license.html


	  Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	  http://www.apache.org/licenses/LICENSE-2.0

	  Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/


// #include <stl_whatever>


using namespace jazz_elements;


// Instancing container, logger and config
// ---------------------------------------

ConfigFile	CONFIG(JAZZ_DEFAULT_CONFIG_PATH);
Logger		LOGGER(CONFIG, "LOGGER_PATH");
Container	CNT	  (&LOGGER, &CONFIG);


// Functions to support testing
// ----------------------------

class PseudoBuffer {
	public:

		inline void writer() {
			a[0] = (a[63]*16381 + 1) % 32749;
			for (int i = 1; i < 64; i++)
				a[i] = (a[i - 1]*16381 + 1) % 32749;

			b[0] = ((a[0] + b[63])*16381 + 3) % 32749;
			for (int i = 1; i < 64; i++)
				b[i] = (b[i - 1]*16381 + 1) % 32749;

			for (int i = 0; i < 64; i++)
				c[i] = a[i]*b[i];
		}

		inline int reader(int pid) {
			int i = pid % 64;

			return a[i]*b[i] - c[i];
		}

		Lock32 readers {0}, writers {0}, thread_errors {0}, reads_ok {0};

		int a[64] = {}, b[64] = {}, c[64] = {};
};

PseudoBuffer PSB;
BlockKeeper  JBK;

static void *unsafe_reader(void *null) {
	PSB.readers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 100; k++){
		if (PSB.reader(k) == 0)
			PSB.reads_ok.fetch_add(1, std::memory_order_relaxed);
		else
			PSB.thread_errors.fetch_add(1, std::memory_order_relaxed);
	}

	return (void *) 0;
}

static void *unsafe_writer(void *null) {
	PSB.writers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 10; k++){
		PSB.writer();
	}

	return (void *) 0;
}

static void *safe_reader(void *null) {
	PSB.readers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 1000; k++){
		CNT.enter_read(&JBK);

		if (PSB.reader(k) == 0)
			PSB.reads_ok.fetch_add(1, std::memory_order_relaxed);
		else
			PSB.thread_errors.fetch_add(1, std::memory_order_relaxed);

		CNT.leave_read(&JBK);
	}

	return (void *) 0;
}

static void *safe_writer(void *null) {
	PSB.writers.fetch_add(1, std::memory_order_relaxed);

	for (int k = 0; k < 10; k++){
		CNT.enter_write(&JBK);

		PSB.writer();

		CNT.leave_write(&JBK);
	}

	return (void *) 0;
}

// Tests
// -----

SCENARIO("Testing (container) structure sizes.") {

	REQUIRE(sizeof(Name)		 == 32);
	REQUIRE(sizeof(BlockId64)	 == 8);
	REQUIRE(sizeof(Lock32)		 == 4);
	REQUIRE(sizeof(KeeperData)	 == 32);
	REQUIRE(sizeof(BlockKeeper)	 == 64);
	REQUIRE(sizeof(Locator)		 == 96);
	REQUIRE(sizeof(ContractStep) == 40);
	REQUIRE(sizeof(R_value)		 == 256);
	REQUIRE(sizeof(Items)		 == 4096);
}

SCENARIO("Testing threading functions") {
	WHEN("We check basic assumptions, we get expected results") {
		REQUIRE(JBK._lock_ == 0);

		int lock = JBK._lock_.fetch_add(1, std::memory_order_relaxed);

		REQUIRE(lock == 0);
		REQUIRE(JBK._lock_ == 1);

		JBK._lock_ = 0;

		CNT.enter_read(&JBK);
		REQUIRE(JBK._lock_ == 1);

		CNT.enter_read(&JBK);
		REQUIRE(JBK._lock_ == 2);

		CNT.enter_read(&JBK);
		REQUIRE(JBK._lock_ == 3);

		CNT.leave_read(&JBK);
		REQUIRE(JBK._lock_ == 2);

		CNT.leave_read(&JBK);
		REQUIRE(JBK._lock_ == 1);

		CNT.leave_read(&JBK);
		REQUIRE(JBK._lock_ == 0);

		CNT.enter_write(&JBK);
		REQUIRE(JBK._lock_ == -LOCK_WEIGHT_OF_WRITE);

		CNT.leave_write(&JBK);
		REQUIRE(JBK._lock_ == 0);

		CNT.lock_container();
		REQUIRE(CNT._lock_ == 1);

		CNT.unlock_container();
		REQUIRE(CNT._lock_ == 0);
	}

	PSB.writer();

	for (int i = 0; i < 64; i++) {
		REQUIRE(PSB.reader(i) == 0);
	}

	WHEN("We run a 240x100 readers and 16x10 writers sequentially and no errors happen.") {
		for (int i = 0; i < 256; i++) {
			if ((i % 16) == 0)
				unsafe_writer(nullptr);
			else
				unsafe_reader(nullptr);
		}
		REQUIRE(PSB.writers == 16);
		REQUIRE(PSB.readers == 240);
		REQUIRE(PSB.reads_ok == 24000);
		REQUIRE(PSB.thread_errors == 0);
	}

// #define LONG_THREAD_TEST

#ifndef LONG_THREAD_TEST
	PSB.writers = PSB.readers = PSB.reads_ok = PSB.thread_errors = 0;

	WHEN("We run a short thread test. Define LONG_THREAD_TEST for the long test.") {
		bool failed = false;

		pthread_t th_id[32];
		for (int i = 0; i < 32; i++) {
			if ((i % 16) == 0) {
				if (pthread_create(&th_id[i], nullptr, safe_writer, nullptr) != 0) {
					failed = true;
					break;
				}
			} else {
				if (pthread_create(&th_id[i], nullptr, safe_reader, nullptr) != 0) {
					failed = true;
					break;
				}
			}
		}
		std::this_thread::yield();

		for (int i = 0; i < 32; i++) {
			if (pthread_join(th_id[i], nullptr) != 0){
				failed = true;
				break;
			}
		}

		REQUIRE(!failed);

		REQUIRE(PSB.writers == 2);
		REQUIRE(PSB.readers == 30);
		REQUIRE(PSB.reads_ok == 30000);
		REQUIRE(PSB.thread_errors == 0);
	}
#endif

#ifdef LONG_THREAD_TEST
	PSB.writers = PSB.readers = PSB.reads_ok = PSB.thread_errors = 0;

	const int num_threads = 256,
			  num_times	  = 64;

	WHEN("We run a 240x100 readers 16x10 writers in parallel num_times times without control, errors happen.") {
		bool failed = false;

		for (int times = 0; times < num_times; times++) {
			pthread_t th_id[num_threads];
			for (int i = 0; i < num_threads; i++) {
				if ((i % 16) == 0) {
					if (pthread_create(&th_id[i], nullptr, unsafe_writer, nullptr) != 0) {
						failed = true;
						break;
					}
				} else {
					if (pthread_create(&th_id[i], nullptr, unsafe_reader, nullptr) != 0) {
						failed = true;
						break;
					}
				}
			}
			std::this_thread::yield();

			for (int i = 0; i < num_threads; i++) {
				if (pthread_join(th_id[i], nullptr) != 0) {
					failed = true;
					break;
				}
			}
		}

		REQUIRE(!failed);

		REQUIRE(PSB.writers == 16*num_times);
		REQUIRE(PSB.readers == 240*num_times);
		REQUIRE(PSB.reads_ok < 24000*num_times);
		REQUIRE(PSB.thread_errors > 0);
	}

	PSB.writers = PSB.readers = PSB.reads_ok = PSB.thread_errors = 0;

	WHEN("We run a 240x1000 readers 16x10 writers in parallel num_times times with control and no errors happen.") {
		bool failed = false;

		for (int times = 0; times < num_times; times++) {
			pthread_t th_id[num_threads];
			for (int i = 0; i < num_threads; i++) {
				if ((i % 16) == 0) {
					if (pthread_create(&th_id[i], nullptr, safe_writer, nullptr) != 0) {
						failed = true;
						break;
					}
				} else {
					if (pthread_create(&th_id[i], nullptr, safe_reader, nullptr) != 0) {
						failed = true;
						break;
					}
				}

			}
			std::this_thread::yield();

			for (int i = 0; i < num_threads; i++) {
				if (pthread_join(th_id[i], nullptr) != 0){
					failed = true;
					break;
				}
			}
		}

		REQUIRE(!failed);

		REQUIRE(PSB.writers == 16*num_times);
		REQUIRE(PSB.readers == 240*num_times);
		REQUIRE(PSB.reads_ok == 240000*num_times);
		REQUIRE(PSB.thread_errors == 0);
	}
#endif
}


SCENARIO("Testing JazzBlock creation from scratch") {
	TensorDim dim {{7, 3, 5, 0}}, dim_in;

	WHEN("I force all the possible error conditions, I get nullptr.") {
		TensorDim dim7 {{7, 0}}, dim_in;
		pBlockKeeper p_keeper;
		char const *buffer	= "One Two Three Four Five Six Seven";
		char const *buffer6 = "One Two Three Four Five Six";
		bool filter[7];

		REQUIRE(CNT.new_block(p_keeper, CELL_TYPE_STRING, dim.dim, nullptr, FILL_NEW_DONT_FILL, nullptr, 0, buffer) == SERVICE_ERROR_NEW_BLOCK_ARGS);
/*
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_NEW_WITH_ZERO, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_NEW_WITH_NA, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_BOOLEAN_FILTER, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_INTEGER_FILTER, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BYTE, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BOOLEAN, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_DOUBLE, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, buffer);
		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_DOUBLE, nullptr);
		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 128, buffer, ' ');
		REQUIRE(pjb != nullptr);
		free_jazz_block(pjb);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_STRING, dim7.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 128, buffer, ' ');
		REQUIRE(pjb != nullptr);
		free_jazz_block(pjb);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_STRING, dim7.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 128, buffer6, ' ');
		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_BYTE, dim.dim, nullptr, FILL_NEW_WITH_NA);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(0x201, dim.dim, nullptr, FILL_NEW_WITH_NA);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(0x604, dim.dim, nullptr, FILL_NEW_WITH_NA);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(0x308, dim.dim, nullptr, FILL_NEW_WITH_NA);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(2, dim.dim, nullptr, FILL_NEW_WITH_NA);
		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim7.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &filter);
		REQUIRE(pjb != nullptr);
		free_jazz_block(pjb);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BYTE, dim7.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BOOLEAN, dim7.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim7.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim7.dim, nullptr, FILL_BOOLEAN_FILTER);
		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim7.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter);
		REQUIRE(pjb != nullptr);
		free_jazz_block(pjb);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BYTE, dim7.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BOOLEAN, dim7.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim7.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim7.dim, nullptr, FILL_INTEGER_FILTER);
		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_NEW_DONT_FILL);
		REQUIRE(pjb != nullptr);
		free_jazz_block(pjb);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_NEW_DONT_FILL - 1);
		REQUIRE(pjb == nullptr);
		pjb = new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_WITH_TEXTFILE + 1);
		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BYTE, dim.dim);

		REQUIRE(pjb == nullptr);	// CELL_TYPE_BYTE cannot accept fill_tensor	= FILL_NEW_WITH_NA!

		pjb = new_jazz_block(CELL_TYPE_BYTE, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BYTE);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*7 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_byte[0] == 0);
		REQUIRE(pjb->tensor.cell_byte[104] == 0);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*7 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE_BOOLEAN") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*7 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_byte[0]   == JAZZ_BYTE_BOOLEAN_NA);
		REQUIRE(pjb->tensor.cell_byte[104] == JAZZ_BYTE_BOOLEAN_NA);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*7 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_INTEGER, CELL_TYPE_FACTOR & CELL_TYPE_GRADE") {
		const int cell_types[3] = {CELL_TYPE_INTEGER, CELL_TYPE_FACTOR, CELL_TYPE_GRADE};

		for (int i = 0; i < 3; i ++) {
			pJazzBlock pjb = new_jazz_block(cell_types[i], dim.dim);

			REQUIRE(pjb != nullptr);

			REQUIRE(pjb->cell_type == cell_types[i]);
			REQUIRE(pjb->rank == 3);

			memset(&dim_in, 1, sizeof(dim_in));

			pjb->get_dimensions(dim_in.dim);

			REQUIRE(dim_in.dim[0] == 7);
			REQUIRE(dim_in.dim[1] == 3);
			REQUIRE(dim_in.dim[2] == 5);
			REQUIRE(dim_in.dim[3] == 0);
			REQUIRE(dim_in.dim[4] == 0);
			REQUIRE(dim_in.dim[5] == 0);

			REQUIRE(pjb->size == 105);
			REQUIRE(pjb->num_attributes == 1);
			REQUIRE(pjb->total_bytes == 64 + 16*27 + 8 + 16);
			REQUIRE(pjb->has_NA == true);
			REQUIRE(pjb->tensor.cell_int[0]	  == JAZZ_INTEGER_NA);
			REQUIRE(pjb->tensor.cell_int[104] == JAZZ_INTEGER_NA);

			check_and_close_jazz_block(pjb);

			REQUIRE(pjb != nullptr);

			REQUIRE(pjb->has_NA == true);
			REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
			REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*27 + 8 + 16));

			REQUIRE(pjb->find_attribute(976555311) == nullptr);
			REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
			REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

			free_jazz_block(pjb);

			REQUIRE(pjb == nullptr);
		}
	}

	GIVEN("A block of CELL_TYPE_BOOLEAN") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BOOLEAN, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BOOLEAN);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*27 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_int[0]	  == JAZZ_BOOLEAN_NA);
		REQUIRE(pjb->tensor.cell_int[104] == JAZZ_BOOLEAN_NA);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*27 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_SINGLE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_SINGLE, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_SINGLE);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*27 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_uint[0]   == reinterpret_cast<u_int*>(&JAZZ_SINGLE_NA)[0]);
		REQUIRE(pjb->tensor.cell_uint[104] == reinterpret_cast<u_int*>(&JAZZ_SINGLE_NA)[0]);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*27 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_STRING") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*27 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_uint[0]   == JAZZ_STRING_NA);
		REQUIRE(pjb->tensor.cell_uint[104] == JAZZ_STRING_NA);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*27 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_LONG_INTEGER") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_LONG_INTEGER, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_LONG_INTEGER);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*53 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_longint[0]	  == JAZZ_LONG_INTEGER_NA);
		REQUIRE(pjb->tensor.cell_longint[104] == JAZZ_LONG_INTEGER_NA);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*53 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_TIME") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_TIME, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_TIME);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*53 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_longint[0]	  == JAZZ_TIME_POINT_NA);
		REQUIRE(pjb->tensor.cell_longint[104] == JAZZ_TIME_POINT_NA);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*53 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_DOUBLE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_DOUBLE, dim.dim);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_DOUBLE);
		REQUIRE(pjb->rank == 3);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 3);
		REQUIRE(dim_in.dim[2] == 5);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 105);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*53 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_ulongint[0]   == reinterpret_cast<uint64_t*>(&JAZZ_DOUBLE_NA)[0]);
		REQUIRE(pjb->tensor.cell_ulongint[104] == reinterpret_cast<uint64_t*>(&JAZZ_DOUBLE_NA)[0]);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*53 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	dim.dim[0] = 7;
	dim.dim[1] = 2;
	dim.dim[2] = 2;
	dim.dim[3] = 2;
	dim.dim[4] = 3;
	dim.dim[5] = 2;

	GIVEN("A block of CELL_TYPE_BYTE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BYTE, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BYTE);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*21 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_byte[0]   == 0);
		REQUIRE(pjb->tensor.cell_byte[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*21 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE_BOOLEAN") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*21 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_byte[0]   == 0);
		REQUIRE(pjb->tensor.cell_byte[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*21 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_INTEGER, CELL_TYPE_FACTOR & CELL_TYPE_GRADE") {
		const int cell_types[3] = {CELL_TYPE_INTEGER, CELL_TYPE_FACTOR, CELL_TYPE_GRADE};

		for (int i = 0; i < 3; i ++) {
			pJazzBlock pjb = new_jazz_block(cell_types[i], dim.dim, nullptr, FILL_NEW_WITH_ZERO);

			REQUIRE(pjb != nullptr);

			REQUIRE(pjb->cell_type == cell_types[i]);
			REQUIRE(pjb->rank == 6);

			memset(&dim_in, 1, sizeof(dim_in));

			pjb->get_dimensions(dim_in.dim);

			REQUIRE(dim_in.dim[0] == 7);
			REQUIRE(dim_in.dim[1] == 2);
			REQUIRE(dim_in.dim[2] == 2);
			REQUIRE(dim_in.dim[3] == 2);
			REQUIRE(dim_in.dim[4] == 3);
			REQUIRE(dim_in.dim[5] == 2);

			REQUIRE(pjb->size == 336);
			REQUIRE(pjb->num_attributes == 1);
			REQUIRE(pjb->total_bytes == 64 + 16*84 + 8 + 16);
			REQUIRE(pjb->has_NA == false);
			REQUIRE(pjb->tensor.cell_int[0]	  == 0);
			REQUIRE(pjb->tensor.cell_int[335] == 0);

			check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

			REQUIRE(pjb != nullptr);

			REQUIRE(pjb->has_NA == true);
			REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
			REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*84 + 8 + 16));

			REQUIRE(pjb->find_attribute(976555311) == nullptr);
			REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
			REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

			free_jazz_block(pjb);

			REQUIRE(pjb == nullptr);
		}
	}

	GIVEN("A block of CELL_TYPE_BOOLEAN") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BOOLEAN, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BOOLEAN);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*84 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_int[0]	  == 0);
		REQUIRE(pjb->tensor.cell_int[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*84 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_SINGLE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_SINGLE, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_SINGLE);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*84 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_uint[0]   == 0);
		REQUIRE(pjb->tensor.cell_uint[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*84 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_STRING") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*84 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_uint[0]   == 0);
		REQUIRE(pjb->tensor.cell_uint[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*84 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_LONG_INTEGER") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_LONG_INTEGER, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_LONG_INTEGER);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*168 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_longint[0]	  == 0);
		REQUIRE(pjb->tensor.cell_longint[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*168 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_TIME") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_TIME, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_TIME);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*168 + 8 + 16);
		REQUIRE(pjb->has_NA == true);
		REQUIRE(pjb->tensor.cell_longint[0]	  == 0);
		REQUIRE(pjb->tensor.cell_longint[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*168 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_DOUBLE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_DOUBLE, dim.dim, nullptr, FILL_NEW_WITH_ZERO);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_DOUBLE);
		REQUIRE(pjb->rank == 6);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 7);
		REQUIRE(dim_in.dim[1] == 2);
		REQUIRE(dim_in.dim[2] == 2);
		REQUIRE(dim_in.dim[3] == 2);
		REQUIRE(dim_in.dim[4] == 3);
		REQUIRE(dim_in.dim[5] == 2);

		REQUIRE(pjb->size == 336);
		REQUIRE(pjb->num_attributes == 1);
		REQUIRE(pjb->total_bytes == 64 + 16*168 + 8 + 16);
		REQUIRE(pjb->has_NA == false);
		REQUIRE(pjb->tensor.cell_ulongint[0]   == 0);
		REQUIRE(pjb->tensor.cell_ulongint[335] == 0);

		check_and_close_jazz_block(pjb, JAZZ_SET_HAS_NA_TRUE);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*168 + 8 + 16));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY) != nullptr);
		REQUIRE(strlen(pjb->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)) == 0);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	dim.dim[0] = 97;
	dim.dim[1] = 1;
	dim.dim[2] = 2;
	dim.dim[3] = 3;
	dim.dim[4] = 4;
	dim.dim[5] = 5;

	AllAttributes block_att;
	block_att [1357] = "Hello world!";
	block_att [468]	 = "Hi!";
	block_att [222]	 = "123.";

	GIVEN("A block of CELL_TYPE_BYTE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BYTE, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BYTE);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*7 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == false);

		for (int j = 0; j < 97; j++) pjb->tensor.cell_byte[j] = j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*7 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_BYTE_BOOLEAN") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*7 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) pjb->tensor.cell_byte[j] = j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*7 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_INTEGER, CELL_TYPE_FACTOR & CELL_TYPE_GRADE") {
		const int cell_types[3] = {CELL_TYPE_INTEGER, CELL_TYPE_FACTOR, CELL_TYPE_GRADE};

		for (int i = 0; i < 3; i ++) {
			pJazzBlock pjb = new_jazz_block(cell_types[i], dim.dim, &block_att, FILL_NEW_DONT_FILL);

			REQUIRE(pjb != nullptr);

			REQUIRE(pjb->cell_type == cell_types[i]);
			REQUIRE(pjb->rank == 1);

			memset(&dim_in, 1, sizeof(dim_in));

			pjb->get_dimensions(dim_in.dim);

			REQUIRE(dim_in.dim[0] == 97);
			REQUIRE(dim_in.dim[1] == 0);
			REQUIRE(dim_in.dim[2] == 0);
			REQUIRE(dim_in.dim[3] == 0);
			REQUIRE(dim_in.dim[4] == 0);
			REQUIRE(dim_in.dim[5] == 0);

			REQUIRE(pjb->size == 97);
			REQUIRE(pjb->num_attributes == 3);
			REQUIRE(pjb->total_bytes == 64 + 16*25 + 8*3 + 16 + 22);
			REQUIRE(pjb->has_NA == true);
			for (int j = 0; j < 97; j++) pjb->tensor.cell_int[j] = j;

			check_and_close_jazz_block(pjb);

			REQUIRE(pjb != nullptr);

			REQUIRE(pjb->has_NA == false);
			REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
			REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*25 + 8*3 + 16 + 22));

			REQUIRE(pjb->find_attribute(976555311) == nullptr);
			REQUIRE(pjb->find_attribute(1357) != nullptr);
			REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
			REQUIRE(pjb->find_attribute(222) != nullptr);
			REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
			REQUIRE(pjb->find_attribute(468) != nullptr);
			REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

			free_jazz_block(pjb);

			REQUIRE(pjb == nullptr);
		}
	}

	GIVEN("A block of CELL_TYPE_BOOLEAN") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_BOOLEAN, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_BOOLEAN);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*25 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) pjb->tensor.cell_int[j] = j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*25 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_SINGLE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_SINGLE, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_SINGLE);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*25 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) pjb->tensor.cell_single[j] = 0.123*j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*25 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	char const *monday = "Monday", *tuesday = "Tuesday", *nope = "";

	GIVEN("A block of CELL_TYPE_STRING") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, &block_att, FILL_NEW_DONT_FILL, nullptr, 256);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*25 + 8*3 + 16 + 22 + 256);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) {
			switch (j % 3) {
			case 1:
				pjb->set_string(j, monday);
				break;
			case 2:
				pjb->set_string(j, tuesday);
				break;
			default:
				pjb->set_string(j, nope);
				break;
			}
		}

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*25 + 8*3 + 16 + 22 + 256));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		REQUIRE(!strcmp(pjb->get_string( 0), ""));
		REQUIRE(!strcmp(pjb->get_string( 1), "Monday"));
		REQUIRE(!strcmp(pjb->get_string( 2), "Tuesday"));
		REQUIRE(!strcmp(pjb->get_string(94), "Monday"));
		REQUIRE(!strcmp(pjb->get_string(95), "Tuesday"));
		REQUIRE(!strcmp(pjb->get_string(96), ""));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_LONG_INTEGER") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_LONG_INTEGER, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_LONG_INTEGER);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*49 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) pjb->tensor.cell_longint[j] = j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*49 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_TIME") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_TIME, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_TIME);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*49 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) pjb->tensor.cell_longint[j] = j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == true);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*49 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	GIVEN("A block of CELL_TYPE_DOUBLE") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_DOUBLE, dim.dim, &block_att, FILL_NEW_DONT_FILL);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_DOUBLE);
		REQUIRE(pjb->rank == 1);

		memset(&dim_in, 1, sizeof(dim_in));

		pjb->get_dimensions(dim_in.dim);

		REQUIRE(dim_in.dim[0] == 97);
		REQUIRE(dim_in.dim[1] == 0);
		REQUIRE(dim_in.dim[2] == 0);
		REQUIRE(dim_in.dim[3] == 0);
		REQUIRE(dim_in.dim[4] == 0);
		REQUIRE(dim_in.dim[5] == 0);

		REQUIRE(pjb->size == 97);
		REQUIRE(pjb->num_attributes == 3);
		REQUIRE(pjb->total_bytes == 64 + 16*49 + 8*3 + 16 + 22);
		REQUIRE(pjb->has_NA == true);
		for (int j = 0; j < 97; j++) pjb->tensor.cell_double[j] = -0.1234567890123*j;

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);
		REQUIRE(jazz_utils::elapsed_us(pjb->created) < 3e6);
		REQUIRE(pjb->hash64 == jazz_utils::MurmurHash64A(&pjb->tensor, 16*49 + 8*3 + 16 + 22));

		REQUIRE(pjb->find_attribute(976555311) == nullptr);
		REQUIRE(pjb->find_attribute(1357) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(1357), "Hello world!"));
		REQUIRE(pjb->find_attribute(222) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(222), "123."));
		REQUIRE(pjb->find_attribute(468) != nullptr);
		REQUIRE(!strcmp(pjb->find_attribute(468), "Hi!"));

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	char const *text_file_0 = "",
			   *text_file_1 = "\n",
			   *text_file_2 = "\n\n\n",
			   *text_file_3 = "abc\ndef",
			   *text_file_4 = "abc\ndef\n",
			   *text_file_5 = "abc\ndef\n\n",
			   *text_file_6 = "This is a common\ntext file\n",
			   *text_file_7 = "\nThis is another\n\ncommon\ntext file.",
			   *text_file_8 = "January February March April May June July August September October November December",
			   *text_file_9 = "\n\n\nMon\n\nTue\nWed\n\n\n";

	GIVEN("A block of CELL_TYPE_STRING") {
		pJazzBlock pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_NEW_DONT_FILL, nullptr, 0, text_file_0);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_NEW_WITH_ZERO, nullptr, 0, text_file_0);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_BOOLEAN_FILTER, nullptr, 0, text_file_0);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_0);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 1);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 1);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), ""));
		REQUIRE(pjb->tensor.cell_int[0] == JAZZ_STRING_EMPTY);

		REQUIRE(pjb->p_string_buffer()->last_idx == 3);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "Q") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_1);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 1);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 1);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), ""));
		REQUIRE(pjb->tensor.cell_int[0] == JAZZ_STRING_EMPTY);

		REQUIRE(pjb->p_string_buffer()->last_idx == 3);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "#") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_2);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 3);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 3);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), ""));
		REQUIRE(pjb->tensor.cell_int[0] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(1), ""));
		REQUIRE(pjb->tensor.cell_int[1] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(2), ""));
		REQUIRE(pjb->tensor.cell_int[2] == JAZZ_STRING_EMPTY);

		REQUIRE(pjb->p_string_buffer()->last_idx == 5);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "A") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_3);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 2);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 6 + 2);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), "abc"));
		REQUIRE(pjb->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(pjb->get_string(1), "def"));
		REQUIRE(pjb->tensor.cell_int[1] == 6);

		REQUIRE(pjb->p_string_buffer()->last_idx == 10);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "A") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_4);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 2);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 6 + 2);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), "abc"));
		REQUIRE(pjb->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(pjb->get_string(1), "def"));
		REQUIRE(pjb->tensor.cell_int[1] == 6);

		REQUIRE(pjb->p_string_buffer()->last_idx == 10);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "A") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_5);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 3);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 6 + 3);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), "abc"));
		REQUIRE(pjb->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(pjb->get_string(1), "def"));
		REQUIRE(pjb->tensor.cell_int[1] == 6);
		REQUIRE(!strcmp(pjb->get_string(2), ""));
		REQUIRE(pjb->tensor.cell_int[2] == JAZZ_STRING_EMPTY);

		REQUIRE(pjb->p_string_buffer()->last_idx == 11);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "A") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_6);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 2);
		REQUIRE(pjb->total_bytes == 64 + 16 + 8 + 16 + 25 + 2);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), "This is a common"));
		REQUIRE(pjb->tensor.cell_int[0] == 2);
		REQUIRE(!strcmp(pjb->get_string(1), "text file"));
		REQUIRE(pjb->tensor.cell_int[1] == 19);

		REQUIRE(pjb->p_string_buffer()->last_idx == 29);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "A") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_7);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 5);
		REQUIRE(pjb->total_bytes == 64 + 16*2 + 8 + 16 + 31 + 5);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), ""));
		REQUIRE(pjb->tensor.cell_int[0] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(1), "This is another"));
		REQUIRE(pjb->tensor.cell_int[1] == 3);
		REQUIRE(!strcmp(pjb->get_string(2), ""));
		REQUIRE(pjb->tensor.cell_int[2] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(3), "common"));
		REQUIRE(pjb->tensor.cell_int[3] == 20);
		REQUIRE(!strcmp(pjb->get_string(4), "text file."));
		REQUIRE(pjb->tensor.cell_int[4] == 27);

		REQUIRE(pjb->p_string_buffer()->last_idx == 38);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "S") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		dim.dim[0] = 11;
		dim.dim[1] = 0;
		dim.dim[2] = 0;
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ');

		REQUIRE(pjb == nullptr);

		dim.dim[0] = 13;
		dim.dim[1] = 0;
		dim.dim[2] = 0;
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ');

		REQUIRE(pjb == nullptr);

		dim.dim[0] = 5;
		dim.dim[1] = 2;
		dim.dim[2] = 0;
		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ');

		REQUIRE(pjb == nullptr);

		dim.dim[0] = 6;
		dim.dim[1] = 2;
		dim.dim[2] = 0;

		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ');

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 2);

		REQUIRE(pjb->size == 12);
		REQUIRE(pjb->total_bytes == 64 + 16*3 + 8 + 16 + 75 + 11);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0),	 "January"));
		REQUIRE(!strcmp(pjb->get_string(1),	 "February"));
		REQUIRE(!strcmp(pjb->get_string(2),	 "March"));
		REQUIRE(!strcmp(pjb->get_string(3),	 "April"));
		REQUIRE(!strcmp(pjb->get_string(4),	 "May"));
		REQUIRE(!strcmp(pjb->get_string(5),	 "June"));
		REQUIRE(!strcmp(pjb->get_string(6),	 "July"));
		REQUIRE(!strcmp(pjb->get_string(7),	 "August"));
		REQUIRE(!strcmp(pjb->get_string(8),	 "September"));
		REQUIRE(!strcmp(pjb->get_string(9),	 "October"));
		REQUIRE(!strcmp(pjb->get_string(10), "November"));
		REQUIRE(!strcmp(pjb->get_string(11), "December"));

		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "-") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		dim.dim[0] = 3;
		dim.dim[1] = 2;
		dim.dim[2] = 2;
		dim.dim[3] = 1;
		dim.dim[4] = 9;

		pjb = new_jazz_block(CELL_TYPE_STRING, dim.dim, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ');

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 3);

		REQUIRE(pjb->size == 12);
		REQUIRE(pjb->total_bytes == 64 + 16*3 + 8 + 16 + 75 + 11);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0),	 "January"));
		REQUIRE(!strcmp(pjb->get_string(1),	 "February"));
		REQUIRE(!strcmp(pjb->get_string(2),	 "March"));
		REQUIRE(!strcmp(pjb->get_string(3),	 "April"));
		REQUIRE(!strcmp(pjb->get_string(4),	 "May"));
		REQUIRE(!strcmp(pjb->get_string(5),	 "June"));
		REQUIRE(!strcmp(pjb->get_string(6),	 "July"));
		REQUIRE(!strcmp(pjb->get_string(7),	 "August"));
		REQUIRE(!strcmp(pjb->get_string(8),	 "September"));
		REQUIRE(!strcmp(pjb->get_string(9),	 "October"));
		REQUIRE(!strcmp(pjb->get_string(10), "November"));
		REQUIRE(!strcmp(pjb->get_string(11), "December"));

		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "@") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_8, ' ');

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 12);
		REQUIRE(pjb->total_bytes == 64 + 16*3 + 8 + 16 + 75 + 11);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0),	 "January"));
		REQUIRE(!strcmp(pjb->get_string(1),	 "February"));
		REQUIRE(!strcmp(pjb->get_string(2),	 "March"));
		REQUIRE(!strcmp(pjb->get_string(3),	 "April"));
		REQUIRE(!strcmp(pjb->get_string(4),	 "May"));
		REQUIRE(!strcmp(pjb->get_string(5),	 "June"));
		REQUIRE(!strcmp(pjb->get_string(6),	 "July"));
		REQUIRE(!strcmp(pjb->get_string(7),	 "August"));
		REQUIRE(!strcmp(pjb->get_string(8),	 "September"));
		REQUIRE(!strcmp(pjb->get_string(9),	 "October"));
		REQUIRE(!strcmp(pjb->get_string(10), "November"));
		REQUIRE(!strcmp(pjb->get_string(11), "December"));

		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "T") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);

		pjb = new_jazz_block(CELL_TYPE_STRING, nullptr, nullptr, FILL_WITH_TEXTFILE, nullptr, 0, text_file_9);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->cell_type == CELL_TYPE_STRING);
		REQUIRE(pjb->rank == 1);

		REQUIRE(pjb->size == 9);
		REQUIRE(pjb->total_bytes == 64 + 16*3 + 8 + 16 + 9 + 9);
		REQUIRE(pjb->has_NA == false);

		check_and_close_jazz_block(pjb);

		REQUIRE(pjb != nullptr);

		REQUIRE(pjb->has_NA == false);

		REQUIRE(!strcmp(pjb->get_string(0), ""));
		REQUIRE(pjb->tensor.cell_int[0] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(1), ""));
		REQUIRE(pjb->tensor.cell_int[1] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(2), ""));
		REQUIRE(pjb->tensor.cell_int[2] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(3), "Mon"));
		REQUIRE(pjb->tensor.cell_int[3] == 5);
		REQUIRE(!strcmp(pjb->get_string(4), ""));
		REQUIRE(pjb->tensor.cell_int[4] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(5), "Tue"));
		REQUIRE(pjb->tensor.cell_int[5] == 10);
		REQUIRE(!strcmp(pjb->get_string(6), "Wed"));
		REQUIRE(pjb->tensor.cell_int[6] == 14);
		REQUIRE(!strcmp(pjb->get_string(7), ""));
		REQUIRE(pjb->tensor.cell_int[7] == JAZZ_STRING_EMPTY);
		REQUIRE(!strcmp(pjb->get_string(8), ""));
		REQUIRE(pjb->tensor.cell_int[8] == JAZZ_STRING_EMPTY);

		REQUIRE(pjb->p_string_buffer()->last_idx == 20);
		REQUIRE(!pjb->p_string_buffer()->alloc_failed);
		REQUIRE(pjb->get_string_offset(pjb->p_string_buffer(), "p") == JAZZ_STRING_NA);
		REQUIRE(pjb->p_string_buffer()->alloc_failed);

		free_jazz_block(pjb);

		REQUIRE(pjb == nullptr);
	}

	bool filter_v_z[120], filter_v_1[120], filter_v_n[120];

	for (int i = 0; i < 120; i ++) {
		filter_v_z[i] = 0;
		filter_v_1[i] = true;
		filter_v_n[i] = (i % 7) == 2;
	}

	dim.dim[0] = 120;
	dim.dim[1] = 5;
	dim.dim[2] = 4;
	dim.dim[3] = 1;
	dim.dim[4] = 9;
	dim.dim[5] = 9;

	pJazzBlock p_bd = new_jazz_block(CELL_TYPE_DOUBLE, dim.dim);

	REQUIRE(p_bd != nullptr);

	REQUIRE(p_bd->cell_type == CELL_TYPE_DOUBLE);
	REQUIRE(p_bd->rank == 3);
	REQUIRE(p_bd->size == 2400);

	GIVEN("A filter of boolean") {
		dim.dim[0] = 120;
		dim.dim[1] = 0;

		pJazzFilter pjf = (pJazzFilter) new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim.dim, nullptr, FILL_BOOLEAN_FILTER);

		REQUIRE(pjf == nullptr);

		pjf = (pJazzFilter) new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &filter_v_n);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->cell_type == CELL_TYPE_BYTE_BOOLEAN);
		REQUIRE(pjf->rank == 1);
		REQUIRE(pjf->size == 120);
		REQUIRE(pjf->num_attributes == 1);
		REQUIRE(pjf->total_bytes == 64 + 16*8 + 8 + 16);
		REQUIRE(pjf->has_NA == false);
		for (int j = 0; j < 120; j++)
			REQUIRE(pjf->tensor.cell_byte[j] == filter_v_n[j]);

		check_and_close_jazz_block(pjf);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->has_NA == false);

		REQUIRE(pjf->filter_audit() == JAZZ_FILTER_TYPE_BOOLEAN);

		REQUIRE(pjf->can_filter(p_bd));

		free_jazz_block((pJazzBlock &) pjf);

		REQUIRE(pjf == nullptr);
	}

	GIVEN("Three filters of integer") {
		dim.dim[0] = 120;
		dim.dim[1] = 0;

		pJazzFilter pjf = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_INTEGER_FILTER);

		REQUIRE(pjf == nullptr);

		pjf = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter_v_n);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->cell_type == CELL_TYPE_INTEGER);
		REQUIRE(pjf->rank == 1);
		REQUIRE(pjf->size == 120);
		REQUIRE(pjf->num_attributes == 1);
		REQUIRE(pjf->total_bytes == 64 + 16*30 + 8 + 16);
		REQUIRE(pjf->has_NA == false);
		REQUIRE(pjf->range.filter.one == 1);
		REQUIRE(pjf->range.filter.length == 17);
		for (int j = 0; j < pjf->range.filter.length; j++)
			REQUIRE(pjf->tensor.cell_int[j] == 7*j + 2);

		check_and_close_jazz_block(pjf);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->has_NA == false);

		REQUIRE(pjf->filter_audit() == JAZZ_FILTER_TYPE_INTEGER);

		REQUIRE(pjf->can_filter(p_bd));

		free_jazz_block((pJazzBlock &) pjf);

		REQUIRE(pjf == nullptr);

		pjf = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter_v_z);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->cell_type == CELL_TYPE_INTEGER);
		REQUIRE(pjf->rank == 1);
		REQUIRE(pjf->size == 120);
		REQUIRE(pjf->num_attributes == 1);
		REQUIRE(pjf->total_bytes == 64 + 16*30 + 8 + 16);
		REQUIRE(pjf->has_NA == false);
		REQUIRE(pjf->range.filter.one == 1);
		REQUIRE(pjf->range.filter.length == 0);

		check_and_close_jazz_block(pjf);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->has_NA == false);

		REQUIRE(pjf->filter_audit() == JAZZ_FILTER_TYPE_INTEGER);

		REQUIRE(pjf->can_filter(p_bd));

		free_jazz_block((pJazzBlock &) pjf);

		REQUIRE(pjf == nullptr);

		pjf = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &filter_v_1);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->cell_type == CELL_TYPE_INTEGER);
		REQUIRE(pjf->rank == 1);
		REQUIRE(pjf->size == 120);
		REQUIRE(pjf->num_attributes == 1);
		REQUIRE(pjf->total_bytes == 64 + 16*30 + 8 + 16);
		REQUIRE(pjf->has_NA == false);
		REQUIRE(pjf->range.filter.one == 1);
		REQUIRE(pjf->range.filter.length == 120);
		for (int j = 0; j < pjf->range.filter.length; j++)
			REQUIRE(pjf->tensor.cell_int[j] == j);

		check_and_close_jazz_block(pjf);

		REQUIRE(pjf != nullptr);

		REQUIRE(pjf->has_NA == false);

		REQUIRE(pjf->filter_audit() == JAZZ_FILTER_TYPE_INTEGER);

		REQUIRE(pjf->can_filter(p_bd));

		free_jazz_block((pJazzBlock &) pjf);

		REQUIRE(pjf == nullptr);
	}

	free_jazz_block(p_bd);

	REQUIRE(p_bd == nullptr);
}


SCENARIO("Testing JazzBlock creation by copying/filtering") {
	pJazzBlock p_db_r1, p_db_r3, p_db_r6,
			   p_st_r1, p_st_r3, p_st_r6,
			   p_by_r1, p_by_r3, p_by_r6;

	JazzTensorDim dim_r1 {{107, 0}}, dim_r3 {{17, 9, 3, 0}}, dim_r6 {{2, 3, 2, 5, 2, 7}};

	pJazzFilter p_if_r1, p_if_r3, p_if_r6, p_bf_r1, p_bf_r3, p_bf_r6;

	AllAttributes old_str, new_str, no_str;

	old_str [256] = "Life's but a walking shadow";		// Both old_str and new_str have the same number of chars
	old_str [313] = "... a poor player";
	old_str [921] = "that struts and frets his hour";
	old_str [222] = "upon the stage and";
	old_str [321] = "then ...";

	new_str [921] = "is heard nomore ...";
	new_str [313] = "It's a tale..";
	new_str [358] = "told by an idiot..";
	new_str [222] = "full of sound and fury..";
	new_str [676] = "signifying ..";
	new_str [321] = "NULL";

	no_str[123] = (char *) nullptr;
	no_str[456] = "";

	const char *month[12] = {"January", "February", "March", "April", "May", "June", "July", "August",
							 "September", "October", "November", "December"};

	bool buff_1k[1024] = {false};

	GIVEN("A set of 9 blocks of 3 types x 3 ranks") {
		p_db_r1 = new_jazz_block(CELL_TYPE_DOUBLE, dim_r1.dim, &old_str);

		REQUIRE(p_db_r1 != nullptr);
		REQUIRE(p_db_r1->size == 107);

		p_db_r3 = new_jazz_block(CELL_TYPE_DOUBLE, dim_r3.dim, &no_str);

		REQUIRE(p_db_r3 != nullptr);
		REQUIRE(p_db_r3->size == 459);

		p_db_r6 = new_jazz_block(CELL_TYPE_DOUBLE, dim_r6.dim, nullptr);

		REQUIRE(p_db_r6 != nullptr);
		REQUIRE(p_db_r6->size == 840);

		p_st_r1 = new_jazz_block(CELL_TYPE_STRING, dim_r1.dim, &no_str, FILL_NEW_DONT_FILL, nullptr, 256);

		REQUIRE(p_st_r1 != nullptr);
		REQUIRE(p_st_r1->size == 107);

		p_st_r3 = new_jazz_block(CELL_TYPE_STRING, dim_r3.dim, nullptr, FILL_NEW_DONT_FILL, nullptr, 256);

		REQUIRE(p_st_r3 != nullptr);
		REQUIRE(p_st_r3->size == 459);

		p_st_r6 = new_jazz_block(CELL_TYPE_STRING, dim_r6.dim, &old_str, FILL_NEW_DONT_FILL, nullptr, 256);

		REQUIRE(p_st_r6 != nullptr);
		REQUIRE(p_st_r6->size == 840);

		p_by_r1 = new_jazz_block(CELL_TYPE_BYTE, dim_r1.dim, nullptr, FILL_NEW_DONT_FILL);

		REQUIRE(p_by_r1 != nullptr);
		REQUIRE(p_by_r1->size == 107);

		p_by_r3 = new_jazz_block(CELL_TYPE_BYTE, dim_r3.dim, &old_str, FILL_NEW_DONT_FILL);

		REQUIRE(p_by_r3 != nullptr);
		REQUIRE(p_by_r3->size == 459);

		p_by_r6 = new_jazz_block(CELL_TYPE_BYTE, dim_r6.dim, &no_str, FILL_NEW_DONT_FILL);

		REQUIRE(p_by_r6 != nullptr);
		REQUIRE(p_by_r6->size == 840);

		int index[6];

		for (int i = 0; i < 107; i++) {
			index[0] = i;

			p_db_r1->tensor.cell_double[p_db_r1->get_offset((int *) &index)] = i/10.0;
			p_by_r1->tensor.cell_byte  [p_by_r1->get_offset((int *) &index)] = 7 + 2*i;

			p_st_r1->set_string((int *) &index, month[i % 12]);
		}

		REQUIRE(p_db_r1->tensor.cell_double[33] == 3.3);
		REQUIRE(p_by_r1->tensor.cell_byte  [33] == 73);
		REQUIRE(!strcmp(p_st_r1->get_string(15), "April"));
		REQUIRE(!p_st_r1->p_string_buffer()->alloc_failed);

		check_and_close_jazz_block(p_db_r1);
		check_and_close_jazz_block(p_st_r1);
		check_and_close_jazz_block(p_by_r1);

		for (int i = 0; i < 17; i++) {
			for (int j = 0; j < 9; j++) {
				for (int k = 0; k < 3; k++) {
					index[0] = i;
					index[1] = j;
					index[2] = k;

					p_db_r3->tensor.cell_double[p_db_r3->get_offset((int *) &index)] = 1e6*i + 1e3*j + k;
					p_by_r3->tensor.cell_byte  [p_by_r3->get_offset((int *) &index)] = 7*i + 5*j + 3*k;

					p_st_r3->set_string((int *) &index, month[(7*i + 5*j + 3*k) % 12]);
				}
			}
		}

		REQUIRE(p_db_r3->tensor.cell_double[334] == 12003001.0);
		REQUIRE(p_by_r3->tensor.cell_byte  [334] == 102);
		REQUIRE(!strcmp(p_st_r3->get_string(334), "July"));
		REQUIRE(!p_st_r3->p_string_buffer()->alloc_failed);

		check_and_close_jazz_block(p_db_r3);
		check_and_close_jazz_block(p_st_r3);
		check_and_close_jazz_block(p_by_r3);

		for (int i = 0; i < 2; i++) {
			for (int j = 0; j < 3; j++) {
				for (int k = 0; k < 2; k++) {
					for (int u = 0; u < 5; u++) {
						for (int v = 0; v < 2; v++) {
							for (int w = 0; w < 7; w++) {
								index[0] = i;
								index[1] = j;
								index[2] = k;
								index[3] = u;
								index[4] = v;
								index[5] = w;

								p_db_r6->tensor.cell_double[p_db_r6->get_offset((int *) &index)] = 1e8*i + 1e7*j + 1e6*k + 100*u + 11*v - w;
								p_by_r6->tensor.cell_byte  [p_by_r6->get_offset((int *) &index)] = 45*i + 34*j + 23*k + 12*u + 6*v + 3*w;

								p_st_r6->set_string((int *) &index, month[(45*i + 34*j + 23*k + 12*u + 6*v + 3*w) % 12]);
							}
						}
					}
				}
			}
		}

		REQUIRE(p_db_r6->tensor.cell_double[753] == 120000307.0);
		REQUIRE(p_by_r6->tensor.cell_byte  [753] == 167);
		REQUIRE(!strcmp(p_st_r6->get_string(753), "December"));
		REQUIRE(!p_st_r6->p_string_buffer()->alloc_failed);

		check_and_close_jazz_block(p_db_r6);
		check_and_close_jazz_block(p_st_r6);
		check_and_close_jazz_block(p_by_r6);

		dim_r1.dim[1] = 0;
		dim_r3.dim[1] = 0;
		dim_r6.dim[1] = 0;

		p_if_r1 = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim_r1.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &buff_1k);

		REQUIRE(p_if_r1 != nullptr);
		REQUIRE(p_if_r1->can_filter(p_db_r1));
		REQUIRE(p_if_r1->can_filter(p_st_r1));
		REQUIRE(p_if_r1->can_filter(p_by_r1));

		p_if_r3 = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim_r3.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &buff_1k);

		REQUIRE(p_if_r3 != nullptr);
		REQUIRE(p_if_r3->can_filter(p_db_r3));
		REQUIRE(p_if_r3->can_filter(p_st_r3));
		REQUIRE(p_if_r3->can_filter(p_by_r3));

		p_if_r6 = (pJazzFilter) new_jazz_block(CELL_TYPE_INTEGER, dim_r6.dim, nullptr, FILL_INTEGER_FILTER, (bool *) &buff_1k);

		REQUIRE(p_if_r6 != nullptr);
		REQUIRE(p_if_r6->can_filter(p_db_r6));
		REQUIRE(p_if_r6->can_filter(p_st_r6));
		REQUIRE(p_if_r6->can_filter(p_by_r6));

		p_bf_r1 = (pJazzFilter) new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim_r1.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &buff_1k);

		REQUIRE(p_bf_r1 != nullptr);
		REQUIRE(p_bf_r1->can_filter(p_db_r1));
		REQUIRE(p_bf_r1->can_filter(p_st_r1));
		REQUIRE(p_bf_r1->can_filter(p_by_r1));

		p_bf_r3 = (pJazzFilter) new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim_r3.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &buff_1k);

		REQUIRE(p_bf_r3 != nullptr);
		REQUIRE(p_bf_r3->can_filter(p_db_r3));
		REQUIRE(p_bf_r3->can_filter(p_st_r3));
		REQUIRE(p_bf_r3->can_filter(p_by_r3));

		p_bf_r6 = (pJazzFilter) new_jazz_block(CELL_TYPE_BYTE_BOOLEAN, dim_r6.dim, nullptr, FILL_BOOLEAN_FILTER, (bool *) &buff_1k);

		REQUIRE(p_bf_r6 != nullptr);
		REQUIRE(p_bf_r6->can_filter(p_db_r6));
		REQUIRE(p_bf_r6->can_filter(p_st_r6));
		REQUIRE(p_bf_r6->can_filter(p_by_r6));

		WHEN("I give wrong arguments, I get nullptr.") {
			pJazzBlock pcp;

			pcp = new_jazz_block(nullptr);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, p_bf_r3);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, p_bf_r6);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, p_if_r3);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, p_if_r6);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, p_bf_r1);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, p_bf_r6);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, p_if_r1);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, p_if_r6);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, p_bf_r1);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, p_bf_r3);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, p_if_r1);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, p_if_r3);
			REQUIRE(pcp == nullptr);

			AllAttributes all_att {};

			pcp = new_jazz_block(p_db_r1, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_db_r1, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_by_r3, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, nullptr, &all_att);
			REQUIRE(pcp == nullptr);

			pcp = new_jazz_block(p_st_r6, nullptr, &all_att);
			REQUIRE(pcp == nullptr);
		}

		WHEN("I create identical blocks") {
			pJazzBlock pcp_db_r1, pcp_db_r3, pcp_db_r6,
					   pcp_st_r1, pcp_st_r3, pcp_st_r6,
					   pcp_by_r1, pcp_by_r3, pcp_by_r6;

			pcp_db_r1 = new_jazz_block(p_db_r1);

			REQUIRE(pcp_db_r1 != nullptr);
			REQUIRE(pcp_db_r1->size == 107);

			pcp_db_r3 = new_jazz_block(p_db_r3);

			REQUIRE(pcp_db_r3 != nullptr);
			REQUIRE(pcp_db_r3->size == 459);

			pcp_db_r6 = new_jazz_block(p_db_r6);

			REQUIRE(pcp_db_r6 != nullptr);
			REQUIRE(pcp_db_r6->size == 840);

			pcp_st_r1 = new_jazz_block(p_st_r1);

			REQUIRE(pcp_st_r1 != nullptr);
			REQUIRE(pcp_st_r1->size == 107);

			pcp_st_r3 = new_jazz_block(p_st_r3);

			REQUIRE(pcp_st_r3 != nullptr);
			REQUIRE(pcp_st_r3->size == 459);

			pcp_st_r6 = new_jazz_block(p_st_r6);

			REQUIRE(pcp_st_r6 != nullptr);
			REQUIRE(pcp_st_r6->size == 840);

			pcp_by_r1 = new_jazz_block(p_by_r1);

			REQUIRE(pcp_by_r1 != nullptr);
			REQUIRE(pcp_by_r1->size == 107);

			pcp_by_r3 = new_jazz_block(p_by_r3);

			REQUIRE(pcp_by_r3 != nullptr);
			REQUIRE(pcp_by_r3->size == 459);

			pcp_by_r6 = new_jazz_block(p_by_r6);

			REQUIRE(pcp_by_r6 != nullptr);
			REQUIRE(pcp_by_r6->size == 840);

			THEN("Their structure is as expected.") {
				REQUIRE(pcp_db_r1->cell_type							 == p_db_r1->cell_type);
				REQUIRE(pcp_st_r6->cell_type							 == p_st_r6->cell_type);
				REQUIRE(pcp_by_r3->rank									 == p_by_r3->rank);
				REQUIRE(pcp_db_r1->rank									 == p_db_r1->rank);
				REQUIRE(pcp_st_r6->range.dim[0]							 == p_st_r6->range.dim[0]);

				REQUIRE(pcp_by_r3->range.dim[2]							 == p_by_r3->range.dim[2]);
				REQUIRE(pcp_db_r1->range.dim[3]							 == p_db_r1->range.dim[3]);
				REQUIRE(pcp_st_r6->size									 == p_st_r6->size);
				REQUIRE(pcp_by_r3->size									 == p_by_r3->size);
				REQUIRE(pcp_db_r1->num_attributes						 == p_db_r1->num_attributes);

				REQUIRE(pcp_st_r6->num_attributes						 == p_st_r6->num_attributes);
				REQUIRE(pcp_by_r3->total_bytes							 == p_by_r3->total_bytes);
				REQUIRE(pcp_db_r1->total_bytes							 == p_db_r1->total_bytes);
				REQUIRE(pcp_st_r6->has_NA								 == p_st_r6->has_NA);
				REQUIRE(pcp_by_r3->has_NA								 == p_by_r3->has_NA);

				REQUIRE(pcp_db_r1->has_NA								 == p_db_r1->has_NA);
				REQUIRE(pcp_st_r6->tensor.cell_int [67]					 == p_st_r6->tensor.cell_int [67]);
				REQUIRE(pcp_by_r3->tensor.cell_byte[13]					 == p_by_r3->tensor.cell_byte[13]);
				REQUIRE(pcp_db_r1->tensor.cell_double[33]				 == p_db_r1->tensor.cell_double[33]);
				REQUIRE(pcp_st_r6->tensor.cell_int[27]					 == p_st_r6->tensor.cell_int[27]);

				REQUIRE(pcp_by_r3->p_attribute_keys()[0]				 == p_by_r3->p_attribute_keys()[0]);
				REQUIRE(pcp_db_r1->p_string_buffer()->stop_check_4_match == p_db_r1->p_string_buffer()->stop_check_4_match);
				REQUIRE(pcp_st_r6->p_attribute_keys()[0]				 == p_st_r6->p_attribute_keys()[0]);
				REQUIRE(pcp_by_r3->p_string_buffer()->alloc_failed		 == p_by_r3->p_string_buffer()->alloc_failed);
				REQUIRE(pcp_db_r1->p_string_buffer()->last_idx			 == p_db_r1->p_string_buffer()->last_idx);

				REQUIRE(pcp_st_r6->p_string_buffer()->last_idx			 == p_st_r6->p_string_buffer()->last_idx);
				REQUIRE(pcp_by_r3->p_string_buffer()->last_idx			 == p_by_r3->p_string_buffer()->last_idx);
				REQUIRE(pcp_db_r1->p_string_buffer()->buffer_size		 == p_db_r1->p_string_buffer()->buffer_size);
				REQUIRE(pcp_st_r6->p_string_buffer()->buffer_size		 == p_st_r6->p_string_buffer()->buffer_size);
				REQUIRE(pcp_by_r3->p_string_buffer()->buffer[3]			 == p_by_r3->p_string_buffer()->buffer[3]);

				REQUIRE(pcp_db_r1->p_string_buffer()->buffer[4]			 == p_db_r1->p_string_buffer()->buffer[4]);
				REQUIRE(pcp_st_r6->p_string_buffer()->buffer[20]		 == p_st_r6->p_string_buffer()->buffer[20]);

				REQUIRE(!strcmp(pcp_db_r1->find_attribute(256), "Life's but a walking shadow"));
				REQUIRE(!strcmp(pcp_st_r6->find_attribute(313), "... a poor player"));
				REQUIRE(!strcmp(pcp_by_r3->find_attribute(921), "that struts and frets his hour"));
				REQUIRE(!strcmp(pcp_db_r1->find_attribute(222), "upon the stage and"));
				REQUIRE(!strcmp(pcp_st_r6->find_attribute(321), "then ..."));
				REQUIRE(pcp_by_r3->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)	== nullptr);
				REQUIRE(pcp_db_r1->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);
				REQUIRE(pcp_st_r6->find_attribute(486)							== nullptr);
				REQUIRE(pcp_by_r3->find_attribute(487)							== nullptr);

				REQUIRE(!strcmp(pcp_db_r3->find_attribute(123), ""));
				REQUIRE(!strcmp(pcp_st_r1->find_attribute(456), ""));
				REQUIRE(!strcmp(pcp_by_r6->find_attribute(123), ""));
				REQUIRE(pcp_db_r3->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)	== nullptr);
				REQUIRE(pcp_st_r1->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);
				REQUIRE(pcp_by_r6->find_attribute(487)							== nullptr);

				REQUIRE(!strcmp(pcp_db_r6->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY), ""));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY), ""));
				REQUIRE(!strcmp(pcp_by_r1->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY), ""));
				REQUIRE(pcp_db_r6->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);
				REQUIRE(pcp_st_r3->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);
				REQUIRE(pcp_by_r1->find_attribute(487)							== nullptr);

				REQUIRE(pcp_db_r1->tensor.cell_double[33] == 3.3);
				REQUIRE(pcp_by_r1->tensor.cell_byte	 [33] == 73);
				REQUIRE(!strcmp(pcp_st_r1->get_string(15), "April"));
				REQUIRE(!pcp_st_r1->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(pcp_db_r1);
				check_and_close_jazz_block(pcp_st_r1);
				check_and_close_jazz_block(pcp_by_r1);

				REQUIRE(pcp_db_r3->tensor.cell_double[334] == 12003001.0);
				REQUIRE(pcp_by_r3->tensor.cell_byte	 [334] == 102);
				REQUIRE(!strcmp(pcp_st_r3->get_string(334), "July"));
				REQUIRE(!pcp_st_r3->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(pcp_db_r3);
				check_and_close_jazz_block(pcp_st_r3);
				check_and_close_jazz_block(pcp_by_r3);

				REQUIRE(pcp_db_r6->tensor.cell_double[753] == 120000307.0);
				REQUIRE(pcp_by_r6->tensor.cell_byte	 [753] == 167);
				REQUIRE(!strcmp(pcp_st_r6->get_string(753), "December"));
				REQUIRE(!pcp_st_r6->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(pcp_db_r6);
				check_and_close_jazz_block(pcp_st_r6);
				check_and_close_jazz_block(pcp_by_r6);
			}

			free_jazz_block(pcp_db_r1);
			REQUIRE(pcp_db_r1 == nullptr);

			free_jazz_block(pcp_db_r3);
			REQUIRE(pcp_db_r3 == nullptr);

			free_jazz_block(pcp_db_r6);
			REQUIRE(pcp_db_r6 == nullptr);

			free_jazz_block(pcp_st_r1);
			REQUIRE(pcp_st_r1 == nullptr);

			free_jazz_block(pcp_st_r3);
			REQUIRE(pcp_st_r3 == nullptr);

			free_jazz_block(pcp_st_r6);
			REQUIRE(pcp_st_r6 == nullptr);

			free_jazz_block(pcp_by_r1);
			REQUIRE(pcp_by_r1 == nullptr);

			free_jazz_block(pcp_by_r3);
			REQUIRE(pcp_by_r3 == nullptr);

			free_jazz_block(pcp_by_r6);
			REQUIRE(pcp_by_r6 == nullptr);
		}

		WHEN("I create identical blocks with different attributes") {
			pJazzBlock pcp_db_r1, pcp_db_r3, pcp_db_r6,
					   pcp_st_r1, pcp_st_r3, pcp_st_r6,
					   pcp_by_r1, pcp_by_r3, pcp_by_r6;

			pcp_db_r1 = new_jazz_block(p_db_r1, nullptr, &new_str);

			REQUIRE(pcp_db_r1 != nullptr);
			REQUIRE(pcp_db_r1->size == 107);

			pcp_db_r3 = new_jazz_block(p_db_r3, nullptr, &new_str);

			REQUIRE(pcp_db_r3 != nullptr);
			REQUIRE(pcp_db_r3->size == 459);

			pcp_db_r6 = new_jazz_block(p_db_r6, nullptr, &no_str);

			REQUIRE(pcp_db_r6 != nullptr);
			REQUIRE(pcp_db_r6->size == 840);

			pcp_st_r1 = new_jazz_block(p_st_r1, nullptr, &new_str);

			REQUIRE(pcp_st_r1 != nullptr);
			REQUIRE(pcp_st_r1->size == 107);

			pcp_st_r3 = new_jazz_block(p_st_r3, nullptr, &new_str);

			REQUIRE(pcp_st_r3 != nullptr);
			REQUIRE(pcp_st_r3->size == 459);

			pcp_st_r6 = new_jazz_block(p_st_r6, nullptr, &no_str);

			REQUIRE(pcp_st_r6 != nullptr);
			REQUIRE(pcp_st_r6->size == 840);

			pcp_by_r1 = new_jazz_block(p_by_r1, nullptr, &new_str);

			REQUIRE(pcp_by_r1 != nullptr);
			REQUIRE(pcp_by_r1->size == 107);

			pcp_by_r3 = new_jazz_block(p_by_r3, nullptr, &new_str);

			REQUIRE(pcp_by_r3 != nullptr);
			REQUIRE(pcp_by_r3->size == 459);

			pcp_by_r6 = new_jazz_block(p_by_r6, nullptr, &no_str);

			REQUIRE(pcp_by_r6 != nullptr);
			REQUIRE(pcp_by_r6->size == 840);

			THEN("Their structure is as expected.") {
				REQUIRE(pcp_db_r1->cell_type							 == p_db_r1->cell_type);
				REQUIRE(pcp_st_r6->cell_type							 == p_st_r6->cell_type);
				REQUIRE(pcp_by_r3->rank									 == p_by_r3->rank);
				REQUIRE(pcp_db_r1->rank									 == p_db_r1->rank);
				REQUIRE(pcp_st_r6->range.dim[0]							 == p_st_r6->range.dim[0]);

				REQUIRE(pcp_by_r3->range.dim[2]							 == p_by_r3->range.dim[2]);
				REQUIRE(pcp_db_r1->range.dim[3]							 == p_db_r1->range.dim[3]);
				REQUIRE(pcp_st_r6->size									 == p_st_r6->size);
				REQUIRE(pcp_by_r3->size									 == p_by_r3->size);
				REQUIRE(pcp_db_r1->num_attributes						 == 6);

				REQUIRE(pcp_st_r6->num_attributes						 == 2);
				REQUIRE(pcp_by_r3->total_bytes							 == p_by_r3->total_bytes);
				REQUIRE(pcp_db_r1->total_bytes							 == p_db_r1->total_bytes);	// Same number of chars in old and new
				REQUIRE(pcp_st_r6->has_NA								 == p_st_r6->has_NA);
				REQUIRE(pcp_by_r3->has_NA								 == p_by_r3->has_NA);

				REQUIRE(pcp_db_r1->has_NA								 == p_db_r1->has_NA);
				REQUIRE(pcp_st_r6->tensor.cell_int [67]					 == p_st_r6->tensor.cell_int [67]);
				REQUIRE(pcp_by_r3->tensor.cell_byte[13]					 == p_by_r3->tensor.cell_byte[13]);
				REQUIRE(pcp_db_r1->tensor.cell_double[33]				 == p_db_r1->tensor.cell_double[33]);
				REQUIRE(pcp_st_r6->tensor.cell_int[27]					 == p_st_r6->tensor.cell_int[27]);

				REQUIRE(pcp_db_r1->p_string_buffer()->stop_check_4_match == p_db_r1->p_string_buffer()->stop_check_4_match);
				REQUIRE(pcp_by_r3->p_string_buffer()->alloc_failed		 == p_by_r3->p_string_buffer()->alloc_failed);

				REQUIRE(!strcmp(pcp_db_r1->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(pcp_st_r1->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(pcp_by_r1->find_attribute(358), "told by an idiot.."));
				REQUIRE(!strcmp(pcp_db_r3->find_attribute(222), "full of sound and fury.."));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(676), "signifying .."));
				REQUIRE(pcp_by_r3->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)	== nullptr);
				REQUIRE(pcp_db_r1->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);
				REQUIRE(pcp_st_r1->find_attribute(486)							== nullptr);
				REQUIRE(pcp_by_r1->find_attribute(487)							== nullptr);
				REQUIRE(!strcmp(pcp_db_r3->find_attribute(321), "NULL"));

				REQUIRE(!strcmp(pcp_st_r6->find_attribute(456), ""));
				REQUIRE(!strcmp(pcp_by_r6->find_attribute(123), ""));
				REQUIRE(pcp_db_r6->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY)	== nullptr);
				REQUIRE(pcp_st_r6->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);

				REQUIRE(pcp_db_r1->tensor.cell_double[33] == 3.3);
				REQUIRE(pcp_by_r1->tensor.cell_byte	 [33] == 73);
				REQUIRE(!strcmp(pcp_st_r1->get_string(15), "April"));
				REQUIRE(!pcp_st_r1->p_string_buffer()->alloc_failed);

				// Not a string, from old_str to new_str:
				REQUIRE(pcp_db_r1->total_bytes					  == p_db_r1->total_bytes);
				REQUIRE(pcp_db_r1->p_string_buffer()->buffer_size == p_db_r1->p_string_buffer()->buffer_size - 8);	// 8 bytes == keys 1+ attr
				REQUIRE(pcp_db_r1->p_string_buffer()->last_idx	  == p_db_r1->p_string_buffer()->last_idx - 8);

				REQUIRE(!strcmp(pcp_db_r1->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(pcp_db_r1->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(pcp_db_r1->find_attribute(358), "told by an idiot.."));
				REQUIRE(!strcmp(pcp_db_r1->find_attribute(222), "full of sound and fury.."));
				REQUIRE(!strcmp(pcp_db_r1->find_attribute(676), "signifying .."));
				REQUIRE(!strcmp(pcp_db_r1->find_attribute(321), "NULL"));

				// Not a string, from nullptr to new_str:
				REQUIRE(pcp_by_r1->total_bytes					  == p_by_r1->total_bytes + 8*5 + 97);
				REQUIRE(pcp_by_r1->p_string_buffer()->buffer_size == pcp_db_r1->p_string_buffer()->buffer_size);
				REQUIRE(pcp_by_r1->p_string_buffer()->last_idx	  == pcp_db_r1->p_string_buffer()->last_idx);

				// String, from no_str to new_str:
				REQUIRE(pcp_st_r1->total_bytes					  == p_st_r1->total_bytes + 8*4 + 97);
				REQUIRE(pcp_st_r1->num_attributes				  == p_st_r1->num_attributes + 4);

				REQUIRE(pcp_st_r1->p_string_buffer()->buffer_size == p_st_r1->p_string_buffer()->buffer_size + 97);

				// String, from nullptr to new_str:
				REQUIRE(pcp_st_r3->total_bytes					  == p_st_r3->total_bytes + 8*5 + 97);
				REQUIRE(pcp_st_r3->p_string_buffer()->buffer_size == p_st_r3->p_string_buffer()->buffer_size + 97);

				REQUIRE(!strcmp(pcp_st_r3->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(358), "told by an idiot.."));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(222), "full of sound and fury.."));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(676), "signifying .."));
				REQUIRE(!strcmp(pcp_st_r3->find_attribute(321), "NULL"));

				// String, from old_str to no_str:
				REQUIRE(pcp_st_r6->total_bytes					  == p_st_r6->total_bytes - 8*3);
				REQUIRE(pcp_st_r6->p_string_buffer()->buffer_size == p_st_r6->p_string_buffer()->buffer_size);
				REQUIRE(pcp_st_r6->p_string_buffer()->last_idx	  == p_st_r6->p_string_buffer()->last_idx);
				REQUIRE(!strcmp(pcp_st_r6->find_attribute(456), ""));
				REQUIRE(!strcmp(pcp_st_r6->find_attribute(123), ""));
				REQUIRE(pcp_st_r6->find_attribute(654) == nullptr);

				for (int i = 0; i < 10; i++) {
					REQUIRE(pcp_st_r1->tensor.cell_int[i] == p_st_r1->tensor.cell_int[i]);
					REQUIRE(pcp_st_r3->tensor.cell_int[i] == p_st_r3->tensor.cell_int[i]);
					REQUIRE(pcp_st_r6->tensor.cell_int[i] == p_st_r6->tensor.cell_int[i]);
				}

				check_and_close_jazz_block(pcp_db_r1);
				check_and_close_jazz_block(pcp_st_r1);
				check_and_close_jazz_block(pcp_by_r1);

				REQUIRE(pcp_db_r3->tensor.cell_double[334] == 12003001.0);
				REQUIRE(pcp_by_r3->tensor.cell_byte	 [334] == 102);
				REQUIRE(!strcmp(pcp_st_r3->get_string(334), "July"));
				REQUIRE(!pcp_st_r3->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(pcp_db_r3);
				check_and_close_jazz_block(pcp_st_r3);
				check_and_close_jazz_block(pcp_by_r3);

				REQUIRE(pcp_db_r6->tensor.cell_double[753] == 120000307.0);
				REQUIRE(pcp_by_r6->tensor.cell_byte	 [753] == 167);
				REQUIRE(!strcmp(pcp_st_r6->get_string(753), "December"));
				REQUIRE(!pcp_st_r6->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(pcp_db_r6);
				check_and_close_jazz_block(pcp_st_r6);
				check_and_close_jazz_block(pcp_by_r6);
			}

			free_jazz_block(pcp_db_r1);
			REQUIRE(pcp_db_r1 == nullptr);

			free_jazz_block(pcp_db_r3);
			REQUIRE(pcp_db_r3 == nullptr);

			free_jazz_block(pcp_db_r6);
			REQUIRE(pcp_db_r6 == nullptr);

			free_jazz_block(pcp_st_r1);
			REQUIRE(pcp_st_r1 == nullptr);

			free_jazz_block(pcp_st_r3);
			REQUIRE(pcp_st_r3 == nullptr);

			free_jazz_block(pcp_st_r6);
			REQUIRE(pcp_st_r6 == nullptr);

			free_jazz_block(pcp_by_r1);
			REQUIRE(pcp_by_r1 == nullptr);

			free_jazz_block(pcp_by_r3);
			REQUIRE(pcp_by_r3 == nullptr);

			free_jazz_block(pcp_by_r6);
			REQUIRE(pcp_by_r6 == nullptr);
		}

		WHEN("I filter with all combinations of blocks an filters") {
			pJazzBlock p_pa_db_r1, p_pa_db_r3, p_pa_db_r6,
					   p_pa_st_r1, p_pa_st_r3, p_pa_st_r6,
					   p_pa_by_r1, p_pa_by_r3, p_pa_by_r6,
					   p_pb_db_r1, p_pb_db_r3, p_pb_db_r6,
					   p_pb_st_r1, p_pb_st_r3, p_pb_st_r6,
					   p_pb_by_r1, p_pb_by_r3, p_pb_by_r6;

			// Select all elements with binary, correct, and integer fitting dimension properly
			for (int i = 0; i < p_if_r1->size; i++) {
				p_if_r1->tensor.cell_int[i]	 = i;
				p_bf_r1->tensor.cell_bool[i] = true;
			}
			p_if_r1->range.filter.length = p_if_r1->size;

			for (int i = 0; i < p_if_r3->size; i++) {
				p_if_r3->tensor.cell_int[i]	 = 0;
				p_bf_r3->tensor.cell_bool[i] = true;
			}
			p_if_r3->range.filter.length = p_if_r3->size;

			for (int i = 0; i < p_if_r6->size; i++) {
				p_if_r6->tensor.cell_int[i]	 = -i;
				p_bf_r6->tensor.cell_bool[i] = true;
			}
			p_if_r6->range.filter.length = p_if_r6->size;

			p_pa_db_r1 = new_jazz_block(p_db_r1, p_if_r1);

			REQUIRE(p_pa_db_r1 != nullptr);
			REQUIRE(p_pa_db_r1->size == 107);

			p_pa_db_r3 = new_jazz_block(p_db_r3, p_if_r3);

			REQUIRE(p_pa_db_r3 != nullptr);
			REQUIRE(p_pa_db_r3->size == 459);

			p_pa_db_r6 = new_jazz_block(p_db_r6, p_if_r6, &no_str);

			REQUIRE(p_pa_db_r6 != nullptr);
			REQUIRE(p_pa_db_r6->size == 840);

			p_pa_st_r1 = new_jazz_block(p_st_r1, p_bf_r1);

			REQUIRE(p_pa_st_r1 != nullptr);
			REQUIRE(p_pa_st_r1->size == 107);

			p_pa_st_r3 = new_jazz_block(p_st_r3, p_bf_r3);

			REQUIRE(p_pa_st_r3 != nullptr);
			REQUIRE(p_pa_st_r3->size == 459);

			p_pa_st_r6 = new_jazz_block(p_st_r6, p_bf_r6, &new_str);

			REQUIRE(p_pa_st_r6 != nullptr);
			REQUIRE(p_pa_st_r6->size == 840);

			// Select no elements with binary and integer
			for (int i = 0; i < p_if_r1->size; i++) {
				p_bf_r1->tensor.cell_bool[i] = false;
			}
			p_if_r1->range.filter.length = 0;

			for (int i = 0; i < p_if_r3->size; i++) {
				p_bf_r3->tensor.cell_bool[i] = false;
			}
			p_if_r3->range.filter.length = 0;

			for (int i = 0; i < p_if_r6->size; i++) {
				p_bf_r6->tensor.cell_bool[i] = false;
			}
			p_if_r6->range.filter.length = 0;

			p_pa_by_r1 = new_jazz_block(p_by_r1, p_if_r1);

			REQUIRE(p_pa_by_r1 != nullptr);
			REQUIRE(p_pa_by_r1->size == 0);
			REQUIRE(p_pa_by_r1->rank == 1);

			p_pa_by_r3 = new_jazz_block(p_by_r3, p_if_r3, &new_str);

			REQUIRE(p_pa_by_r3 != nullptr);
			REQUIRE(p_pa_by_r3->size == 0);
			REQUIRE(p_pa_by_r3->rank == 3);

			p_pa_by_r6 = new_jazz_block(p_by_r6, p_if_r6);

			REQUIRE(p_pa_by_r6 != nullptr);
			REQUIRE(p_pa_by_r6->size == 0);
			REQUIRE(p_pa_by_r6->rank == 6);

			p_pb_db_r1 = new_jazz_block(p_db_r1, p_bf_r1);

			REQUIRE(p_pb_db_r1 != nullptr);
			REQUIRE(p_pb_db_r1->size == 0);
			REQUIRE(p_pb_db_r1->rank == 1);

			p_pb_db_r3 = new_jazz_block(p_db_r3, p_bf_r3, &no_str);

			REQUIRE(p_pb_db_r3 != nullptr);
			REQUIRE(p_pb_db_r3->size == 0);
			REQUIRE(p_pb_db_r3->rank == 3);

			p_pb_db_r6 = new_jazz_block(p_db_r6, p_bf_r6);

			REQUIRE(p_pb_db_r6 != nullptr);
			REQUIRE(p_pb_db_r6->size == 0);
			REQUIRE(p_pb_db_r6->rank == 6);

			// Select some elements with binary and integer	 - dim_r1 {{107, 0}}, dim_r3 {{17, 9, 3, 0}}, dim_r6 {{2, 3, 2, 5, 2, 7}};
			for (int i = 0; i < p_if_r1->size; i++) {
				p_if_r1->tensor.cell_int[i]	 = 3*i + 4;
				p_bf_r1->tensor.cell_bool[i] = i % 3 == 2;
			}
			p_if_r1->range.filter.length = 17;

			for (int i = 0; i < p_if_r3->size; i++) {
				p_if_r3->tensor.cell_int[i]	 = i;
				p_bf_r3->tensor.cell_bool[i] = i % 4 == 2;
			}
			p_if_r3->range.filter.length = 7;

			for (int i = 0; i < p_if_r6->size; i++) {
				p_if_r6->tensor.cell_int[i]	 = 1;
				p_bf_r6->tensor.cell_bool[i] = i == 0;
			}
			p_if_r6->range.filter.length = 1;

			p_pb_st_r1 = new_jazz_block(p_st_r1, p_if_r1, &no_str);

			REQUIRE(p_pb_st_r1 != nullptr);
			REQUIRE(p_pb_st_r1->size == 17);

			p_pb_st_r3 = new_jazz_block(p_st_r3, p_if_r3);

			REQUIRE(p_pb_st_r3 != nullptr);
			REQUIRE(p_pb_st_r3->size == 189);

			p_pb_st_r6 = new_jazz_block(p_st_r6, p_if_r6);

			REQUIRE(p_pb_st_r6 != nullptr);
			REQUIRE(p_pb_st_r6->size == 420);

			p_pb_by_r1 = new_jazz_block(p_by_r1, p_bf_r1, &new_str);

			REQUIRE(p_pb_by_r1 != nullptr);
			REQUIRE(p_pb_by_r1->size == 35);

			p_pb_by_r3 = new_jazz_block(p_by_r3, p_bf_r3);

			REQUIRE(p_pb_by_r3 != nullptr);
			REQUIRE(p_pb_by_r3->size == 108);

			p_pb_by_r6 = new_jazz_block(p_by_r6, p_bf_r6);

			REQUIRE(p_pb_by_r6 != nullptr);
			REQUIRE(p_pb_by_r6->size == 420);

			THEN("Their structure is as expected.") {
				REQUIRE(p_pa_db_r1->cell_type							  == p_db_r1->cell_type);
				REQUIRE(p_pa_st_r6->cell_type							  == p_st_r6->cell_type);
				REQUIRE(p_pa_db_r3->rank								  == p_db_r3->rank);
				REQUIRE(p_pa_db_r1->rank								  == p_db_r1->rank);
				REQUIRE(p_pa_st_r6->range.dim[0]						  == p_st_r6->range.dim[0]);

				REQUIRE(p_pa_db_r3->range.dim[2]						  == p_db_r3->range.dim[2]);
				REQUIRE(p_pa_st_r1->range.dim[3]						  == p_st_r1->range.dim[3]);
				REQUIRE(p_pa_st_r6->size								  == p_st_r6->size);
				REQUIRE(p_pa_db_r3->size								  == p_db_r3->size);
				REQUIRE(p_pa_db_r1->num_attributes						  == p_db_r1->num_attributes);

				REQUIRE(p_pa_st_r6->num_attributes						  == 6);
				REQUIRE(p_pa_st_r3->total_bytes							  == p_st_r3->total_bytes);
				REQUIRE(p_pa_db_r1->total_bytes							  == p_db_r1->total_bytes);
				REQUIRE(p_pa_st_r6->has_NA								  == p_st_r6->has_NA);
				REQUIRE(p_pa_db_r3->has_NA								  == p_db_r3->has_NA);

				REQUIRE(p_pa_db_r1->has_NA								  == p_db_r1->has_NA);
				REQUIRE(p_pa_st_r6->tensor.cell_int [67]				  == p_st_r6->tensor.cell_int [67]);
				REQUIRE(p_pa_db_r3->tensor.cell_byte[13]				  == p_db_r3->tensor.cell_byte[13]);
				REQUIRE(p_pa_db_r1->tensor.cell_double[33]				  == p_db_r1->tensor.cell_double[33]);
				REQUIRE(p_pa_st_r6->tensor.cell_int[27]					  == p_st_r6->tensor.cell_int[27]);

				REQUIRE(p_pa_db_r3->p_attribute_keys()[0]				  == p_db_r3->p_attribute_keys()[0]);
				REQUIRE(p_pa_db_r1->p_string_buffer()->stop_check_4_match == p_db_r1->p_string_buffer()->stop_check_4_match);
				REQUIRE(p_pa_db_r1->p_string_buffer()->last_idx			  == p_db_r1->p_string_buffer()->last_idx);
				REQUIRE(p_pa_db_r3->p_string_buffer()->last_idx			  == p_db_r3->p_string_buffer()->last_idx);
				REQUIRE(p_pa_db_r1->p_string_buffer()->buffer_size		  == p_db_r1->p_string_buffer()->buffer_size);
				REQUIRE(p_pa_db_r3->p_string_buffer()->buffer[3]		  == p_db_r3->p_string_buffer()->buffer[3]);

				REQUIRE(p_pa_db_r1->p_string_buffer()->buffer[4]		  == p_db_r1->p_string_buffer()->buffer[4]);

				REQUIRE(!strcmp(p_pa_db_r1->find_attribute(256), "Life's but a walking shadow"));
				REQUIRE(!strcmp(p_pa_db_r3->find_attribute(123), ""));
				REQUIRE(!strcmp(p_pa_db_r6->find_attribute(456), ""));

				REQUIRE(p_pa_st_r1->find_attribute(BLOCK_ATTR_CONTAINERS_FILTER) == nullptr);
				REQUIRE(!strcmp(p_pa_st_r3->find_attribute(BLOCK_ATTR_CONTAINERS_EMPTY), ""));

				REQUIRE(!strcmp(p_pa_st_r6->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(p_pa_st_r6->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(p_pa_st_r6->find_attribute(358), "told by an idiot.."));

				REQUIRE(p_pa_db_r1->tensor.cell_double[33] == 3.3);
				REQUIRE(!strcmp(p_pa_st_r1->get_string(15), "April"));
				REQUIRE(!p_pa_st_r1->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(p_pa_db_r1);
				check_and_close_jazz_block(p_pa_st_r1);

				REQUIRE(p_pa_db_r3->tensor.cell_double[334] == 12003001.0);
				REQUIRE(!strcmp(p_pa_st_r3->get_string(334), "July"));
				REQUIRE(!p_pa_st_r3->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(p_pa_db_r3);
				check_and_close_jazz_block(p_pa_st_r3);

				REQUIRE(p_pa_db_r6->tensor.cell_double[753] == 120000307.0);
				REQUIRE(!strcmp(p_pa_st_r6->get_string(753), "December"));
				REQUIRE(!p_pa_st_r6->p_string_buffer()->alloc_failed);

				check_and_close_jazz_block(p_pa_db_r6);
				check_and_close_jazz_block(p_pa_st_r6);

				int index[6];

				for (int i = 0; i < 107; i++) {
					index[0] = i;

					REQUIRE(p_pa_db_r1->tensor.cell_double[p_pa_db_r1->get_offset((int *) &index)] == i/10.0);

					REQUIRE(!strcmp(p_pa_st_r1->get_string((int *) &index), month[i % 12]));
					REQUIRE(p_pa_st_r1->tensor.cell_int[p_pa_st_r1->get_offset((int *) &index)] ==
							p_st_r1->tensor.cell_int[p_st_r1->get_offset((int *) &index)]);
				}

				for (int i = 0; i < 17; i++) {
					for (int j = 0; j < 9; j++) {
						for (int k = 0; k < 3; k++) {
							index[0] = i;
							index[1] = j;
							index[2] = k;

							REQUIRE(p_pa_db_r3->tensor.cell_double[p_pa_db_r3->get_offset((int *) &index)] == 1e6*i + 1e3*j + k);

							REQUIRE(!strcmp(p_pa_st_r3->get_string((int *) &index), month[(7*i + 5*j + 3*k) % 12]));
							REQUIRE(p_pa_st_r3->tensor.cell_int[p_pa_st_r3->get_offset((int *) &index)] ==
									p_st_r3->tensor.cell_int[p_st_r3->get_offset((int *) &index)]);
						}
					}
				}

				for (int i = 0; i < 2; i++) {
					for (int j = 0; j < 3; j++) {
						for (int k = 0; k < 2; k++) {
							for (int u = 0; u < 5; u++) {
								for (int v = 0; v < 2; v++) {
									for (int w = 0; w < 7; w++) {
										index[0] = i;
										index[1] = j;
										index[2] = k;
										index[3] = u;
										index[4] = v;
										index[5] = w;

										REQUIRE(p_pa_db_r6->tensor.cell_double[p_pa_db_r6->get_offset((int *) &index)] ==
												1e8*i + 1e7*j + 1e6*k + 100*u + 11*v - w);

										REQUIRE(!strcmp(p_pa_st_r6->get_string((int *) &index),
														month[(45*i + 34*j + 23*k + 12*u + 6*v + 3*w) % 12]));
										REQUIRE(p_pa_st_r6->tensor.cell_int[p_pa_st_r6->get_offset((int *) &index)] ==
												p_st_r6->tensor.cell_int[p_st_r6->get_offset((int *) &index)]);
									}
								}
							}
						}
					}
				}

				REQUIRE(p_pa_by_r1->cell_type	   == p_by_r1->cell_type);
				REQUIRE(p_pb_db_r6->cell_type	   == p_db_r6->cell_type);
				REQUIRE(p_pa_by_r3->rank		   == p_by_r3->rank);
				REQUIRE(p_pb_db_r1->rank		   == p_db_r1->rank);
				REQUIRE(p_pa_by_r6->range.dim[0]   == p_by_r6->range.dim[0]);
				REQUIRE(p_pa_by_r3->range.dim[2]   == p_by_r3->range.dim[2]);
				REQUIRE(p_pb_db_r1->range.dim[3]   == p_db_r1->range.dim[3]);
				REQUIRE(p_pb_db_r6->size		   == 0);
				REQUIRE(p_pa_by_r3->size		   == 0);
				REQUIRE(p_pb_db_r1->num_attributes == p_db_r1->num_attributes);
				REQUIRE(p_pa_by_r6->num_attributes == p_by_r6->num_attributes);

				REQUIRE(p_pa_by_r1->total_bytes	   == p_by_r1->total_bytes - (uintptr_t) p_pa_by_r1->align_128bit(p_by_r1->size));
				REQUIRE(p_pa_by_r3->total_bytes	   == p_by_r3->total_bytes - (uintptr_t) p_pa_by_r3->align_128bit(p_by_r3->size));
				REQUIRE(p_pa_by_r6->total_bytes	   == p_by_r6->total_bytes - (uintptr_t) p_pa_by_r6->align_128bit(p_by_r6->size));
				REQUIRE(p_pb_db_r1->total_bytes	   == p_db_r1->total_bytes - (uintptr_t) p_pb_db_r1->align_128bit(8*p_db_r1->size));
				REQUIRE(p_pb_db_r3->total_bytes	   == p_db_r3->total_bytes - (uintptr_t) p_pb_db_r3->align_128bit(8*p_db_r3->size));
				REQUIRE(p_pb_db_r6->total_bytes	   == p_db_r6->total_bytes - (uintptr_t) p_pb_db_r6->align_128bit(8*p_db_r6->size));

				REQUIRE(!p_pa_by_r1->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pa_by_r3->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pa_by_r6->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_db_r1->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_db_r3->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_db_r6->p_string_buffer()->alloc_failed);

				REQUIRE(!strcmp(p_pb_db_r3->find_attribute(123), ""));
				REQUIRE(!strcmp(p_pb_db_r3->find_attribute(456), ""));

				REQUIRE(!strcmp(p_pa_by_r3->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(p_pa_by_r3->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(p_pa_by_r3->find_attribute(358), "told by an idiot.."));

				check_and_close_jazz_block(p_pb_db_r1);
				check_and_close_jazz_block(p_pa_by_r1);

				check_and_close_jazz_block(p_pb_db_r3);
				check_and_close_jazz_block(p_pa_by_r3);

				check_and_close_jazz_block(p_pb_db_r6);
				check_and_close_jazz_block(p_pa_by_r6);

				REQUIRE(p_pb_by_r1->cell_type	   == p_by_r1->cell_type);
				REQUIRE(p_pb_st_r6->cell_type	   == p_st_r6->cell_type);
				REQUIRE(p_pb_by_r3->rank		   == p_by_r3->rank);
				REQUIRE(p_pb_st_r1->rank		   == p_st_r1->rank);
				REQUIRE(p_pb_st_r6->range.dim[0]   == p_st_r6->range.dim[0]);
				REQUIRE(p_pb_by_r3->range.dim[2]   == p_by_r3->range.dim[2]);
				REQUIRE(p_pb_st_r1->range.dim[3]   == p_st_r1->range.dim[3]);
				REQUIRE(p_pb_st_r1->num_attributes == 2);
				REQUIRE(p_pb_st_r3->num_attributes == p_st_r3->num_attributes);
				REQUIRE(p_pb_st_r6->num_attributes == p_st_r6->num_attributes);
				REQUIRE(p_pb_by_r1->num_attributes == 6);
				REQUIRE(p_pb_by_r3->num_attributes == p_by_r3->num_attributes);
				REQUIRE(p_pb_by_r6->num_attributes == p_by_r6->num_attributes);

				REQUIRE(p_pb_st_r1->total_bytes ==
						p_st_r1->total_bytes
						- (uintptr_t) p_pb_st_r1->align_128bit(4*(p_st_r1->size))
						+ (uintptr_t) p_pb_st_r1->align_128bit(4*(p_pb_st_r1->size)));
				REQUIRE(p_pb_st_r3->total_bytes ==
						p_st_r3->total_bytes
						- (uintptr_t) p_pb_st_r3->align_128bit(4*(p_st_r3->size))
						+ (uintptr_t) p_pb_st_r3->align_128bit(4*(p_pb_st_r3->size)));
				REQUIRE(p_pb_st_r6->total_bytes ==
						p_st_r6->total_bytes
						- (uintptr_t) p_pb_st_r6->align_128bit(4*(p_st_r6->size))
						+ (uintptr_t) p_pb_st_r6->align_128bit(4*(p_pb_st_r6->size)));
				REQUIRE(p_pb_by_r1->total_bytes ==
						p_by_r1->total_bytes + p_pb_by_r1->p_string_buffer()->buffer_size - 4 + 2*(6 -1)*sizeof(int)
						- (uintptr_t) p_pb_by_r1->align_128bit(p_by_r1->size)
						+ (uintptr_t) p_pb_by_r1->align_128bit(p_pb_by_r1->size));
				REQUIRE(p_pb_by_r3->total_bytes ==
						p_by_r3->total_bytes
						- (uintptr_t) p_pb_by_r3->align_128bit(p_by_r3->size)
						+ (uintptr_t) p_pb_by_r3->align_128bit(p_pb_by_r3->size));
				REQUIRE(p_pb_by_r6->total_bytes ==
						p_by_r6->total_bytes
						- (uintptr_t) p_pb_by_r6->align_128bit(p_by_r6->size)
						+ (uintptr_t) p_pb_by_r6->align_128bit(p_pb_by_r6->size));

				REQUIRE(!p_pb_by_r1->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_by_r3->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_by_r6->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_st_r1->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_st_r3->p_string_buffer()->alloc_failed);
				REQUIRE(!p_pb_st_r6->p_string_buffer()->alloc_failed);

				REQUIRE(!strcmp(p_pb_st_r1->find_attribute(123), ""));
				REQUIRE(!strcmp(p_pb_st_r1->find_attribute(456), ""));

				REQUIRE(!strcmp(p_pb_by_r1->find_attribute(921), "is heard nomore ..."));
				REQUIRE(!strcmp(p_pb_by_r1->find_attribute(313), "It's a tale.."));
				REQUIRE(!strcmp(p_pb_by_r1->find_attribute(358), "told by an idiot.."));

				check_and_close_jazz_block(p_pb_st_r1);
				check_and_close_jazz_block(p_pb_by_r1);

				check_and_close_jazz_block(p_pb_st_r3);
				check_and_close_jazz_block(p_pb_by_r3);

				check_and_close_jazz_block(p_pb_st_r6);
				check_and_close_jazz_block(p_pb_by_r6);

				int index_o[6];
				int i_i = 0, i_b = 0;

				for (int i_o = 0; i_o < 107; i_o++) {
					if (p_bf_r1->tensor.cell_bool[i_o]) {
						index[0] = i_b;

						REQUIRE(p_pb_by_r1->tensor.cell_byte[p_pb_by_r1->get_offset((int *) &index)] == 7 + 2*i_o);

						i_b++;
					}
					if (i_i < p_if_r1->range.filter.length && p_if_r1->tensor.cell_int[i_i] == i_o) {
						index[0]   = i_i;
						index_o[0] = i_o;

						REQUIRE(!strcmp(p_pb_st_r1->get_string((int *) &index), month[i_o % 12]));
						REQUIRE(p_pb_st_r1->tensor.cell_int[p_pb_st_r1->get_offset((int *) &index)] ==
								p_st_r1->tensor.cell_int[p_st_r1->get_offset((int *) &index_o)]);

						i_i++;
					}
				}

				i_i = 0, i_b = 0;
				for (int i_o = 0; i_o < 17; i_o++) {
					index_o[0] = i_o;
					if (p_bf_r3->tensor.cell_bool[i_o]) {
						index[0] = i_b;

						for (int j = 0; j < 9; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 3; k++) {
								index[2] = index_o[2] = k;

								REQUIRE(p_pb_by_r3->tensor.cell_byte[p_pb_by_r3->get_offset((int *) &index)] == 7*i_o + 5*j + 3*k);
							}
						}

						i_b++;
					}
					if (i_i < p_if_r3->range.filter.length && p_if_r3->tensor.cell_int[i_i] == i_o) {
						index[0] = i_i;

						for (int j = 0; j < 9; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 3; k++) {
								index[2] = index_o[2] = k;

								REQUIRE(!strcmp(p_pb_st_r3->get_string((int *) &index), month[(7*i_o + 5*j + 3*k) % 12]));
								REQUIRE(p_pb_st_r3->tensor.cell_int[p_pb_st_r3->get_offset((int *) &index)] ==
										p_st_r3->tensor.cell_int[p_st_r3->get_offset((int *) &index_o)]);
							}
						}

						i_i++;
					}
				}

				i_i = 0, i_b = 0;
				for (int i_o = 0; i_o < 2; i_o++) {
					index_o[0] = i_o;
					if (p_bf_r6->tensor.cell_bool[i_o]) {
						index[0] = i_b;

						for (int j = 0; j < 3; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 2; k++) {
								index[2] = index_o[2] = k;
								for (int u = 0; u < 5; u++) {
									index[3] = index_o[3] = u;
									for (int v = 0; v < 2; v++) {
										index[4] = index_o[4] = v;
										for (int w = 0; w < 7; w++) {
											index[5] = index_o[5] = w;

											REQUIRE(p_pb_by_r6->tensor.cell_byte[p_pb_by_r6->get_offset((int *) &index)] ==
													45*i_o + 34*j + 23*k + 12*u + 6*v + 3*w);
										}
									}
								}
							}
						}

						i_b++;
					}
					if (i_i < p_if_r6->range.filter.length && p_if_r6->tensor.cell_int[i_i] == i_o) {
						index[0] = i_i;

						for (int j = 0; j < 3; j++) {
							index[1] = index_o[1] = j;
							for (int k = 0; k < 2; k++) {
								index[2] = index_o[2] = k;
								for (int u = 0; u < 5; u++) {
									index[3] = index_o[3] = u;
									for (int v = 0; v < 2; v++) {
										index[4] = index_o[4] = v;
										for (int w = 0; w < 7; w++) {
											index[5] = index_o[5] = w;

											REQUIRE(!strcmp(p_pb_st_r6->get_string((int *) &index),
															month[(45*i_o + 34*j + 23*k + 12*u + 6*v + 3*w) % 12]));
											REQUIRE(p_pb_st_r6->tensor.cell_int[p_pb_st_r6->get_offset((int *) &index)] ==
													p_st_r6->tensor.cell_int[p_st_r6->get_offset((int *) &index_o)]);
										}
									}
								}
							}
						}
						i_i++;
					}
				}
			}

			free_jazz_block(p_pa_db_r1);
			REQUIRE(p_pa_db_r1 == nullptr);

			free_jazz_block(p_pa_db_r3);
			REQUIRE(p_pa_db_r3 == nullptr);

			free_jazz_block(p_pa_db_r6);
			REQUIRE(p_pa_db_r6 == nullptr);

			free_jazz_block(p_pa_st_r1);
			REQUIRE(p_pa_st_r1 == nullptr);

			free_jazz_block(p_pa_st_r3);
			REQUIRE(p_pa_st_r3 == nullptr);

			free_jazz_block(p_pa_st_r6);
			REQUIRE(p_pa_st_r6 == nullptr);

			free_jazz_block(p_pa_by_r1);
			REQUIRE(p_pa_by_r1 == nullptr);

			free_jazz_block(p_pa_by_r3);
			REQUIRE(p_pa_by_r3 == nullptr);

			free_jazz_block(p_pa_by_r6);
			REQUIRE(p_pa_by_r6 == nullptr);

			free_jazz_block(p_pb_db_r1);
			REQUIRE(p_pb_db_r1 == nullptr);

			free_jazz_block(p_pb_db_r3);
			REQUIRE(p_pb_db_r3 == nullptr);

			free_jazz_block(p_pb_db_r6);
			REQUIRE(p_pb_db_r6 == nullptr);

			free_jazz_block(p_pb_st_r1);
			REQUIRE(p_pb_st_r1 == nullptr);

			free_jazz_block(p_pb_st_r3);
			REQUIRE(p_pb_st_r3 == nullptr);

			free_jazz_block(p_pb_st_r6);
			REQUIRE(p_pb_st_r6 == nullptr);

			free_jazz_block(p_pb_by_r1);
			REQUIRE(p_pb_by_r1 == nullptr);

			free_jazz_block(p_pb_by_r3);
			REQUIRE(p_pb_by_r3 == nullptr);

			free_jazz_block(p_pb_by_r6);
			REQUIRE(p_pb_by_r6 == nullptr);
		}

		free_jazz_block((pJazzBlock &) p_if_r1);
		REQUIRE(p_if_r1 == nullptr);

		free_jazz_block((pJazzBlock &) p_if_r3);
		REQUIRE(p_if_r3 == nullptr);

		free_jazz_block((pJazzBlock &) p_if_r6);
		REQUIRE(p_if_r6 == nullptr);

		free_jazz_block((pJazzBlock &) p_bf_r1);
		REQUIRE(p_bf_r1 == nullptr);

		free_jazz_block((pJazzBlock &) p_bf_r3);
		REQUIRE(p_bf_r3 == nullptr);

		free_jazz_block((pJazzBlock &) p_bf_r6);
		REQUIRE(p_bf_r6 == nullptr);

		free_jazz_block(p_db_r1);
		REQUIRE(p_db_r1 == nullptr);

		free_jazz_block(p_db_r3);
		REQUIRE(p_db_r3 == nullptr);

		free_jazz_block(p_db_r6);
		REQUIRE(p_db_r6 == nullptr);

		free_jazz_block(p_st_r1);
		REQUIRE(p_st_r1 == nullptr);

		free_jazz_block(p_st_r3);
		REQUIRE(p_st_r3 == nullptr);

		free_jazz_block(p_st_r6);
		REQUIRE(p_st_r6 == nullptr);

		free_jazz_block(p_by_r1);
		REQUIRE(p_by_r1 == nullptr);

		free_jazz_block(p_by_r3);
		REQUIRE(p_by_r3 == nullptr);

		free_jazz_block(p_by_r6);
		REQUIRE(p_by_r6 == nullptr);
	}
}


SCENARIO("Force all error conditions") {
#ifdef LOG_ERRORS
	const char *log_file   {"/tmp/jazz_test_containers.log"};
	struct stat stat_struc {0};

	if (stat(log_file, &stat_struc) == 0)
		remove(log_file);

	jazz_utils::JazzLogger jll(log_file);

	JazzBlockKeepr jbk(&jll);
	JazzTree	   jbt(&jll);
	AATBlockQueue  aaq(&jll);
	JazzCache	   jca(&jll);

	jbk.log(LOG_INFO, "Hello JazzBlockKeepr!");
	jbt.log(LOG_INFO, "Hello JazzTree!");
	aaq.log(LOG_INFO, "Hello AATBlockQueue!");
	jca.log(LOG_INFO, "Hello JazzCache!");
#else
	JazzBlockKeepr jbk(nullptr);
	JazzTree	   jbt(nullptr);
	AATBlockQueue  aaq(nullptr);
	JazzCache	   jca(nullptr);
#endif

	JazzTensorDim dim {{5, 2, 0}};

	pJazzBlock p_block = new_jazz_block(CELL_TYPE_INTEGER, dim.dim);

	REQUIRE(p_block != nullptr);

	JazzBlockIdentifier block_id;
	sprintf(block_id.key, "What???");

	REQUIRE(jca.find_jazz_block(12345) == nullptr);
	REQUIRE(jca.find_jazz_block(&block_id) == nullptr);

	jbk.destroy_keeprs();
	jbt.destroy_keeprs();
	aaq.destroy_keeprs();
	jca.destroy_keeprs();

	REQUIRE(jbk.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(jbt.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(aaq.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(jca.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) == nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);

	REQUIRE(jbk.new_jazz_block(123, p_block) == nullptr);
	REQUIRE(jbt.new_jazz_block(123, p_block) == nullptr);
	REQUIRE(aaq.new_jazz_block(123, p_block) == nullptr);
	REQUIRE(jca.new_jazz_block(123, p_block) == nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, p_block) == nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, p_block) == nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, p_block) == nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, p_block) == nullptr);

	block_id.key[0] = 0;
	REQUIRE(jca.find_jazz_block(&block_id) == nullptr);
	REQUIRE(!jca.free_jazz_block(&block_id));
	REQUIRE(!jca.free_jazz_block(54321));

	REQUIRE(jbk.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) == nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, p_block) == nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, p_block) == nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, p_block) == nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, p_block) == nullptr);

	REQUIRE(jbk.alloc_keeprs(10));
	REQUIRE(jbt.alloc_keeprs(10));
	REQUIRE(aaq.alloc_keeprs(10));
	REQUIRE(jca.alloc_keeprs(10));

	sprintf(block_id.key, "._block_");
	REQUIRE(!jca.free_jazz_block(&block_id));

	REQUIRE(jbk.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) != nullptr);
	REQUIRE(jbt.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) != nullptr);
	REQUIRE(aaq.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) != nullptr);
	REQUIRE(jca.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim) != nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) != nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) != nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) != nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, CELL_TYPE_INTEGER, dim.dim) != nullptr);

	REQUIRE(jbk.new_jazz_block(123, p_block) != nullptr);
	REQUIRE(jbt.new_jazz_block(123, p_block) != nullptr);
	REQUIRE(aaq.new_jazz_block(123, p_block) != nullptr);
	REQUIRE(jca.new_jazz_block(123, p_block) != nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, p_block) != nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, p_block) != nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, p_block) != nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, p_block) != nullptr);

	REQUIRE(jbk.new_jazz_block(123, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);
	REQUIRE(jbt.new_jazz_block(123, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);
	REQUIRE(aaq.new_jazz_block(123, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);
	REQUIRE(jca.new_jazz_block(123, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, CELL_TYPE_DOUBLE + 1, dim.dim) == nullptr);

	REQUIRE(jbk.new_jazz_block(123, p_block, (pJazzFilter) p_block) == nullptr);
	REQUIRE(jbt.new_jazz_block(123, p_block, (pJazzFilter) p_block) == nullptr);
	REQUIRE(aaq.new_jazz_block(123, p_block, (pJazzFilter) p_block) == nullptr);
	REQUIRE(jca.new_jazz_block(123, p_block, (pJazzFilter) p_block) == nullptr);

	REQUIRE(jbk.new_jazz_block(&block_id, p_block, (pJazzFilter) p_block) == nullptr);
	REQUIRE(jbt.new_jazz_block(&block_id, p_block, (pJazzFilter) p_block) == nullptr);
	REQUIRE(aaq.new_jazz_block(&block_id, p_block, (pJazzFilter) p_block) == nullptr);
	REQUIRE(jca.new_jazz_block(&block_id, p_block, (pJazzFilter) p_block) == nullptr);

	jbk.destroy_keeprs();
	jbt.destroy_keeprs();
	aaq.destroy_keeprs();
	jca.destroy_keeprs();

	REQUIRE(jbk.alloc_keeprs(10));
	REQUIRE(jbt.alloc_keeprs(10));
	REQUIRE(aaq.alloc_keeprs(10));
	REQUIRE(jca.alloc_keeprs(10));

	pJazzBlockKeeprItem p_item;
	pJazzQueueItem p_queue_item;

	p_item = jbk.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim);
	jbk.free_jazz_block(p_item);
	jbk.free_jazz_block(p_item);
	jbt.free_jazz_block(p_item);
	aaq.free_jazz_block((pJazzQueueItem) p_item);
	jca.free_jazz_block((pJazzQueueItem) p_item);
	jbk.free_jazz_block((pJazzBlockKeeprItem) nullptr);

	p_item = jbt.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim);
	jbt.free_jazz_block(p_item);
	jbt.free_jazz_block(p_item);
	jbk.free_jazz_block(p_item);
	aaq.free_jazz_block((pJazzQueueItem) p_item);
	jca.free_jazz_block((pJazzQueueItem) p_item);
	jbt.free_jazz_block((pJazzBlockKeeprItem) nullptr);

	p_queue_item = aaq.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim);
	aaq.free_jazz_block(p_queue_item);
	aaq.free_jazz_block(p_queue_item);
	jca.free_jazz_block(p_queue_item);
	jbk.free_jazz_block((pJazzBlockKeeprItem) p_queue_item);
	jbt.free_jazz_block((pJazzBlockKeeprItem) p_queue_item);
	aaq.free_jazz_block((pJazzQueueItem) nullptr);

	p_queue_item = jca.new_jazz_block(123, CELL_TYPE_INTEGER, dim.dim);
	jca.free_jazz_block(p_queue_item);
	jca.free_jazz_block(p_queue_item);
	aaq.free_jazz_block(p_queue_item);
	jbk.free_jazz_block((pJazzBlockKeeprItem) p_queue_item);
	jbt.free_jazz_block((pJazzBlockKeeprItem) p_queue_item);
	jca.free_jazz_block((pJazzQueueItem) nullptr);

	free_jazz_block(p_block);
*/
	}
}
